{{!-- Employee Payroll Queries --}}
<div class="container-fluid">
	<div class="row">
		{{> employee-sidebar employee=employee active='payroll_queries'}}

		<!-- Main Content -->
		<div class="col-md-10 emp-main">
			<div class="emp-page-header">
				<div class="d-flex align-items-center justify-content-between">
					<div>
						<h1 class="emp-page-title">Payroll Queries</h1>
						<p class="text-muted mt-1">Raise and track your payroll-related queries</p>
					</div>
					<button class="btn btn-primary" onclick="openNewQueryModal()">
						<i class="fa-solid fa-plus me-2"></i>Raise New Query
					</button>
				</div>
			</div>

			<!-- Queries List -->
			{{#if queries.length}}
				<div class="row g-3">
					{{#each queries}}
					<div class="col-12">
						<div class="emp-card">
							<div class="emp-card-header d-flex justify-content-between align-items-start">
								<div>
									<h6 class="emp-card-title mb-1">{{this.subject}}</h6>
									<small class="text-muted">Query ID: {{this.id}} • Raised on {{this.createdAt}}</small>
								</div>
								{{#if (eq this.status 'OPEN')}}
									<span class="badge bg-danger">Open</span>
								{{else if (eq this.status 'IN_PROGRESS')}}
									<span class="badge bg-warning">In Progress</span>
								{{else if (eq this.status 'RESOLVED')}}
									<span class="badge bg-success">Resolved</span>
								{{else}}
									<span class="badge bg-secondary">Closed</span>
								{{/if}}
							</div>

							<div class="emp-card-body">
								<div class="row g-2 mb-3">
									<div class="col-auto">
										<span class="badge bg-light text-dark">{{this.category}}</span>
									</div>
									<div class="col-auto">
										<small class="text-muted">Last updated: {{this.lastUpdated}}</small>
									</div>
								</div>

								<p class="mb-3">{{this.description}}</p>

								{{#if this.resolution}}
									<div style="padding: 12px; background: #f0fdf4; border-left: 3px solid var(--emp-success); border-radius: 4px; margin-bottom: 12px;">
										<small class="text-muted d-block mb-1"><strong>Resolution:</strong></small>
										<small>{{this.resolution}}</small>
									</div>
								{{/if}}

								<button class="btn btn-sm btn-outline-primary" onclick="viewQueryDetails({{this.id}})">
									<i class="fa-solid fa-comments me-1"></i>View Conversation
								</button>
							</div>
						</div>
					</div>
					{{/each}}
				</div>
			{{else}}
				<div class="emp-card">
					<div class="emp-card-body text-center py-5">
						<i class="fa-solid fa-inbox" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 15px;"></i>
						<h6>No Queries Yet</h6>
						<p class="text-muted mb-3">You haven't raised any payroll queries yet</p>
						<button class="btn btn-primary" onclick="openNewQueryModal()">
							<i class="fa-solid fa-plus me-2"></i>Raise First Query
						</button>
					</div>
				</div>
			{{/if}}
		</div>
	</div>
</div>

<!-- New Query Modal -->
<div class="modal fade" id="newQueryModal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Raise New Payroll Query</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<form>
					<div class="mb-3">
						<label class="form-label fw-600">Category</label>
						<select class="form-select" required>
							<option selected value="">Select category...</option>
							<option value="MISMATCH">Salary Mismatch</option>
							<option value="TAX">Tax Related</option>
							<option value="REIMBURSEMENT">Reimbursement</option>
							<option value="BONUS">Bonus/Allowance</option>
							<option value="DEDUCTION">Incorrect Deduction</option>
							<option value="OTHER">Other</option>
						</select>
					</div>

					<div class="mb-3">
						<label class="form-label fw-600">Period (If Applicable)</label>
						<input type="month" class="form-control">
					</div>

					<div class="mb-3">
						<label class="form-label fw-600">Subject</label>
						<input type="text" class="form-control" placeholder="Brief subject of your query" required>
					</div>

					<div class="mb-3">
						<label class="form-label fw-600">Description</label>
						<textarea class="form-control" rows="4" placeholder="Please describe your query in detail..." required></textarea>
					</div>

					<div class="mb-3">
						<label class="form-label fw-600">Attach Supporting Document</label>
						<div class="input-group">
							<input type="file" class="form-control" id="attachmentInput" accept=".pdf,.jpg,.png,.doc,.docx">
							<button class="btn btn-outline-secondary" type="button" disabled>
								<i class="fa-solid fa-upload me-1"></i>Upload
							</button>
						</div>
						<small class="text-muted d-block mt-1">Max file size: 5MB (PDF, Image, Word)</small>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-primary" onclick="submitQuery()">Submit Query</button>
			</div>
		</div>
	</div>
</div>

<!-- View Query Details Modal -->
<div class="modal fade" id="viewQueryModal" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="queryTitle">Query Details</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<!-- Conversation Thread -->
				<div id="conversationThread" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;"></div>

				<hr>

				<!-- Reply Box -->
				<div>
					<label class="form-label fw-600">Add Comment</label>
					<textarea class="form-control mb-2" rows="3" placeholder="Type your message..."></textarea>
					<button class="btn btn-sm btn-primary" onclick="addComment()">
						<i class="fa-solid fa-paper-plane me-1"></i>Send
					</button>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
function openNewQueryModal() {
	new bootstrap.Modal(document.getElementById('newQueryModal')).show();
}

function submitQuery() {
	showToast('Query submitted successfully! Our team will respond within 24 hours.', 'success');
	new bootstrap.Modal(document.getElementById('newQueryModal')).hide();
}

function viewQueryDetails(id) {
	// Sample conversation
	const conversation = `
		<div class="mb-3">
			<div style="background: #f0f7ff; padding: 12px; border-radius: 6px; border-left: 3px solid var(--emp-primary);">
				<div style="font-weight: 600; font-size: 13px; color: var(--emp-primary); margin-bottom: 4px;">You</div>
				<small>Hi, I received my December payslip but the monthly bonus of ₹5000 is not showing. Can you check?</small>
				<div style="font-size: 11px; color: #999; margin-top: 6px;">Dec 28, 2025 at 10:30 AM</div>
			</div>
		</div>

		<div class="mb-3">
			<div style="background: #f0fdf4; padding: 12px; border-radius: 6px; border-left: 3px solid var(--emp-success);">
				<div style="font-weight: 600; font-size: 13px; color: var(--emp-success); margin-bottom: 4px;">HR Support</div>
				<small>Thank you for reaching out! I've checked your records and confirmed that the bonus was processed but will appear in your January 2026 payslip due to processing timing. It will be included in the next pay cycle.</small>
				<div style="font-size: 11px; color: #999; margin-top: 6px;">Dec 29, 2025 at 2:15 PM</div>
			</div>
		</div>

		<div class="mb-3">
			<div style="background: #f0f7ff; padding: 12px; border-radius: 6px; border-left: 3px solid var(--emp-primary);">
				<div style="font-weight: 600; font-size: 13px; color: var(--emp-primary); margin-bottom: 4px;">You</div>
				<small>Thank you for the clarification! That makes sense. Appreciate your help.</small>
				<div style="font-size: 11px; color: #999; margin-top: 6px;">Dec 29, 2025 at 3:45 PM</div>
			</div>
		</div>
	`;

	document.getElementById('conversationThread').innerHTML = conversation;
	document.getElementById('queryTitle').textContent = 'Salary Mismatch Query - #' + id;
	new bootstrap.Modal(document.getElementById('viewQueryModal')).show();
}

function addComment() {
	showToast('Comment added successfully!', 'success');
}

function showToast(message, type = 'info') {
	const alertDiv = document.createElement('div');
	alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
	alertDiv.style.top = '20px';
	alertDiv.style.right = '20px';
	alertDiv.style.zIndex = '9999';
	alertDiv.style.width = '300px';
	alertDiv.setAttribute('role', 'alert');
	alertDiv.innerHTML = `
		${message}
		<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
	`;
	document.body.appendChild(alertDiv);
	setTimeout(() => alertDiv.remove(), 4000);
}
</script>
