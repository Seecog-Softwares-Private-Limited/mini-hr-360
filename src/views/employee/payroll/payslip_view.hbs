{{!-- Employee Payslip View --}}
<div class="container-fluid">
	<div class="row">
		{{> employee-sidebar employee=employee active='payroll_payslips'}}

		<!-- Main Content -->
		<div class="col-md-10 emp-main">
			<div id="payslipContent">
				<!-- Loading State -->
				<div class="emp-card" id="loadingState">
					<div class="emp-card-body text-center py-5">
						<div class="spinner-border text-primary mb-3" role="status">
							<span class="visually-hidden">Loading...</span>
						</div>
						<p class="text-muted mb-0">Loading payslip details...</p>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<style>
.emp-btn-secondary {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding: 10px 16px;
	background: white;
	color: var(--emp-primary);
	border: 1px solid var(--emp-primary);
	border-radius: 6px;
	font-weight: 600;
	text-decoration: none;
	transition: all 150ms ease;
	font-size: 14px;
}

.emp-btn-secondary:hover {
	background: var(--emp-primary);
	color: white;
	text-decoration: none;
}

.emp-btn-secondary:disabled {
	opacity: 0.5;
	cursor: not-allowed;
}

.payslip-container {
	background: white;
	border-radius: 12px;
	box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
	overflow: hidden;
}

.payslip-header {
	background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
	color: white;
	padding: 30px 40px;
	text-align: center;
}

.payslip-body {
	padding: 30px 40px;
}

.info-grid {
	display: grid;
	grid-template-columns: repeat(4, 1fr);
	gap: 20px;
	margin-bottom: 30px;
}

.info-item label {
	color: #94a3b8;
	font-size: 11px;
	text-transform: uppercase;
	font-weight: 600;
	letter-spacing: 0.5px;
	display: block;
	margin-bottom: 4px;
}

.info-item .value {
	color: #1e293b;
	font-weight: 600;
	font-size: 14px;
}

.section-title {
	font-weight: 700;
	font-size: 13px;
	color: #475569;
	text-transform: uppercase;
	letter-spacing: 0.5px;
	margin-bottom: 15px;
	padding-bottom: 10px;
	border-bottom: 2px solid #e2e8f0;
}

.section-title.earnings {
	color: #16a34a;
	border-color: #86efac;
}

.section-title.deductions {
	color: #dc2626;
	border-color: #fecaca;
}

.component-row {
	display: flex;
	justify-content: space-between;
	padding: 10px 0;
	border-bottom: 1px solid #f1f5f9;
	font-size: 14px;
}

.component-row:last-child {
	border-bottom: none;
}

.component-row .name {
	color: #475569;
}

.component-row .amount {
	font-weight: 600;
	color: #1e293b;
}

.total-row {
	display: flex;
	justify-content: space-between;
	padding: 12px 16px;
	background: #f8fafc;
	border-radius: 6px;
	margin-top: 10px;
	font-weight: 700;
}

.netpay-box {
	background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
	color: white;
	padding: 30px;
	border-radius: 12px;
	text-align: center;
	margin: 30px 0;
}

.netpay-box .label {
	font-size: 12px;
	text-transform: uppercase;
	letter-spacing: 1px;
	opacity: 0.9;
	margin-bottom: 8px;
}

.netpay-box .amount {
	font-size: 36px;
	font-weight: 700;
}

@media (max-width: 768px) {
	.info-grid {
		grid-template-columns: repeat(2, 1fr);
	}
	.payslip-body {
		padding: 20px;
	}
}
</style>

<script>
const payslipId = '{{payslipId}}';

document.addEventListener('DOMContentLoaded', function() {
	if (payslipId) {
		loadPayslip(payslipId);
	} else {
		showError('Payslip ID not found');
	}
});

async function loadPayslip(id) {
	try {
		const response = await fetch(`/employee/payroll/api/payslips/${id}`);
		const data = await response.json();
		
		if (data.success && data.payslip) {
			renderPayslip(data.payslip);
		} else {
			showError(data.message || 'Payslip not found');
		}
	} catch (error) {
		console.error('Error loading payslip:', error);
		showError('Error connecting to server');
	}
}

function renderPayslip(payslip) {
	const container = document.getElementById('payslipContent');
	
	// Build earnings rows
	let earningsHtml = '';
	let totalEarningsRaw = 0;
	if (payslip.earnings && payslip.earnings.length > 0) {
		payslip.earnings.forEach(e => {
			earningsHtml += `
				<div class="component-row">
					<span class="name">${e.name}</span>
					<span class="amount" style="color: #16a34a;">₹${e.amount}</span>
				</div>
			`;
		});
	} else {
		earningsHtml = '<div class="text-muted text-center py-3">No earnings data</div>';
	}
	
	// Build deductions rows
	let deductionsHtml = '';
	if (payslip.deductions && payslip.deductions.length > 0) {
		payslip.deductions.forEach(d => {
			deductionsHtml += `
				<div class="component-row">
					<span class="name">${d.name}</span>
					<span class="amount" style="color: #dc2626;">₹${d.amount}</span>
				</div>
			`;
		});
	} else {
		deductionsHtml = '<div class="text-muted text-center py-3">No deductions</div>';
	}
	
	container.innerHTML = `
		<!-- Page Header -->
		<div class="emp-page-header">
			<div class="d-flex align-items-center justify-content-between">
				<div>
					<h1 class="emp-page-title">Payslip - ${payslip.period}</h1>
					<p class="text-muted mt-1">Pay Date: ${payslip.payDate}</p>
				</div>
				<div class="d-flex gap-2">
					${payslip.pdfUrl ? `
						<a href="/${payslip.pdfUrl}" class="emp-btn-secondary" target="_blank">
							<i class="fa-solid fa-download me-2"></i>Download PDF
						</a>
					` : `
						<button class="emp-btn-secondary" disabled title="PDF Not Available">
							<i class="fa-solid fa-download me-2"></i>Download
						</button>
					`}
					<a href="/employee/payroll/queries" class="emp-btn-secondary">
						<i class="fa-solid fa-comment-dots me-2"></i>Raise Query
					</a>
				</div>
			</div>
		</div>

		<!-- Payslip Container -->
		<div class="payslip-container">
			<!-- Header -->
			<div class="payslip-header">
				<h4 class="mb-1">SALARY SLIP</h4>
				<p class="mb-0" style="opacity: 0.9;">${payslip.period}</p>
			</div>
			
			<!-- Body -->
			<div class="payslip-body">
				<!-- Employee Info -->
				<div class="info-grid">
					<div class="info-item">
						<label>Employee Name</label>
						<div class="value">${payslip.employee?.name || '-'}</div>
					</div>
					<div class="info-item">
						<label>Employee ID</label>
						<div class="value">${payslip.employee?.employeeId || '-'}</div>
					</div>
					<div class="info-item">
						<label>Designation</label>
						<div class="value">${payslip.employee?.designation || '-'}</div>
					</div>
					<div class="info-item">
						<label>Department</label>
						<div class="value">${payslip.employee?.department || '-'}</div>
					</div>
				</div>
				
				<div class="row">
					<!-- Earnings -->
					<div class="col-md-6 mb-4">
						<div class="section-title earnings">
							<i class="fa-solid fa-arrow-up me-2"></i>Earnings
						</div>
						${earningsHtml}
						<div class="total-row" style="background: #dcfce7;">
							<span>Total Earnings</span>
							<span style="color: #16a34a;">₹${payslip.totalEarnings}</span>
						</div>
					</div>
					
					<!-- Deductions -->
					<div class="col-md-6 mb-4">
						<div class="section-title deductions">
							<i class="fa-solid fa-arrow-down me-2"></i>Deductions
						</div>
						${deductionsHtml}
						<div class="total-row" style="background: #fee2e2;">
							<span>Total Deductions</span>
							<span style="color: #dc2626;">₹${payslip.totalDeductions}</span>
						</div>
					</div>
				</div>
				
				<!-- Net Pay -->
				<div class="netpay-box">
					<div class="label">Net Pay</div>
					<div class="amount">₹${payslip.netPay}</div>
				</div>
				
				<!-- Footer -->
				<div class="text-center text-muted" style="font-size: 12px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
					<i class="fa-solid fa-info-circle me-1"></i>
					This is a system-generated payslip. For queries or discrepancies, please contact HR department.
				</div>
			</div>
		</div>

		<!-- Action Buttons -->
		<div class="d-flex gap-2 mt-4 justify-content-between">
			<div>
				<a href="/employee/payroll/payslips" class="emp-btn-secondary">
					<i class="fa-solid fa-arrow-left me-2"></i>Back to Payslips
				</a>
			</div>
			<div class="d-flex gap-2">
				${payslip.pdfUrl ? `
					<a href="/${payslip.pdfUrl}" class="btn btn-outline-primary" target="_blank">
						<i class="fa-solid fa-download me-2"></i>Download PDF
					</a>
				` : ''}
				<a href="/employee/payroll/queries" class="btn btn-primary">
					<i class="fa-solid fa-comment-dots me-2"></i>Raise Query
				</a>
			</div>
		</div>
	`;
}

function showError(message) {
	const container = document.getElementById('payslipContent');
	container.innerHTML = `
		<div class="emp-page-header">
			<h1 class="emp-page-title">Payslip</h1>
		</div>
		<div class="emp-card">
			<div class="emp-card-body text-center py-5">
				<i class="fa-solid fa-exclamation-triangle text-warning" style="font-size: 48px; display: block; margin-bottom: 15px;"></i>
				<h6>Error Loading Payslip</h6>
				<p class="text-muted mb-3">${message}</p>
				<a href="/employee/payroll/payslips" class="btn btn-primary btn-sm">
					<i class="fa-solid fa-arrow-left me-1"></i>Back to Payslips
				</a>
			</div>
		</div>
	`;
}
</script>
