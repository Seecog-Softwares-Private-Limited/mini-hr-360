<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        {{> employee-sidebar employee=employee active='apply-leave'}}

        <!-- Main Content -->
        <div class="col-md-10 emp-main">
            <div class="emp-page-header">
                <h1 class="emp-page-title">Apply Leave</h1>
                <p class="text-muted mt-1">Submit a new leave request</p>
            </div>

            <div class="row">
                <!-- Application Form -->
                <div class="col-lg-8">
                    <div class="emp-card">
                        <div class="emp-card-header">
                            <h5 class="emp-card-title">
                                <i class="fa-solid fa-file-lines" style="color: var(--emp-primary);"></i>
                                Leave Application
                            </h5>
                        </div>
                        <div class="emp-card-body">
                            <div id="alertContainer"></div>

                            <form id="leaveForm">
                                <!-- Leave Type -->
                                <div class="mb-4">
                                    <label for="leaveTypeId" class="emp-form-label">
                                        <i class="fa-solid fa-tag me-1"></i> Leave Type <span
                                            class="text-danger">*</span>
                                    </label>
                                    <select class="form-select emp-form-control" id="leaveTypeId" name="leaveTypeId"
                                        required>
                                        <option value="">Select Leave Type</option>
                                        {{#each leaveTypes}}
                                        <option value="{{this.id}}" data-allow-half-day="{{this.allowHalfDay}}"
                                            data-requires-attachment="{{this.requiresAttachment}}"
                                            data-min-notice="{{this.minDaysNotice}}" data-color="{{this.color}}">
                                            {{this.name}}{{#unless this.isPaid}} (Unpaid){{/unless}}
                                        </option>
                                        {{/each}}
                                    </select>
                                </div>

                                <!-- Date Range -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label for="startDate" class="emp-form-label">
                                            <i class="fa-solid fa-calendar me-1"></i> From Date <span
                                                class="text-danger">*</span>
                                        </label>
                                        <input type="date" class="form-control emp-form-control" id="startDate"
                                            name="startDate" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="endDate" class="emp-form-label">
                                            <i class="fa-solid fa-calendar me-1"></i> To Date <span
                                                class="text-danger">*</span>
                                        </label>
                                        <input type="date" class="form-control emp-form-control" id="endDate"
                                            name="endDate" required>
                                    </div>
                                </div>

                                <!-- Half Day Options -->
                                <div class="mb-4" id="halfDaySection" style="display: none;">
                                    <label class="emp-form-label">
                                        <i class="fa-solid fa-clock-rotate-left me-1"></i> Half Day Options
                                    </label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="isHalfDayStart"
                                                    name="isHalfDayStart">
                                                <label class="form-check-label" for="isHalfDayStart">
                                                    First day is half day
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="isHalfDayEnd"
                                                    name="isHalfDayEnd">
                                                <label class="form-check-label" for="isHalfDayEnd">
                                                    Last day is half day
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-2" id="halfDaySessionSection" style="display: none;">
                                        <select class="form-select emp-form-control" id="halfDaySession"
                                            name="halfDaySession">
                                            <option value="">Select Session</option>
                                            <option value="FIRST_HALF">First Half (Morning)</option>
                                            <option value="SECOND_HALF">Second Half (Afternoon)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Leave Days Summary -->
                                <div class="mb-4 p-3 rounded"
                                    style="background: rgba(14, 165, 233, 0.08); border: 1px solid rgba(14, 165, 233, 0.2);">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span style="font-weight: 600; color: #0f172a;">
                                            <i class="fa-solid fa-calculator me-2"
                                                style="color: var(--emp-primary);"></i>
                                            Total Leave Days:
                                        </span>
                                        <span id="totalDays"
                                            style="font-size: 1.5rem; font-weight: 800; color: var(--emp-primary);">0</span>
                                    </div>
                                </div>

                                <!-- Reason -->
                                <div class="mb-4">
                                    <label for="reason" class="emp-form-label">
                                        <i class="fa-solid fa-comment me-1"></i> Reason <span
                                            class="text-danger">*</span>
                                    </label>
                                    <textarea class="form-control emp-form-control" id="reason" name="reason" rows="3"
                                        placeholder="Please provide a reason for your leave request..."
                                        required></textarea>
                                </div>

                                <!-- Attachment (Optional unless leave type requires it) -->
                                <div class="mb-4" id="attachmentSection">
                                    <label for="attachment" class="emp-form-label">
                                        <i class="fa-solid fa-paperclip me-1"></i> Attachment
                                        <span id="attachmentRequired" class="text-danger"
                                            style="display: none;">*</span>
                                        <span id="attachmentOptional" class="text-muted">(Optional)</span>
                                    </label>
                                    <input type="file" class="form-control emp-form-control" id="attachmentFile"
                                        name="attachmentFile" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                                    <small class="text-muted">Accepted formats: PDF, JPG, PNG, DOC (Max 5MB)</small>
                                </div>

                                <!-- Submit Buttons -->
                                <div class="d-flex gap-3">
                                    <button type="submit" class="btn emp-btn-primary" id="submitBtn">
                                        <span id="submitText">
                                            <i class="fa-solid fa-paper-plane me-2"></i> Submit Application
                                        </span>
                                        <span id="loadingText" class="d-none">
                                            <span class="spinner-border spinner-border-sm me-2"></span> Submitting...
                                        </span>
                                    </button>
                                    <a href="/employee/leaves" class="btn emp-btn-secondary">
                                        <i class="fa-solid fa-times me-2"></i> Cancel
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Leave Balances Sidebar -->
                <div class="col-lg-4">
                    <div class="emp-card">
                        <div class="emp-card-header">
                            <h5 class="emp-card-title">
                                <i class="fa-solid fa-wallet" style="color: var(--emp-primary);"></i>
                                Available Balance
                            </h5>
                        </div>
                        <div class="emp-card-body">
                            {{#each balances}}
                            <div
                                class="d-flex justify-content-between align-items-center mb-3 pb-3 {{#unless @last}}border-bottom{{/unless}}">
                                <div>
                                    <div style="font-weight: 600; color: {{this.color}};">{{this.leaveTypeName}}</div>
                                    <small class="text-muted">Used: {{this.used}} / {{this.allocated}}</small>
                                </div>
                                <div style="font-size: 1.25rem; font-weight: 800; color: {{this.color}};">
                                    {{this.available}}
                                </div>
                            </div>
                            {{/each}}
                        </div>
                    </div>

                    <div class="emp-card mt-4">
                        <div class="emp-card-header">
                            <h5 class="emp-card-title">
                                <i class="fa-solid fa-lightbulb" style="color: #f59e0b;"></i>
                                Tips
                            </h5>
                        </div>
                        <div class="emp-card-body">
                            <ul class="mb-0" style="padding-left: 1.2rem; color: #64748b; font-size: 13px;">
                                <li class="mb-2">Apply for leaves in advance when possible</li>
                                <li class="mb-2">Provide a clear reason for better approval chances</li>
                                <li class="mb-2">Attach supporting documents if required</li>
                                <li class="mb-2">Check your balance before applying</li>
                                <li>You can cancel pending requests from My Leaves</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('leaveForm');
        const leaveTypeSelect = document.getElementById('leaveTypeId');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const halfDaySection = document.getElementById('halfDaySection');
        const halfDaySessionSection = document.getElementById('halfDaySessionSection');
        const attachmentSection = document.getElementById('attachmentSection');
        const attachmentRequired = document.getElementById('attachmentRequired');
        const isHalfDayStart = document.getElementById('isHalfDayStart');
        const isHalfDayEnd = document.getElementById('isHalfDayEnd');
        const totalDaysDisplay = document.getElementById('totalDays');

        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        startDateInput.min = today;
        endDateInput.min = today;

        const attachmentFileInput = document.getElementById('attachmentFile');
        const attachmentOptionalLabel = document.getElementById('attachmentOptional');

        // Update form based on leave type selection
        leaveTypeSelect.addEventListener('change', function () {
            const selected = this.options[this.selectedIndex];
            const allowHalfDay = selected.dataset.allowHalfDay === 'true';
            const requiresAttachment = selected.dataset.requiresAttachment === 'true';

            halfDaySection.style.display = allowHalfDay ? 'block' : 'none';

            // Update attachment field - always visible but only required for certain leave types (like Sick Leave)
            if (requiresAttachment) {
                attachmentRequired.style.display = 'inline';
                attachmentOptionalLabel.style.display = 'none';
                attachmentFileInput.required = true;
            } else {
                attachmentRequired.style.display = 'none';
                attachmentOptionalLabel.style.display = 'inline';
                attachmentFileInput.required = false;
            }

            calculateDays();
        });

        // Update end date min when start date changes
        startDateInput.addEventListener('change', function () {
            endDateInput.min = this.value;
            if (endDateInput.value && endDateInput.value < this.value) {
                endDateInput.value = this.value;
            }
            calculateDays();
        });

        endDateInput.addEventListener('change', calculateDays);
        isHalfDayStart.addEventListener('change', function () {
            calculateDays();
            updateHalfDaySession();
        });
        isHalfDayEnd.addEventListener('change', function () {
            calculateDays();
            updateHalfDaySession();
        });

        function updateHalfDaySession() {
            // Show session selector only for single day half-day
            const start = startDateInput.value;
            const end = endDateInput.value;
            const isSingleDay = start && end && start === end;
            const isHalfDay = isHalfDayStart.checked || isHalfDayEnd.checked;

            halfDaySessionSection.style.display = (isSingleDay && isHalfDay) ? 'block' : 'none';
        }

        function calculateDays() {
            const start = startDateInput.value;
            const end = endDateInput.value;

            if (!start || !end) {
                totalDaysDisplay.textContent = '0';
                return;
            }

            const startDate = new Date(start);
            const endDate = new Date(end);

            if (startDate > endDate) {
                totalDaysDisplay.textContent = '0';
                return;
            }

            let days = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

            if (isHalfDayStart.checked) days -= 0.5;
            if (isHalfDayEnd.checked) days -= 0.5;

            totalDaysDisplay.textContent = Math.max(0, days);
            updateHalfDaySession();
        }

        // Form submission
        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingText = document.getElementById('loadingText');
            const alertContainer = document.getElementById('alertContainer');

            alertContainer.innerHTML = '';

            // Validate
            if (!leaveTypeSelect.value) {
                showAlert('Please select a leave type', 'danger');
                return;
            }

            if (!startDateInput.value || !endDateInput.value) {
                showAlert('Please select leave dates', 'danger');
                return;
            }

            // Show loading
            submitBtn.disabled = true;
            submitText.classList.add('d-none');
            loadingText.classList.remove('d-none');

            try {
                const payload = {
                    leaveTypeId: leaveTypeSelect.value,
                    startDate: startDateInput.value,
                    endDate: endDateInput.value,
                    isHalfDayStart: isHalfDayStart.checked,
                    isHalfDayEnd: isHalfDayEnd.checked,
                    halfDaySession: document.getElementById('halfDaySession').value || null,
                    reason: document.getElementById('reason').value
                };

                const response = await fetch('/employee/leaves/apply', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Leave application submitted successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '/employee/leaves';
                    }, 1500);
                } else {
                    const errorMsg = data.errors?.join(', ') || data.message || 'Failed to submit application';
                    showAlert(errorMsg, 'danger');
                }
            } catch (error) {
                console.error('Submit error:', error);
                showAlert('Network error. Please try again.', 'danger');
            } finally {
                submitBtn.disabled = false;
                submitText.classList.remove('d-none');
                loadingText.classList.add('d-none');
            }
        });

        function showAlert(message, type) {
            const alertClass = type === 'success' ? 'emp-alert-success' : 'emp-alert-danger';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-circle-exclamation';

            document.getElementById('alertContainer').innerHTML = `
                <div class="emp-alert ${alertClass} mb-4">
                    <i class="fa-solid ${icon} me-2"></i>
                    ${message}
                </div>
            `;

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });
</script>