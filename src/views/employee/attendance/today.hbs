<div class="container-fluid">
    <div class="row">
        {{> employee-sidebar employee=employee active='attendance_today'}}

        <!-- Main Content -->
        <div class="col-md-10 emp-main">
            <div class="emp-page-header">
                <h1 class="emp-page-title">Today's Attendance</h1>
                <p class="text-muted mt-1">Your attendance status for today</p>
            </div>

            <!-- Alert Messages -->
            <div id="alertContainer"></div>

            <!-- Today's Summary Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-4 col-sm-6">
                    <div class="emp-card">
                        <div class="emp-card-body text-center">
                            <div style="font-size: 32px; color: var(--emp-primary); margin-bottom: 8px;">
                                <i class="fa-solid fa-check-circle"></i>
                            </div>
                            <div id="statusDisplay" style="font-size: 24px; font-weight: 700; color: #1e293b;">-</div>
                            <div style="font-size: 13px; color: #94a3b8; margin-top: 4px;">Today's Status</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-sm-6">
                    <div class="emp-card">
                        <div class="emp-card-body text-center">
                            <div style="font-size: 32px; color: #f59e0b; margin-bottom: 8px;">
                                <i class="fa-solid fa-clock"></i>
                            </div>
                            <div id="checkInDisplay" style="font-size: 24px; font-weight: 700; color: #1e293b;">-</div>
                            <div style="font-size: 13px; color: #94a3b8; margin-top: 4px;">Check-in Time</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-sm-6">
                    <div class="emp-card">
                        <div class="emp-card-body text-center">
                            <div style="font-size: 32px; color: #06b6d4; margin-bottom: 8px;">
                                <i class="fa-solid fa-building"></i>
                            </div>
                            <div id="locationDisplay" style="font-size: 24px; font-weight: 700; color: #1e293b;">-</div>
                            <div style="font-size: 13px; color: #94a3b8; margin-top: 4px;">Location</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Punch Actions -->
            <div class="emp-card mb-4">
                <div class="emp-card-header">
                    <h5 class="emp-card-title">
                        <i class="fa-solid fa-hand" style="color: var(--emp-primary);"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="emp-card-body">
                    <div class="d-flex gap-2 flex-wrap">
                        <button id="punchInBtn" class="btn emp-btn-primary" onclick="handlePunch('IN')">
                            <i class="fa-solid fa-arrow-right-to-bracket me-1"></i> Punch In
                        </button>
                        <button id="punchOutBtn" class="btn emp-btn-secondary" onclick="handlePunch('OUT')" disabled>
                            <i class="fa-solid fa-arrow-right-from-bracket me-1"></i> Punch Out
                        </button>
                        <button id="breakStartBtn" class="btn btn-outline-warning" onclick="handlePunch('BREAK_START')" disabled>
                            <i class="fa-solid fa-pause me-1"></i> Break Start
                        </button>
                        <button id="breakEndBtn" class="btn btn-outline-warning" onclick="handlePunch('BREAK_END')" disabled>
                            <i class="fa-solid fa-play me-1"></i> Break End
                        </button>
                    </div>
                </div>
            </div>

            <!-- Attendance Details -->
            <div class="emp-card mb-4">
                <div class="emp-card-header">
                    <h5 class="emp-card-title">
                        <i class="fa-solid fa-list" style="color: var(--emp-primary);"></i>
                        Attendance Log
                    </h5>
                    <a href="/employee/attendance/regularization_form" class="btn emp-btn-secondary btn-sm">
                        <i class="fa-solid fa-pen me-1"></i> Request Regularization
                    </a>
                </div>
                <div class="emp-card-body p-0">
                    <table class="emp-table mb-0">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Event</th>
                                <th>Location</th>
                                <th class="text-end">Status</th>
                            </tr>
                        </thead>
                        <tbody id="punchTableBody">
                            <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function formatTime(dateString) {
    if (!dateString) return '-';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '-';
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    } catch (e) {
        return '-';
    }
}

function showAlert(message, type = 'info') {
    const alertContainer = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.role = 'alert';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertContainer.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}

async function handlePunch(type) {
    try {
        const punchBtn = document.getElementById('punchInBtn');
        const outBtn = document.getElementById('punchOutBtn');
        const allBtns = [punchBtn, outBtn, document.getElementById('breakStartBtn'), document.getElementById('breakEndBtn')];
        allBtns.forEach(b => b.disabled = true);
        
        // Get geolocation if available
        let latitude, longitude;
        if (navigator.geolocation) {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject);
            }).catch(() => null);
            if (position) {
                latitude = position.coords.latitude;
                longitude = position.coords.longitude;
            }
        }

        const response = await fetch('/employee/attendance/punch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type, latitude, longitude }),
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            showAlert(error.message || 'Failed to record punch', 'danger');
            loadAttendanceData();
            return;
        }

        const data = await response.json();
        if (data.success) {
            showAlert(`${type.replace(/_/g, ' ')} recorded successfully!`, 'success');
            await loadAttendanceData();
        } else {
            showAlert(data.message || 'Failed to record punch', 'danger');
            loadAttendanceData();
        }
    } catch (error) {
        showAlert('Error recording punch: ' + error.message, 'danger');
        loadAttendanceData();
    }
}

async function loadAttendanceData() {
    try {
        const response = await fetch('/employee/attendance/api/today-summary', {
            method: 'GET',
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.summary) {
            const summary = data.summary;
            
            // Update status cards
            document.getElementById('statusDisplay').textContent = summary.status || 'Not Marked';
            document.getElementById('checkInDisplay').textContent = summary.firstInAt ? formatTime(summary.firstInAt) : '-';
            document.getElementById('locationDisplay').textContent = summary.location || '-';
            
            // Update button states based on punch history
            const hasCheckedIn = !!summary.firstInAt;
            const hasCheckedOut = !!summary.lastOutAt;
            
            document.getElementById('punchInBtn').disabled = hasCheckedIn;
            document.getElementById('punchOutBtn').disabled = !hasCheckedIn || hasCheckedOut;
            document.getElementById('breakStartBtn').disabled = !hasCheckedIn || hasCheckedOut;
            document.getElementById('breakEndBtn').disabled = !hasCheckedIn || hasCheckedOut;
            
            // Update punch log table
            const tbody = document.getElementById('punchTableBody');
            tbody.innerHTML = '';
            
            if (data.punches && Array.isArray(data.punches) && data.punches.length > 0) {
                data.punches.forEach(punch => {
                    const row = document.createElement('tr');
                    const punchType = punch.punchType || punch.type || 'UNKNOWN';
                    const time = punch.punchAt ? formatTime(punch.punchAt) : (punch.timestamp ? formatTime(punch.timestamp) : '-');
                    row.innerHTML = `
                        <td>${time}</td>
                        <td>${punchType}</td>
                        <td>${punch.location || '-'}</td>
                        <td class="text-end"><span class="emp-badge emp-badge-approved">Recorded</span></td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="4" class="text-center text-muted">No punches recorded yet</td>';
                tbody.appendChild(row);
            }
        } else {
            // API returned error or unexpected format
            const tbody = document.getElementById('punchTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Unable to load attendance data</td></tr>';
        }
    } catch (error) {
        console.error('Error loading data:', error);
        const tbody = document.getElementById('punchTableBody');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Failed to load attendance data</td></tr>';
    }
}

// Load data on page load and refresh periodically
document.addEventListener('DOMContentLoaded', () => {
    loadAttendanceData();
    // Refresh every 30 seconds
    setInterval(loadAttendanceData, 30000);
});
</script>
