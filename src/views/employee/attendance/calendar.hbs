<div class="container-fluid">
    <div class="row">
        {{> employee-sidebar employee=employee active='attendance_calendar'}}

        <!-- Main Content -->
        <div class="col-md-10 emp-main">
            <div class="emp-page-header">
                <h1 class="emp-page-title">Attendance Calendar</h1>
                <p class="text-muted mt-1">Your monthly attendance summary</p>
            </div>

            <!-- Alert Messages -->
            <div id="alertContainer"></div>

            <!-- Monthly Stats -->
            <div class="row g-3 mb-4">
                <div class="col-md-3 col-sm-6">
                    <div class="emp-card">
                        <div class="emp-card-body text-center">
                            <div style="font-size: 32px; color: #22c55e; margin-bottom: 8px;">
                                <i class="fa-solid fa-check-circle"></i>
                            </div>
                            <div id="presentCount" style="font-size: 24px; font-weight: 700; color: #1e293b;">-</div>
                            <div style="font-size: 13px; color: #94a3b8; margin-top: 4px;">Days Present</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="emp-card">
                        <div class="emp-card-body text-center">
                            <div style="font-size: 32px; color: #ef4444; margin-bottom: 8px;">
                                <i class="fa-solid fa-times-circle"></i>
                            </div>
                            <div id="absentCount" style="font-size: 24px; font-weight: 700; color: #1e293b;">-</div>
                            <div style="font-size: 13px; color: #94a3b8; margin-top: 4px;">Days Absent</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="emp-card">
                        <div class="emp-card-body text-center">
                            <div style="font-size: 32px; color: #f59e0b; margin-bottom: 8px;">
                                <i class="fa-solid fa-hourglass"></i>
                            </div>
                            <div id="pendingCount" style="font-size: 24px; font-weight: 700; color: #1e293b;">-</div>
                            <div style="font-size: 13px; color: #94a3b8; margin-top: 4px;">Pending</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="emp-card">
                        <div class="emp-card-body text-center">
                            <div style="font-size: 32px; color: var(--emp-primary); margin-bottom: 8px;">
                                <i class="fa-solid fa-percent"></i>
                            </div>
                            <div id="attendanceRate" style="font-size: 24px; font-weight: 700; color: #1e293b;">-</div>
                            <div style="font-size: 13px; color: #94a3b8; margin-top: 4px;">Attendance Rate</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Card -->
            <div class="emp-card shadow-sm">
                <div class="emp-card-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border-bottom: none; color: white; border-radius: 10px 10px 0 0;">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <div>
                            <h5 class="emp-card-title mb-0" style="color: white;">
                                <i class="fa-solid fa-calendar-days me-2"></i>
                                <span id="monthDisplay">January 2026</span>
                            </h5>
                            <small style="color: rgba(255,255,255,0.9); display: block; margin-top: 4px;">
                                <i class="fa-solid fa-sync-alt me-1" id="refreshIndicator" style="display: none; animation: spin 1s linear infinite;"></i>
                                Last updated: <span id="lastUpdateTime">just now</span>
                            </small>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <input type="month" id="monthPicker" class="form-control form-control-sm" style="width: 150px; border-radius: 6px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;" />
                            <button class="btn btn-light btn-sm" onclick="refreshCalendar()" title="Refresh calendar" style="border-radius: 6px;">
                                <i class="fa-solid fa-rotate-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="emp-card-body" style="padding: 20px;">
                    <!-- Professional Calendar Grid -->
                    <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <!-- Weekday Headers -->
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; margin-bottom: 15px; background: #f0f0f0; border-radius: 6px; overflow: hidden;">
                            <div style="background: #6366f1; color: white; padding: 12px; text-align: center; font-weight: 600; font-size: 14px;">Sun</div>
                            <div style="background: #6366f1; color: white; padding: 12px; text-align: center; font-weight: 600; font-size: 14px;">Mon</div>
                            <div style="background: #6366f1; color: white; padding: 12px; text-align: center; font-weight: 600; font-size: 14px;">Tue</div>
                            <div style="background: #6366f1; color: white; padding: 12px; text-align: center; font-weight: 600; font-size: 14px;">Wed</div>
                            <div style="background: #6366f1; color: white; padding: 12px; text-align: center; font-weight: 600; font-size: 14px;">Thu</div>
                            <div style="background: #6366f1; color: white; padding: 12px; text-align: center; font-weight: 600; font-size: 14px;">Fri</div>
                            <div style="background: #6366f1; color: white; padding: 12px; text-align: center; font-weight: 600; font-size: 14px;">Sat</div>
                        </div>

                        <!-- Calendar Days -->
                        <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; min-height: 400px;">
                            <div style="padding: 40px; text-align: center; color: #ccc;">Loading calendar...</div>
                        </div>
                    </div>
                </div>
                <div class="emp-card-footer" style="background: #f8f9fa; border-top: 2px solid rgba(0,0,0,0.05); padding: 15px 20px; border-radius: 0 0 10px 10px;">
                    <div class="d-flex gap-3 flex-wrap" style="flex-wrap: wrap;">
                        <div class="d-flex align-items-center gap-2">
                            <div style="width: 12px; height: 12px; background: #22c55e; border-radius: 3px;"></div>
                            <small><strong>Present</strong></small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 3px;"></div>
                            <small><strong>Absent</strong></small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 3px;"></div>
                            <small><strong>Late</strong></small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div style="width: 12px; height: 12px; background: #8b5cf6; border-radius: 3px;"></div>
                            <small><strong>Holiday</strong></small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div style="width: 12px; height: 12px; background: #0ea5e9; border-radius: 3px;"></div>
                            <small><strong>Leave</strong></small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div style="width: 12px; height: 12px; background: #6b7280; border-radius: 3px;"></div>
                            <small><strong>Not Marked</strong></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}

.calendar-day {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 8px;
    min-height: 80px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
}

.calendar-day:hover {
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.calendar-day.other-month {
    background: #f9fafb;
    opacity: 0.6;
}

.calendar-day.today {
    border: 2px solid #6366f1;
    background: #f0f4ff;
}

.calendar-day.holiday {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
    border-color: #7c3aed;
}

.calendar-day-date {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
}

.calendar-day-status {
    font-size: 11px;
    font-weight: 500;
    padding: 3px 6px;
    border-radius: 3px;
    text-align: center;
    margin-top: auto;
}

.status-present {
    background: #d1fae5;
    color: #065f46;
}

.status-absent {
    background: #fee2e2;
    color: #991b1b;
}

.status-late {
    background: #fef3c7;
    color: #92400e;
}

.status-leave {
    background: #cffafe;
    color: #164e63;
}

.status-holiday {
    background: #f3e8ff;
    color: #5b21b6;
    color: white;
}

.status-notmarked {
    background: #f3f4f6;
    color: #374151;
}

.holiday-name {
    font-size: 10px;
    margin-top: 2px;
    padding: 2px 4px;
    background: rgba(255,255,255,0.2);
    border-radius: 2px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}
</style>

<script>
function showAlert(message, type = 'info') {
    const alertContainer = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.role = 'alert';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertContainer.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}

let attendanceData = {};
let holidaysData = [];
let currentMonthStr = null;

async function loadMonthlyAttendance(monthStr) {
    try {
        document.getElementById('refreshIndicator').style.display = 'inline-block';
        
        const response = await fetch(`/employee/attendance/api/month-summary?month=${monthStr}`, {
            method: 'GET',
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        if (data.success && Array.isArray(data.data)) {
            // Store attendance data by date
            attendanceData = {};
            data.data.forEach(att => {
                attendanceData[att.date] = att;
            });
            
            // Store holidays
            if (data.holidays && Array.isArray(data.holidays)) {
                holidaysData = data.holidays;
            }
            
            // Calculate stats
            const present = data.data.filter(a => a.status === 'PRESENT').length;
            const absent = data.data.filter(a => a.status === 'ABSENT').length;
            const pending = data.data.filter(a => a.status === 'NOT_MARKED' || a.status === null).length;
            const total = present + absent + pending;
            const rate = total > 0 ? Math.round((present / total) * 100) : 0;
            
            document.getElementById('presentCount').textContent = present;
            document.getElementById('absentCount').textContent = absent;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('attendanceRate').textContent = rate + '%';
            
            // Render calendar
            renderCalendarGrid(monthStr);
            
            // Update last refresh time
            const now = new Date();
            document.getElementById('lastUpdateTime').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else {
            throw new Error('Invalid response format');
        }
    } catch (error) {
        console.error('Error loading monthly attendance:', error);
        showAlert('Error loading monthly attendance: ' + error.message, 'danger');
    } finally {
        document.getElementById('refreshIndicator').style.display = 'none';
    }
}

function renderCalendarGrid(monthStr) {
    const [year, month] = monthStr.split('-');
    const date = new Date(year, parseInt(month) - 1, 1);
    const firstDay = date.getDay();
    const daysInMonth = new Date(year, parseInt(month), 0).getDate();
    
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';
    
    // Add empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'calendar-day other-month';
        grid.appendChild(emptyCell);
    }
    
    // Add days of month
    const today = new Date().toISOString().split('T')[0];
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const cell = document.createElement('div');
        cell.className = 'calendar-day';
        
        if (dateStr === today) {
            cell.classList.add('today');
        }
        
        // Check if holiday
        const holiday = holidaysData.find(h => h.date === dateStr);
        if (holiday) {
            cell.classList.add('holiday');
            cell.innerHTML = `
                <div class="calendar-day-date">${day}</div>
                <div class="holiday-name">${holiday.name}</div>
                <div class="calendar-day-status status-holiday">üéâ Holiday</div>
            `;
        } else {
            // Check attendance status
            const attendance = attendanceData[dateStr];
            const dateObj = new Date(dateStr);
            const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6;
            
            let status = attendance?.status || 'NOT_MARKED';
            let statusDisplay = '-';
            let statusClass = 'status-notmarked';
            
            if (status === 'PRESENT') {
                statusDisplay = '‚úì Present';
                statusClass = 'status-present';
            } else if (status === 'ABSENT') {
                statusDisplay = '‚úó Absent';
                statusClass = 'status-absent';
            } else if (status === 'LATE') {
                statusDisplay = '‚è∞ Late';
                statusClass = 'status-late';
            } else if (status === 'LEAVE' || status === 'HALF_DAY') {
                statusDisplay = 'üèñ Leave';
                statusClass = 'status-leave';
            } else if (status === 'WEEKOFF') {
                statusDisplay = 'Weekoff';
                statusClass = 'status-notmarked';
            } else if (status === 'HOLIDAY') {
                statusDisplay = 'Holiday';
                statusClass = 'status-holiday';
            } else {
                statusDisplay = '-';
                statusClass = 'status-notmarked';
            }
            
            const timeInfo = attendance?.firstInAt ? `<small style="font-size: 10px; color: #6b7280; margin-top: 2px;">IN: ${new Date(attendance.firstInAt).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</small>` : '';
            
            cell.innerHTML = `
                <div class="calendar-day-date">${day}</div>
                ${timeInfo}
                <div class="calendar-day-status ${statusClass}">${statusDisplay}</div>
            `;
            
            // Add click handler for details
            cell.style.cursor = 'pointer';
            cell.addEventListener('click', () => {
                if (attendance) {
                    showAttendanceDetail(attendance, dateStr);
                }
            });
        }
        
        grid.appendChild(cell);
    }
}

function showAttendanceDetail(attendance, dateStr) {
    const checkin = attendance.firstInAt ? new Date(attendance.firstInAt).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'}) : '-';
    const checkout = attendance.lastOutAt ? new Date(attendance.lastOutAt).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'}) : '-';
    
    showAlert(`
        <strong>Attendance Details - ${dateStr}</strong>
        <div style="margin-top: 10px; text-align: left;">
            <p><strong>Status:</strong> ${attendance.status || 'NOT_MARKED'}</p>
            <p><strong>Check-in:</strong> ${checkin}</p>
            <p><strong>Check-out:</strong> ${checkout}</p>
            ${attendance.workMinutes ? `<p><strong>Work Hours:</strong> ${Math.floor(attendance.workMinutes / 60)}h ${attendance.workMinutes % 60}m</p>` : ''}
        </div>
    `, 'info');
}

function refreshCalendar() {
    if (currentMonthStr) {
        loadMonthlyAttendance(currentMonthStr);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Set default month to current month
    const today = new Date();
    const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
    currentMonthStr = currentMonth;
    document.getElementById('monthPicker').value = currentMonth;
    
    // Update month display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    const [year, month] = currentMonth.split('-');
    document.getElementById('monthDisplay').textContent = monthNames[parseInt(month) - 1] + ' ' + year;
    
    // Load initial data
    loadMonthlyAttendance(currentMonth);
    
    // Auto-refresh attendance data every 5 seconds (real-time updates)
    setInterval(() => {
        if (currentMonthStr) {
            loadMonthlyAttendance(currentMonthStr);
        }
    }, 5000);
    
    // Month picker change handler
    document.getElementById('monthPicker').addEventListener('change', function(e) {
        const selectedMonth = e.target.value;
        currentMonthStr = selectedMonth;
        const [year, month] = selectedMonth.split('-');
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
        document.getElementById('monthDisplay').textContent = monthNames[parseInt(month) - 1] + ' ' + year;
        
        loadMonthlyAttendance(selectedMonth);
    });
});
</script>

<!-- Include Employee Dashboard Real-time Sync Script -->
<script src="/assets/js/employee-dashboard.js"></script>
