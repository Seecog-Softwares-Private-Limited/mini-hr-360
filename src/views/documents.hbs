{{!-- views/documents.hbs --}}
<div class="container-fluid">
  <div class="row">
    {{!-- Sidebar same as Employees page, but Documents active --}}
    <div class="col-md-3 col-lg-2 px-0">
      {{> sidebar}}
    </div>

    <div class="col-md-9 col-lg-10">
      <div class="main-content p-4">
        <h2 class="mb-4">Generate Documents</h2>

        <div class="card">
          <div class="card-body">
            <form id="generateDocumentForm" method="POST" action="/documents/generate">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Employee</label>
                  <select name="employeeId" id="employeeSelect" class="form-select" required>
                    <option value="">Select employee</option>
                    {{#each employees}}
                      <option
                        value="{{id}}"
                        data-internship-start-date="{{internshipStartDatePrefill}}"
                        data-internship-offer-date="{{internshipOfferDatePrefill}}"
                      >
                        {{empName}} ({{empId}})
                      </option>
                    {{/each}}
                  </select>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Document Type</label>
                  {{!-- Icon-capable dropdown (keeps hidden select for form submit + existing JS) --}}
                  <div class="dropdown w-100" id="documentTypeDropdown">
                    <button
                      class="btn btn-outline-secondary dropdown-toggle w-100 text-start d-flex align-items-center justify-content-between"
                      type="button"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                      id="documentTypeDropdownBtn"
                    >
                      <span class="d-flex align-items-center gap-2" id="documentTypeDropdownLabel">
                        <i class="fas fa-file-lines text-muted"></i>
                        <span>Select document type</span>
                      </span>
                    </button>
                    <ul
                      class="dropdown-menu w-100"
                      id="documentTypeDropdownMenu"
                      style="max-height: 280px; overflow:auto;"
                    >
                      {{#each documentTypes}}
                        <li>
                          <button
                            class="dropdown-item d-flex align-items-center gap-2"
                            type="button"
                            data-id="{{id}}"
                            data-code="{{code}}"
                            data-icon="{{icon}}"
                          >
                            {{#if icon}}
                              <i class="{{icon}}"></i>
                            {{else}}
                              <i class="fas fa-file-lines"></i>
                            {{/if}}
                            <span>{{name}}</span>
                          </button>
                        </li>
                      {{/each}}
                    </ul>
                  </div>

                  {{!-- Hidden select still drives form submit + dynamic-field JS --}}
                  <select
                    name="documentTypeId"
                    id="documentTypeSelect"
                    class="form-select d-none"
                    required
                  >
                    <option value="">Select document type</option>
                    {{#each documentTypes}}
                      <option
                        value="{{id}}"
                        data-code="{{code}}"
                        data-icon="{{icon}}"
                      >
                        {{name}}
                      </option>
                    {{/each}}
                  </select>
                </div>
              </div>

              {{!-- Extra dynamic fields section --}}
              <div class="row g-3 mt-3">
                {{!-- Bonus Letter extra field --}}
                <div class="col-md-6" id="bonusFieldWrapper" style="display: none;">
                  <label class="form-label" for="bonusAmount">
                    Bonus Amount (₹)
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    min="0"
                    class="form-control"
                    id="bonusAmount"
                    name="bonusAmount"
                    placeholder="Enter bonus amount"
                  />
                </div>

                {{!-- Increment Letter extra field --}}
                <div class="col-md-6" id="incrementFieldWrapper" style="display: none;">
                  <label class="form-label" for="incrementAmount">
                    Salary Increment (₹)
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    min="0"
                    class="form-control"
                    id="incrementAmount"
                    name="incrementAmount"
                    placeholder="Enter increment amount"
                  />
                </div>
              </div>

              {{!-- Salary Slip extra fields --}}
              <div class="row g-3 mt-3">
                <div class="col-md-6" id="salaryMonthWrapper" style="display: none;">
                  <label class="form-label" for="salaryMonth">
                    Salary Month
                  </label>
                  <select
                    class="form-select"
                    id="salaryMonth"
                    name="salaryMonth"
                  >
                    <option value="">Select month</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                  </select>
                </div>

                <div class="col-md-6" id="reimbursementWrapper" style="display: none;">
                  <label class="form-label" for="reimbursement">
                    Reimbursement (₹)
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    min="0"
                    class="form-control"
                    id="reimbursement"
                    name="reimbursement"
                    placeholder="Enter reimbursement amount"
                  />
                </div>

                {{!-- ✅ NEW: Non Paid Leave (0 to 28) --}}
                <div class="col-md-6" id="nonPaidLeaveWrapper" style="display: none;">
                  <label class="form-label" for="nonPaidLeave">
                    Non Paid Leave (LOP Days)
                  </label>
                  <select class="form-select" id="nonPaidLeave" name="nonPaidLeave">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                    <option value="26">26</option>
                    <option value="27">27</option>
                    <option value="28">28</option>
                  </select>
                </div>
              </div>

              {{!-- Offer Letter extra fields --}}
              <div class="row g-3 mt-3">
                <div class="col-md-6" id="offerJoiningDateWrapper" style="display: none;">
                  <label class="form-label" for="offerJoiningDate">
                    Joining Date
                  </label>
                  <input
                    type="date"
                    class="form-control"
                    id="offerJoiningDate"
                    name="joiningDate"
                  />
                </div>
              </div>

              {{!-- Internship Offer extra fields --}}
              <div class="row g-3 mt-3">
                <div class="col-md-6" id="internshipOfferDateWrapper" style="display: none;">
                  <label class="form-label" for="internshipOfferDate">
                    Internship Offer Date
                  </label>
                  <input
                    type="date"
                    class="form-control"
                    id="internshipOfferDate"
                    name="internshipOfferDate"
                  />
                </div>
                
                <div class="col-md-6" id="internshipStartWrapper" style="display: none;">
                  <label class="form-label" for="internshipStartDate">
                    Internship Start Date
                  </label>
                  <input
                    type="date"
                    class="form-control"
                    id="internshipStartDate"
                    name="internshipStartDate"
                  />
                </div>

                
              </div>

              <div class="mt-4 d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-file-pdf me-2"></i>Generate Document (PDF)
                </button>
              </div>
            </form>

            <p class="text-muted mt-3">
              The PDF will be generated in A4 size and downloaded automatically.
            </p>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const docTypeSelect = document.getElementById('documentTypeSelect');
    const docTypeDropdownMenu = document.getElementById('documentTypeDropdownMenu');
    const docTypeDropdownLabel = document.getElementById('documentTypeDropdownLabel');
    const employeeSelect = document.getElementById('employeeSelect');

    const bonusFieldWrapper = document.getElementById('bonusFieldWrapper');
    const incrementFieldWrapper = document.getElementById('incrementFieldWrapper');
    const bonusAmountInput = document.getElementById('bonusAmount');
    const incrementAmountInput = document.getElementById('incrementAmount');

    const salaryMonthWrapper = document.getElementById('salaryMonthWrapper');
    const reimbursementWrapper = document.getElementById('reimbursementWrapper');
    const salaryMonthInput = document.getElementById('salaryMonth');
    const reimbursementInput = document.getElementById('reimbursement');

    // ✅ NEW: Non Paid Leave
    const nonPaidLeaveWrapper = document.getElementById('nonPaidLeaveWrapper');
    const nonPaidLeaveInput = document.getElementById('nonPaidLeave');

    const offerJoiningDateWrapper = document.getElementById('offerJoiningDateWrapper');
    const offerJoiningDateInput = document.getElementById('offerJoiningDate');

    // Internship Offer fields
    const internshipStartWrapper = document.getElementById('internshipStartWrapper');
    const internshipOfferDateWrapper = document.getElementById('internshipOfferDateWrapper');
    const internshipStartInput = document.getElementById('internshipStartDate');
    const internshipOfferDateInput = document.getElementById('internshipOfferDate');

    function resetDynamicFields() {
      bonusFieldWrapper.style.display = 'none';
      incrementFieldWrapper.style.display = 'none';
      salaryMonthWrapper.style.display = 'none';
      reimbursementWrapper.style.display = 'none';
      offerJoiningDateWrapper.style.display = 'none';
      internshipStartWrapper.style.display = 'none';
      internshipOfferDateWrapper.style.display = 'none';

      // ✅ NEW
      if (nonPaidLeaveWrapper) nonPaidLeaveWrapper.style.display = 'none';

      if (bonusAmountInput) bonusAmountInput.value = '';
      if (incrementAmountInput) incrementAmountInput.value = '';
      if (salaryMonthInput) salaryMonthInput.selectedIndex = 0;
      if (reimbursementInput) reimbursementInput.value = '';
      if (offerJoiningDateInput) offerJoiningDateInput.value = '';
      if (internshipStartInput) internshipStartInput.value = '';
      if (internshipOfferDateInput) internshipOfferDateInput.value = '';

      // ✅ NEW
      if (nonPaidLeaveInput) nonPaidLeaveInput.selectedIndex = 0;
    }

    function isInternshipOfferSelected() {
      const selectedOption = docTypeSelect.options[docTypeSelect.selectedIndex];
      if (!selectedOption) return false;

      const rawCode = selectedOption.getAttribute('data-code') || '';
      const code = rawCode.toUpperCase();

      return (
        code === 'INTERNSHIP_OFFER' ||
        code === 'INTERN_OFFER' ||
        code === 'INTERNSHIP_OFFER_LETTER'
      );
    }

    function prefillInternshipDatesFromEmployee() {
      if (!employeeSelect || !internshipStartInput || !internshipOfferDateInput) return;

      const empOpt = employeeSelect.options[employeeSelect.selectedIndex];
      if (!empOpt) return;

      const dbStart = empOpt.getAttribute('data-internship-start-date') || '';
      const dbOffer = empOpt.getAttribute('data-internship-offer-date') || '';

      // If DB has values, set them
      if (dbStart) internshipStartInput.value = dbStart;
      if (dbOffer) internshipOfferDateInput.value = dbOffer;
    }

    function handleDocTypeChange() {
      resetDynamicFields();

      const selectedOption = docTypeSelect.options[docTypeSelect.selectedIndex];
      if (!selectedOption) return;

      const rawCode = selectedOption.getAttribute('data-code') || '';
      const code = rawCode.toUpperCase();

      // Show Bonus field for BONUS_LETTER / BONUS
      if (code === 'BONUS_LETTER' || code === 'BONUS') {
        bonusFieldWrapper.style.display = 'block';
      }

      // Show Increment field for INCREMENT_LETTER / INCREMENT
      if (code === 'INCREMENT_LETTER' || code === 'INCREMENT') {
        incrementFieldWrapper.style.display = 'block';
      }

      // Show Salary Slip fields for SALARY_SLIP
      if (code === 'SALARY_SLIP') {
        salaryMonthWrapper.style.display = 'block';
        reimbursementWrapper.style.display = 'block';

        // ✅ NEW
        if (nonPaidLeaveWrapper) nonPaidLeaveWrapper.style.display = 'block';
      }

      // Show Offer Letter fields for OFFER_LETTER
      if (code === 'OFFER_LETTER') {
        offerJoiningDateWrapper.style.display = 'block';
      }

      // Show Internship Offer fields
      if (isInternshipOfferSelected()) {
        internshipStartWrapper.style.display = 'block';
        internshipOfferDateWrapper.style.display = 'block';

        // ✅ Prefill from DB (employee option dataset)
        prefillInternshipDatesFromEmployee();
      }
    }

    function syncDocTypeDropdownLabel() {
      if (!docTypeDropdownLabel || !docTypeSelect) return;
      const opt = docTypeSelect.options[docTypeSelect.selectedIndex];
      if (!opt || !opt.value) {
        docTypeDropdownLabel.innerHTML = `<i class="fas fa-file-lines text-muted"></i><span>Select document type</span>`;
        return;
      }
      const iconClass = opt.getAttribute('data-icon') || 'fas fa-file-lines';
      const name = opt.textContent || 'Selected';
      docTypeDropdownLabel.innerHTML = `<i class="${iconClass}"></i><span>${name}</span>`;
    }

    // Dropdown click -> update hidden select + trigger existing logic
    if (docTypeDropdownMenu && docTypeSelect) {
      docTypeDropdownMenu.addEventListener('click', function (e) {
        const btn = e.target.closest('button.dropdown-item');
        if (!btn) return;
        const id = btn.getAttribute('data-id') || '';
        docTypeSelect.value = id;
        docTypeSelect.dispatchEvent(new Event('change', { bubbles: true }));
      });
    }

    function handleEmployeeChange() {
      // Only prefill when Internship Offer is selected
      if (isInternshipOfferSelected()) {
        prefillInternshipDatesFromEmployee();
      }
    }

    if (docTypeSelect) {
      docTypeSelect.addEventListener('change', handleDocTypeChange);
      docTypeSelect.addEventListener('change', syncDocTypeDropdownLabel);
      handleDocTypeChange();
      syncDocTypeDropdownLabel();
    }

    if (employeeSelect) {
      employeeSelect.addEventListener('change', handleEmployeeChange);
      handleEmployeeChange();
    }
  })();
</script>
