{{!-- views/employees.hbs --}}
<div class="container-fluid">
  <div class="row">
    {{!-- Sidebar --}}
    <div class="col-md-3 col-lg-2 px-0">
      {{> sidebar}}
    </div>

    {{!-- Main content --}}
    <div class="col-md-9 col-lg-10">
      <div class="main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2 class="mb-0">Employees</h2>

            {{!-- info about filter / count --}}
            {{#if search}}
              <small class="text-muted">
                Showing results for: "<strong>{{search}}</strong>"
              </small>
            {{else}}
              <small class="text-muted">
                Total employees:
                {{#if employees.length}}{{employees.length}}{{else}}0{{/if}}
              </small>
            {{/if}}
          </div>

          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#addEmployeeModal"
            id="openAddEmployeeModalBtn"
          >
            <i class="fas fa-plus me-2"></i> Add Employee
          </button>
        </div>

        {{!-- Search form --}}
        <form
          class="row mb-3"
          id="employeeSearchForm"
          method="GET"
          action="/employees"
        >
          <div class="col-md-4 mb-2">
            <input
              type="text"
              id="employeeSearchInput"
              name="search"
              class="form-control"
              placeholder="Search by name, email, ID"
              value="{{search}}"
            />
          </div>
          <div class="col-md-2 mb-2">
            <button class="btn btn-outline-secondary w-100" type="submit">
              <i class="fas fa-search me-1"></i> Search
            </button>
          </div>
          {{#if search}}
            <div class="col-md-2 mb-2">
              <a class="btn btn-outline-light w-100" href="/employees">
                <i class="fas fa-times me-1"></i> Clear
              </a>
            </div>
          {{/if}}
        </form>

        {{!-- Employees table --}}
        <div class="card">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Emp ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Designation</th>
                    <th>Department</th>
                    <th>DOJ</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {{#if employees.length}}
                    {{#each employees}}
                      <tr>
                        <td>{{inc @index}}</td>
                        <td>{{empId}}</td>
                        <td>{{empName}}</td>
                        <td>{{empEmail}}</td>
                        <td>{{empPhone}}</td>
                        <td>{{empDesignation}}</td>
                        <td>{{empDepartment}}</td>
                        <td>{{empDateOfJoining}}</td>
                        <td>
                          <div class="btn-group btn-group-sm" role="group">
                            <button
                              type="button"
                              class="btn btn-outline-secondary view-employee-btn"
                              data-id="{{id}}"
                              title="View Employee"
                            >
                              <i class="fas fa-eye"></i>
                            </button>
                            <button
                              type="button"
                              class="btn btn-outline-primary edit-employee-btn"
                              data-id="{{id}}"
                              title="Edit Employee"
                            >
                              <i class="fas fa-edit"></i>
                            </button>
                            <button
                              type="button"
                              class="btn btn-outline-danger delete-employee-btn"
                              data-id="{{id}}"
                              title="Delete Employee"
                            >
                              <i class="fas fa-trash"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                    {{/each}}
                  {{else}}
                    <tr>
                      <td colspan="9" class="text-center py-3">
                        No employees found.
                      </td>
                    </tr>
                  {{/if}}
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

{{!-- Add / Edit Employee Modal --}}
<div class="modal fade" id="addEmployeeModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <form id="addEmployeeForm">
        <input type="hidden" name="id" id="employeeIdField" />

        <div class="modal-header">
          <h5 class="modal-title" id="addEmployeeModalTitle">Add Employee</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          {{!-- Tabs header (6 sections) --}}
          <ul class="nav nav-tabs" id="addEmployeeTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="basic-tab"
                data-bs-toggle="tab"
                data-bs-target="#tab-basic"
                type="button"
                role="tab"
              >
                1) Personal Details
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="job-tab"
                data-bs-toggle="tab"
                data-bs-target="#tab-job"
                type="button"
                role="tab"
              >
                2) Professional Details
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="comp-tab"
                data-bs-toggle="tab"
                data-bs-target="#tab-comp"
                type="button"
                role="tab"
              >
                3) Compensation
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="edu-tab"
                data-bs-toggle="tab"
                data-bs-target="#tab-education"
                type="button"
                role="tab"
              >
                4) Education &amp; Qualification
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="exp-tab"
                data-bs-toggle="tab"
                data-bs-target="#tab-experience"
                type="button"
                role="tab"
              >
                5) Experience / Employment History
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="docs-tab"
                data-bs-toggle="tab"
                data-bs-target="#tab-documents"
                type="button"
                role="tab"
              >
                6) Documents &amp; KYC
              </button>
            </li>
          </ul>

          {{!-- Tabs content --}}
          <div class="tab-content pt-3" id="addEmployeeTabContent">
            {{!-- TAB 1: PERSONAL DETAILS --}}
            <div class="tab-pane fade show active" id="tab-basic" role="tabpanel">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">
                    First Name <span class="text-danger">*</span>
                  </label>
                  <input type="text" name="firstName" class="form-control" required />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Middle Name</label>
                  <input type="text" name="middleName" class="form-control" />
                </div>
                <div class="col-md-4">
                  <label class="form-label">
                    Last Name <span class="text-danger">*</span>
                  </label>
                  <input type="text" name="lastName" class="form-control" required />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Gender</label>
                  <div class="gender-select-wrapper">
                    <select name="gender" id="genderSelect" class="form-select gender-select-original">
                      <option value="">Select</option>
                      <option value="Male">Male</option>
                      <option value="Female">Female</option>
                      <option value="Non-binary">Non-binary</option>
                      <option value="Prefer not to say">Prefer not to say</option>
                    </select>
                    <div class="gender-select-custom" id="genderSelectCustom">
                      <div class="gender-select-trigger placeholder" id="genderSelectTrigger">
                        <span class="gender-select-value">
                          <i class="fas fa-circle-dot" style="color: #6b7280;"></i>
                          <span class="gender-select-text">Select</span>
                        </span>
                        <i class="fas fa-chevron-down gender-select-arrow"></i>
                      </div>
                      <div class="gender-select-dropdown" id="genderSelectDropdown">
                        <div class="gender-option" data-value="">
                          <i class="fas fa-circle-dot gender-option-icon" style="color: #6b7280;"></i>
                          <span class="gender-option-label">Select</span>
                        </div>
                        <div class="gender-option" data-value="Male">
                          <i class="fas fa-mars gender-option-icon gender-icon-male"></i>
                          <span class="gender-option-label">Male</span>
                        </div>
                        <div class="gender-option" data-value="Female">
                          <i class="fas fa-venus gender-option-icon gender-icon-female"></i>
                          <span class="gender-option-label">Female</span>
                        </div>
                        <div class="gender-option" data-value="Non-binary">
                          <i class="fas fa-transgender gender-option-icon gender-icon-nonbinary"></i>
                          <span class="gender-option-label">Non-binary</span>
                        </div>
                        <div class="gender-option" data-value="Prefer not to say">
                          <i class="fas fa-circle-question gender-option-icon gender-icon-prefer-not"></i>
                          <span class="gender-option-label">Prefer not to say</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Marital Status</label>
                  <select name="maritalStatus" class="form-select">
                    <option value="">Select</option>
                    <option value="Single">Single</option>
                    <option value="Married">Married</option>
                    <option value="Other">Other</option>
                  </select>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                  <input type="date" name="empDob" class="form-control" required />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Blood Group</label>
                  <input type="text" name="bloodGroup" class="form-control" />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Nationality</label>
                  <input type="text" name="nationality" class="form-control" />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Religion</label>
                  <input type="text" name="religion" class="form-control" />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Category / Caste</label>
                  <input type="text" name="casteCategory" class="form-control" />
                </div>

                <div class="col-md-8">
                  <label class="form-label">Languages Known</label>
                  <input
                    type="text"
                    name="languagesKnown"
                    class="form-control"
                    placeholder="e.g. English, Hindi, Bengali"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">
                    Primary Contact Number <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    name="empPhone"
                    maxlength="10"
                    class="form-control"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Alternate Contact Number</label>
                  <input
                    type="text"
                    name="altPhone"
                    maxlength="10"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">
                    Personal Email <span class="text-danger">*</span>
                  </label>
                  <input type="email" name="empEmail" class="form-control" required />
                </div>

                <div class="col-12">
                  <hr />
                  <h6>Emergency Contact</h6>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Name</label>
                  <input
                    type="text"
                    name="emergencyContactName"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Relation</label>
                  <input
                    type="text"
                    name="emergencyContactRelation"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Contact Number</label>
                  <input
                    type="text"
                    name="emergencyContactNumber"
                    maxlength="10"
                    class="form-control"
                  />
                </div>

                <div class="col-12">
                  <hr />
                  <h6>Present Address</h6>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Address Line 1</label>
                  <input
                    type="text"
                    name="presentAddressLine1"
                    class="form-control"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Address Line 2</label>
                  <input
                    type="text"
                    name="presentAddressLine2"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">City</label>
                  <input type="text" name="presentCity" class="form-control" />
                </div>
                <div class="col-md-4">
                  <label class="form-label">State</label>
                  {{!-- <input type="text" name="presentState" class="form-control" /> --}}
                  <select name="presentState" class="form-control">
                        <option value="">Select State</option>
                        {{#each states}}
                        <option value="{{name}}">{{name}}</option>
                        {{/each}}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label">ZIP</label>
                  <input type="text" name="presentZip" class="form-control" />
                </div>
                <div class="col-md-2">
                  <label class="form-label">Country</label>
                  {{!-- <input type="text" name="presentCountry" class="form-control" /> --}}
                  <select name="presentCountry" class="form-control">
                        <option value="">Select Country</option>
                        {{#each countries}}
                        <option value="{{name}}">{{name}}</option>
                        {{/each}}
                  </select>
                </div>

                <div class="col-12">
                  <div class="form-check mt-2">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="sameAsPresent"
                      name="permanentSameAsPresent"
                    />
                    <label class="form-check-label" for="sameAsPresent">
                      Permanent address same as present
                    </label>
                  </div>
                </div>

                <div class="col-12">
                  <hr />
                  <h6>Permanent Address</h6>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Address Line 1</label>
                  <input
                    type="text"
                    name="permanentAddressLine1"
                    class="form-control"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Address Line 2</label>
                  <input
                    type="text"
                    name="permanentAddressLine2"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">City</label>
                  <input type="text" name="permanentCity" class="form-control" />
                </div>
                <div class="col-md-4">
                  <label class="form-label">State</label>
                  {{!-- <input type="text" name="permanentState" class="form-control" /> --}}
                  <select name="permanentState" class="form-control">
                        <option value="">Select State</option>
                        {{#each states}}
                        <option value="{{name}}">{{name}}</option>
                        {{/each}}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label">ZIP</label>
                  <input type="text" name="permanentZip" class="form-control" />
                </div>
                <div class="col-md-2">
                  <label class="form-label">Country</label>
                  {{!-- <input type="text" name="permanentCountry" class="form-control" /> --}}
                  <select name="permanentCountry" class="form-control">
                        <option value="">Select Country</option>
                        {{#each countries}}
                        <option value="{{name}}">{{name}}</option>
                        {{/each}}
                  </select>
                </div>
              </div>
            </div>

            {{!-- TAB 2: PROFESSIONAL DETAILS --}}
            <div class="tab-pane fade" id="tab-job" role="tabpanel">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Business <span class="text-danger">*</span></label>
                  <select name="businessId" class="form-select" required>
                    <option value="">Select Business</option>
                    {{#each businesses}}
                    <option value="{{id}}">{{businessName}}</option>
                    {{/each}}
                  </select>
                  <small class="text-muted">
                    Select the business this employee belongs to
                  </small>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Employee Code / ID (optional)</label>
                  <input type="text" name="empId" class="form-control" />
                  <small class="text-muted">
                    Leave blank to autogenerate (EMP0001…)
                  </small>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Employee Type<span class="text-danger">*</span></label>
                  <select name="employeeType" class="form-select" required>
                    <option value="New Candidate">New Candidate</option>
                    <option value="Permanent">Permanent</option>
                    <option value="Contract">Contract</option>
                    <option value="Intern">Intern</option>
                    <option value="Consultant">Consultant</option>
                    <option value="Trainee">Trainee</option>
                  </select>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Employment Status</label>
                  <select name="employmentStatus" class="form-select">
                    <option value="Active">Active</option>
                    <option value="On Leave">On Leave</option>
                    <option value="Resigned">Resigned</option>
                    <option value="Terminated">Terminated</option>
                    <option value="Retired">Retired</option>
                  </select>
                </div>

                <div class="col-md-6">
                  <label class="form-label">
                    Department <span class="text-danger">*</span>
                  </label>
                  <select name="empDepartment" class="form-select" required>
                    <option value="">Select Department</option>
                    {{#each departments}}
                      <option value="{{name}}">{{name}}</option>
                    {{/each}}
                  </select>
                </div>

                <div class="col-md-6">
                  <label class="form-label">
                    Designation / Job Title <span class="text-danger">*</span>
                  </label>
                  <select name="empDesignation" class="form-select" required>
                    <option value="">Select Designation</option>
                    {{#each designations}}
                      <option value="{{name}}">{{name}}</option>
                    {{/each}}
                  </select>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Division / Business Unit</label>
                  <input type="text" name="division" class="form-control" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Sub-Department / Team</label>
                  <input type="text" name="subDepartment" class="form-control" />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Grade / Band / Level</label>
                  <input type="text" name="gradeBandLevel" class="form-control" />
                </div>

                <div class="col-md-4">
                  <label class="form-label">
                    Reporting Manager (Employee ID / Ref)
                  </label>
                  <select name="reportingManagerId" class="form-select">
                    <option value="">Select Manager</option>
                    {{#each employees}}
                      <option value="{{id}}">{{empName}}</option>
                    {{/each}}
                  </select>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Work Mode<span class="text-danger">*</span></label>
                  <select name="workMode" class="form-select">
                    <option value="On-site">On-site</option>
                    <option value="Hybrid">Hybrid</option>
                    <option value="Remote">Remote</option>
                  </select>
                </div>

                <div class="col-md-4">
                  <label class="form-label">
                    Work Location / Branch <span class="text-danger">*</span>
                  </label>
                  {{!-- <input type="text" name="empWorkLoc" class="form-control" required /> --}}
                  <select name="empWorkLoc" class="form-control" required>
                        <option value="">Select Location</option>
                        {{#each businessAddresses}}
                        <option value="{{fullAddress}}">{{addressName}}</option>
                        {{/each}}
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">
                    Joining Date <span class="text-danger">*</span>
                  </label>
                  <input
                    type="date"
                    name="empDateOfJoining"
                    class="form-control"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Probation Period (months)</label>
                  <input
                    type="number"
                    name="probationPeriodMonths"
                    class="form-control"
                    min="0"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Confirmation Date</label>
                  <input type="date" name="confirmationDate" class="form-control" />
                </div>
              </div>
            </div>

            {{!-- TAB 3: COMPENSATION --}}
            <div class="tab-pane fade" id="tab-comp" role="tabpanel">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">
                    CTC (₹ - Annual) <span class="text-danger">*</span>
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    name="empCtc"
                    class="form-control"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Gross Salary (Monthly)</label>
                  <input
                    type="number"
                    step="0.01"
                    name="grossSalaryMonthly"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Basic Salary</label>
                  <input
                    type="number"
                    step="0.01"
                    name="basicSalary"
                    class="form-control"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">House Rent Allowance (HRA)</label>
                  <input
                    type="number"
                    step="0.01"
                    name="hra"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Conveyance Allowance</label>
                  <input
                    type="number"
                    step="0.01"
                    name="conveyanceAllowance"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Medical Allowance</label>
                  <input
                    type="number"
                    step="0.01"
                    name="medicalAllowance"
                    class="form-control"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Special Allowance / Other</label>
                  <input
                    type="number"
                    step="0.01"
                    name="specialAllowance"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Performance Bonus</label>
                  <input
                    type="number"
                    step="0.01"
                    name="performanceBonus"
                    class="form-control"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Variable Pay</label>
                  <input
                    type="number"
                    step="0.01"
                    name="variablePay"
                    class="form-control"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Overtime Eligibility</label>
                  <select name="overtimeEligible" class="form-select">
                    <option value="false">No</option>
                    <option value="true">Yes</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">
                    Shift Allowance / Night Allowance
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    name="shiftAllowance"
                    class="form-control"
                  />
                </div>

                <div class="col-12">
                  <hr />
                  <h6>Deductions</h6>
                </div>

                <div class="col-md-3">
                  <label class="form-label">PF</label>
                  <input
                    type="number"
                    step="0.01"
                    name="pfDeduction"
                    class="form-control"
                  />
                </div>
                <div class="col-md-3">
                  <label class="form-label">ESI</label>
                  <input
                    type="number"
                    step="0.01"
                    name="esiDeduction"
                    class="form-control"
                  />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Professional Tax</label>
                  <input
                    type="number"
                    step="0.01"
                    name="professionalTax"
                    class="form-control"
                  />
                </div>
                <div class="col-md-3">
                  <label class="form-label">TDS</label>
                  <input
                    type="number"
                    step="0.01"
                    name="tdsDeduction"
                    class="form-control"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Net Salary (In-hand)</label>
                  <input
                    type="number"
                    step="0.01"
                    name="netSalary"
                    class="form-control"
                  />
                </div>
              </div>
            </div>

            {{!-- TAB 4: EDUCATION & QUALIFICATION --}}
            <div class="tab-pane fade" id="tab-education" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Education Entries</h6>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  id="addEducationRowBtn"
                >
                  <i class="fas fa-plus me-1"></i> Add Education
                </button>
              </div>

              <div id="educationRows" class="row g-3">
                {{!-- One template row --}}
                <div class="education-row border rounded p-3 mb-2">
                  <div class="row g-3">
                    <div class="col-md-3">
                      <label class="form-label">Highest Qualification</label>
                      <select class="form-select edu_level">
                        <option value="">Select</option>
                        <option value="10th">10th</option>
                        <option value="12th">12th</option>
                        <option value="Diploma">Diploma</option>
                        <option value="Bachelors">Bachelors</option>
                        <option value="Masters">Masters</option>
                        <option value="Doctorate">Doctorate</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Degree / Course Name</label>
                      <input
                        type="text"
                        class="form-control edu_degree"
                        placeholder="e.g. B.Tech in CSE"
                      />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Specialization / Major</label>
                      <input
                        type="text"
                        class="form-control edu_specialization"
                      />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Institution Name</label>
                      <input
                        type="text"
                        class="form-control edu_institutionName"
                      />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Board (for school)</label>
                      <input type="text" class="form-control edu_board" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Start Year</label>
                      <input type="number" class="form-control edu_startYear" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">End Year</label>
                      <input type="number" class="form-control edu_endYear" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Year of Passing</label>
                      <input
                        type="number"
                        class="form-control edu_yearOfPassing"
                      />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Percentage / CGPA</label>
                      <input
                        type="text"
                        class="form-control edu_percentageOrCgpa"
                      />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Mode of Study</label>
                      <select class="form-select edu_modeOfStudy">
                        <option value="">Select</option>
                        <option value="Full-Time">Full-Time</option>
                        <option value="Part-Time">Part-Time</option>
                        <option value="Distance">Distance</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Education Type</label>
                      <select class="form-select edu_educationType">
                        <option value="">Select</option>
                        <option value="School">School</option>
                        <option value="College">College</option>
                        <option value="Professional">Professional</option>
                        <option value="Technical">Technical</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Country</label>
                      {{!-- <input type="text" class="form-control edu_country" /> --}}
                      <select name="edu_country" class="form-control edu_country">
                        <option value="">Select Country</option>
                        {{#each countries}}
                        <option value="{{name}}">{{name}}</option>
                        {{/each}}
                  </select>

                    </div>
                    <div class="col-md-3">
                      <label class="form-label">City</label>
                      <input type="text" class="form-control edu_city" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Google drive link : Certificate/Marksheet/Migration </label>
                      <input type="text" class="form-control edu_certificateUrl" placeholder="https://..." />
                      <label class="form-label">
                        Certificate / Marksheet URL
                      </label>
                      <input
                        type="text"
                        class="form-control edu_certificateUrl"
                        placeholder="https://..."
                      />
                    </div>
                    <div class="col-md-2 d-flex align-items-end justify-content-end">
                      <button
                        type="button"
                        class="btn btn-outline-danger btn-sm remove-education-row-btn"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {{!-- TAB 5: EXPERIENCE --}}
            <div class="tab-pane fade" id="tab-experience" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Employment History</h6>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  id="addExperienceRowBtn"
                >
                  <i class="fas fa-plus me-1"></i> Add Experience
                </button>
              </div>

              <div id="experienceRows" class="row g-3">
    <div class="experience-row border rounded p-3 mb-2">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Organization / Company Name</label>
        <input
          type="text"
          class="form-control exp_organizationName"
        />
      </div>
      <div class="col-md-4">
        <label class="form-label">Designation / Job Title</label>
        <input type="text" class="form-control exp_jobTitle" />
      </div>
      <div class="col-md-4">
        <label class="form-label">Employment Type</label>
        <select class="form-select exp_employmentType">
          <option value="">Select</option>
          <option value="Full-Time">Full-Time</option>
          <option value="Part-Time">Part-Time</option>
          <option value="Contract">Contract</option>
          <option value="Internship">Internship</option>
          <option value="Freelance">Freelance</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Department / Division</label>
        <input type="text" class="form-control exp_department" />
      </div>
      <div class="col-md-4">
        <label class="form-label">Industry Type</label>
        <input type="text" class="form-control exp_industryType" />
      </div>
      <div class="col-md-2">
        <label class="form-label">City</label>
        <input
          type="text"
          class="form-control exp_companyLocationCity"
        />
      </div>
      <div class="col-md-2">
        <label class="form-label">Country</label>
        {{!-- <input
          type="text"
          class="form-control exp_companyLocationCountry"
        /> --}}
        <select name="exp_companyLocationCountry" class="form-control exp_companyLocationCountry">
                        <option value="">Select Country</option>
                        {{#each countries}}
                        <option value="{{name}}">{{name}}</option>
                        {{/each}}
                      </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Start Date</label>
        <input type="date" class="form-control exp_startDate" />
      </div>
      <div class="col-md-3">
        <label class="form-label">End Date</label>
        <input type="date" class="form-control exp_endDate" />
      </div>
      <div class="col-md-3 d-flex align-items-center">
        <div class="form-check mt-3">
          <input
            type="checkbox"
            class="form-check-input exp_isCurrent"
          />
          <label class="form-check-label">
            Present (currently working)
          </label>
        </div>
      </div>
      <div class="col-md-3">
        <label class="form-label">
          Last Drawn Salary / CTC
        </label>
        <input
          type="number"
          step="0.01"
          class="form-control exp_lastDrawnCtc"
        />
      </div>

      <div class="col-md-4">
        <label class="form-label">Reason for Leaving</label>
        {{!-- <input
          type="text"
          class="form-control exp_reasonForLeaving"
        /> --}}
        <textarea
          class="form-control exp_reasonForLeaving"
          rows="2"
        ></textarea>
      </div>
      <div class="col-md-3 d-flex align-items-center">
        <div class="form-check mt-3">
          <input
            type="checkbox"
            class="form-check-input exp_noticePeriodServed"
          />
          <label class="form-check-label">
            Notice Period Served
          </label>
        </div>
      </div>

      {{!-- NEW: Supporting document URLs --}}
      <div class="col-12">
        <hr />
        <h6 class="mb-2">Supporting Documents (URLs)</h6>
      </div>

      <div class="col-md-4">
        <label class="form-label">Relieving Letter URL</label>
        <input
          type="text"
          class="form-control exp_relievingLetterUrl"
          placeholder="https://... (Relieving letter)"
        />
      </div>

      <div class="col-md-4">
        <label class="form-label">Last 3 Months Salary Slips URL</label>
        <input
          type="text"
          class="form-control exp_salarySlipsUrl"
          placeholder="https://... (3 months salary slips)"
        />
      </div>

      <div class="col-md-4">
        <label class="form-label">Bank Statement URL</label>
        <input
          type="text"
          class="form-control exp_bankStatementUrl"
          placeholder="https://... (Bank statement)"
        />
      </div>

      <div class="col-md-2 d-flex align-items-end justify-content-end">
        <button
          type="button"
          class="btn btn-outline-danger btn-sm remove-experience-row-btn"
        >
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
    </div>
</div>

            </div>

            {{!-- TAB 6: DOCUMENTS & KYC --}}
            <div class="tab-pane fade" id="tab-documents" role="tabpanel">
              {{!-- Aadhaar / PAN removed from here (only via documents now) --}}

              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Employee Documents &amp; KYC</h6>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  id="addDocumentRowBtn"
                >
                  <i class="fas fa-plus me-1"></i> Add Document
                </button>
              </div>

              <div id="documentRows" class="row g-3">
                <div class="document-row border rounded p-3 mb-2">
                  <div class="row g-3">
                    <div class="col-md-3">
                      <label class="form-label">Category</label>
                      <select class="form-select doc_category">
                        <option value="KYC">KYC</option>
                        <option value="RESUME">Resume</option>
                        <option value="AADHAAR">Aadhaar</option>
                        <option value="PAN">PAN</option>
                        <option value="ADDRESS">Address Proof</option>
                        <option value="EDUCATION">Education</option>
                        <option value="EXPERIENCE">Experience</option>
                        <option value="HR">HR Letters</option>
                        <option value="OTHER">Other</option>
                        
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Document Type</label>
                      <input
                        type="text"
                        class="form-control doc_documentType"
                        placeholder="Aadhaar Card, PAN Card, Passport, 10th Marksheet, Offer Letter..."
                      />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Name as per Document</label>
                      <input
                        type="text"
                        class="form-control doc_nameOnDocument"
                      />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Document Number</label>
                      <input
                        type="text"
                        class="form-control doc_documentNumber"
                      />
                    </div>

                    <div class="col-md-3">
                      <label class="form-label">Issue Date</label>
                      <input type="date" class="form-control doc_issueDate" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Expiry Date</label>
                      <input type="date" class="form-control doc_expiryDate" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Verification Status</label>
                      <select class="form-select doc_verificationStatus">
                        <option value="Pending">Pending</option>
                        <option value="Verified">Verified</option>
                        <option value="Rejected">Rejected</option>
                      </select>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">File URL (PDF / Doc)</label>
                      <input
                        type="text"
                        class="form-control doc_fileUrl"
                        placeholder="/uploads/documents/... or https://..."
                      />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Document Image URL</label>
                      <input
                        type="text"
                        class="form-control doc_documentImageUrl"
                        placeholder="Scanned image URL/path"
                      />
                    </div>

                    <div class="col-md-10">
                      <label class="form-label">Notes</label>
                      <textarea
                        class="form-control doc_notes"
                        rows="2"
                      ></textarea>
                    </div>
                    <div class="col-md-2 d-flex align-items-end justify-content-end">
                      <button
                        type="button"
                        class="btn btn-outline-danger btn-sm remove-document-row-btn"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

            </div>{{!-- end tab-documents --}}
          </div>{{!-- end tab-content --}}
        </div>{{!-- end modal-body --}}

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">
            Cancel
          </button>

          {{!-- Wizard buttons --}}
          <button class="btn btn-primary" type="button" id="wizardNextBtn">
            Next
          </button>
          <button
            class="btn btn-primary d-none"
            type="submit"
            id="wizardSaveBtn"
          >
            Save Employee
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{{!-- View Employee Modal --}}
<div class="modal fade" id="viewEmployeeModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content view-emp-modal-content">
      <div class="modal-header view-emp-modal-header">
        <div class="view-emp-header-content">
          <div class="view-emp-avatar" id="viewEmpAvatar">
            <span id="viewEmpInitials"></span>
          </div>
          <div class="view-emp-header-text">
            <h5 class="modal-title view-emp-title" id="viewEmpNameTitle">Employee Details</h5>
            <div class="view-emp-chips">
              <span class="view-emp-chip" id="viewEmpIdChip">
                <i class="fas fa-id-card"></i>
                <span id="viewEmpId"></span>
              </span>
              <span class="view-emp-chip" id="viewEmpEmailChip">
                <i class="fas fa-envelope"></i>
                <span id="viewEmpEmail"></span>
              </span>
              <span class="view-emp-chip" id="viewEmpPhoneChip">
                <i class="fas fa-phone"></i>
                <span id="viewEmpPhone"></span>
              </span>
            </div>
          </div>
        </div>
        <button type="button" class="btn-close view-emp-close-btn" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body view-emp-modal-body">
        <div class="view-emp-grid">
          <!-- Personal Details Card -->
          <div class="view-emp-section-card">
            <div class="view-emp-card-header">
              <i class="fas fa-user"></i>
              <h6 class="view-emp-card-title">Personal Details</h6>
            </div>
            <div class="view-emp-card-body">
              <dl class="row view-emp-dl" id="viewPersonalDetails"></dl>
            </div>
          </div>

          <!-- Emergency Contact Card -->
          <div class="view-emp-section-card">
            <div class="view-emp-card-header">
              <i class="fas fa-phone-alt"></i>
              <h6 class="view-emp-card-title">Emergency Contact</h6>
            </div>
            <div class="view-emp-card-body">
              <dl class="row view-emp-dl" id="viewEmergencyContactDetails"></dl>
            </div>
          </div>

          <!-- Present Address Card -->
          <div class="view-emp-section-card">
            <div class="view-emp-card-header">
              <i class="fas fa-map-marker-alt"></i>
              <h6 class="view-emp-card-title">Present Address</h6>
            </div>
            <div class="view-emp-card-body">
              <dl class="row view-emp-dl" id="viewPresentAddressDetails"></dl>
            </div>
          </div>

          <!-- Permanent Address Card -->
          <div class="view-emp-section-card">
            <div class="view-emp-card-header">
              <i class="fas fa-map-pin"></i>
              <h6 class="view-emp-card-title">Permanent Address</h6>
            </div>
            <div class="view-emp-card-body">
              <dl class="row view-emp-dl" id="viewPermanentAddressDetails"></dl>
            </div>
          </div>

          <!-- Professional Details Card -->
          <div class="view-emp-section-card">
            <div class="view-emp-card-header">
              <i class="fas fa-briefcase"></i>
              <h6 class="view-emp-card-title">Professional Details</h6>
            </div>
            <div class="view-emp-card-body">
              <dl class="row view-emp-dl" id="viewProfessionalDetails"></dl>
            </div>
          </div>

          <!-- Compensation Card -->
          <div class="view-emp-section-card">
            <div class="view-emp-card-header">
              <i class="fas fa-money-bill-wave"></i>
              <h6 class="view-emp-card-title">Compensation</h6>
            </div>
            <div class="view-emp-card-body">
              <dl class="row view-emp-dl" id="viewCompensationDetails"></dl>
            </div>
          </div>

          <!-- Education Card -->
          <div class="view-emp-section-card view-emp-section-card-full">
            <div class="view-emp-card-header">
              <i class="fas fa-graduation-cap"></i>
              <h6 class="view-emp-card-title">Education &amp; Qualification</h6>
            </div>
            <div class="view-emp-card-body" id="viewEducationList"></div>
          </div>

          <!-- Experience Card -->
          <div class="view-emp-section-card view-emp-section-card-full">
            <div class="view-emp-card-header">
              <i class="fas fa-briefcase"></i>
              <h6 class="view-emp-card-title">Experience / Employment History</h6>
            </div>
            <div class="view-emp-card-body" id="viewExperienceList"></div>
          </div>

          <!-- Documents Card -->
          <div class="view-emp-section-card view-emp-section-card-full">
            <div class="view-emp-card-header">
              <i class="fas fa-file-alt"></i>
              <h6 class="view-emp-card-title">Documents &amp; KYC</h6>
            </div>
            <div class="view-emp-card-body" id="viewDocumentList"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer view-emp-modal-footer">
        <button class="btn btn-secondary view-emp-close-btn" type="button" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    // =========================
    // Wizard: steps (6 tabs)
    // =========================
    const steps = [
      "tab-basic",
      "tab-job",
      "tab-comp",
      "tab-education",
      "tab-experience",
      "tab-documents",
    ];

    let currentStep = 0;
    const nextBtn = document.getElementById("wizardNextBtn");
    const saveBtn = document.getElementById("wizardSaveBtn");
    const tabsContainer = document.getElementById("addEmployeeTabs");
    const modalEl = document.getElementById("addEmployeeModal");
    const addEmployeeForm = document.getElementById("addEmployeeForm");
    const employeeIdField = document.getElementById("employeeIdField");
    const addEmployeeModalTitle = document.getElementById("addEmployeeModalTitle");

    let formMode = "create"; // 'create' or 'edit'
    let currentEditingId = null;

    function updateWizardButtons() {
      if (!nextBtn || !saveBtn) return;

      if (currentStep === steps.length - 1) {
        nextBtn.classList.add("d-none");
        saveBtn.classList.remove("d-none");
      } else {
        nextBtn.classList.remove("d-none");
        saveBtn.classList.add("d-none");
      }

      // Also enforce required-field validation state
      updateWizardValidity();
    }

    // =======================================
    // Required-field validation (based on red asterisk)
    // Wherever a label contains a red "*" marker, the associated control becomes required.
    // "Next" is disabled until required fields in the current tab are filled.
    // "Save" is disabled until required fields in ALL tabs are filled.
    // =======================================

    function isElementVisible(el) {
      if (!el) return false;
      if (el.type === "hidden") return false;
      if (el.disabled) return false;
      // if inside collapsed/hidden tab-pane, offsetParent may be null
      const style = window.getComputedStyle(el);
      if (style.display === "none" || style.visibility === "hidden") return false;
      // If any ancestor is display:none, getClientRects() will be empty
      if (el.getClientRects().length === 0) return false;
      return true;
    }

    function controlHasValue(el) {
      if (!el) return false;
      if (el.type === "checkbox") return el.checked === true;
      if (el.type === "radio") {
        const name = el.name;
        if (!name) return el.checked === true;
        return !!document.querySelector(`input[type="radio"][name="${CSS.escape(name)}"]:checked`);
      }
      if (el.type === "file") return (el.files && el.files.length > 0) || false;
      return String(el.value || "").trim() !== "";
    }

    function markAsteriskRequired(root) {
      if (!root) return;
      // Look for labels that contain a red asterisk marker
      root.querySelectorAll("label").forEach((label) => {
        const hasStar = !!label.querySelector(".text-danger");
        if (!hasStar) return;

        // Find the closest control in the same field container
        const fieldWrap = label.closest(".col, .col-12, .col-md-12, .col-md-6, .col-md-4, .col-md-3, .col-lg-6, .col-lg-4, .mb-3, .row") || label.parentElement;
        if (!fieldWrap) return;

        const control = fieldWrap.querySelector("input, select, textarea");
        if (!control) return;

        // Mark as required (idempotent)
        control.required = true;
        control.dataset.requiredByAsterisk = "true";
      });
    }

    function getTabPaneByStep(stepIdx) {
      const id = steps[stepIdx];
      return id ? document.getElementById(id) : null;
    }

    function validateTab(stepIdx, { markInvalid = false } = {}) {
      const pane = getTabPaneByStep(stepIdx);
      if (!pane) return true;

      // Gather required controls (native required OR asterisk-derived)
      const requiredControls = Array.from(
        pane.querySelectorAll("input[required], select[required], textarea[required], [data-required-by-asterisk='true']")
      ).filter((el) => isElementVisible(el));

      let ok = true;
      requiredControls.forEach((el) => {
        const filled = controlHasValue(el);
        if (!filled) ok = false;
        if (markInvalid) {
          el.classList.toggle("is-invalid", !filled);
        }
      });

      return ok;
    }

    function findFirstInvalidStep() {
      for (let i = 0; i < steps.length; i++) {
        if (!validateTab(i)) return i;
      }
      return -1;
    }

    function updateWizardValidity() {
      if (!nextBtn || !saveBtn) return;
      // Ensure asterisk-required mapping exists before validating
      if (modalEl) markAsteriskRequired(modalEl);

      const currentOk = validateTab(currentStep);
      const allOk = findFirstInvalidStep() === -1;

      // Next: current tab only
      nextBtn.disabled = !currentOk;
      // Save: all tabs
      saveBtn.disabled = !allOk;
    }

    function goToStep(index) {
      if (index < 0 || index >= steps.length) return;

      const targetId = steps[index];
      const trigger = document.querySelector(
        '[data-bs-target="#' + targetId + '"]'
      );

      if (trigger && window.bootstrap) {
        const tab = new bootstrap.Tab(trigger);
        tab.show();
      }
    }

    if (nextBtn) {
      nextBtn.addEventListener("click", function () {
        // Block moving forward if required fields (with red asterisk) aren't filled
        const ok = validateTab(currentStep, { markInvalid: true });
        updateWizardValidity();
        if (!ok) return;

        if (currentStep < steps.length - 1) {
          currentStep += 1;
          goToStep(currentStep);
          updateWizardButtons();
        }
      });
    }

    if (tabsContainer) {
      tabsContainer.addEventListener("shown.bs.tab", function (event) {
        const target = event.target.getAttribute("data-bs-target");
        if (!target) return;

        const id = target.replace("#", "");
        const idx = steps.indexOf(id);

        if (idx !== -1) {
          currentStep = idx;
          updateWizardButtons();
          updateWizardValidity();
        }
      });
    }

    if (modalEl) {
      modalEl.addEventListener("shown.bs.modal", function () {
        currentStep = 0;
        goToStep(currentStep);
        // map required fields and set initial button states
        markAsteriskRequired(modalEl);
        updateWizardButtons();
        updateWizardValidity();
      });

      // Live validation while user edits
      modalEl.addEventListener("input", function (e) {
        const t = e.target;
        if (t && (t.matches("input, select, textarea"))) {
          // remove invalid state as user edits
          if (t.classList.contains("is-invalid") && controlHasValue(t)) {
            t.classList.remove("is-invalid");
          }
          updateWizardValidity();
        }
      });
      modalEl.addEventListener("change", function () {
        updateWizardValidity();
      });
    }

    // =======================================
    // "Permanent same as present" helper
    // =======================================
    const sameAsPresentCheckbox = document.getElementById("sameAsPresent");

    if (sameAsPresentCheckbox) {
      sameAsPresentCheckbox.addEventListener("change", function () {
        if (!this.checked) return;

        const copyField = (from, to) => {
          const f = document.querySelector('[name="' + from + '"]');
          const t = document.querySelector('[name="' + to + '"]');
          if (f && t) t.value = f.value;
        };

        copyField("presentAddressLine1", "permanentAddressLine1");
        copyField("presentAddressLine2", "permanentAddressLine2");
        copyField("presentCity", "permanentCity");
        copyField("presentState", "permanentState");
        copyField("presentZip", "permanentZip");
        copyField("presentCountry", "permanentCountry");
      });
    }

    // =======================================
    // Dynamic rows: Education, Experience, Documents
    // =======================================
    const educationContainer = document.getElementById("educationRows");
    const experienceContainer = document.getElementById("experienceRows");
    const documentContainer = document.getElementById("documentRows");

    const addEducationRowBtn = document.getElementById("addEducationRowBtn");
    const addExperienceRowBtn = document.getElementById("addExperienceRowBtn");
    const addDocumentRowBtn = document.getElementById("addDocumentRowBtn");

    function clearInputsInRow(row) {
      row.querySelectorAll("input, select, textarea").forEach((el) => {
        if (el.type === "checkbox") {
          el.checked = false;
        } else {
          el.value = "";
        }
      });
    }

    function cloneRow(container, rowSelector) {
      const firstRow = container.querySelector(rowSelector);
      if (!firstRow) return;
      const clone = firstRow.cloneNode(true);
      clearInputsInRow(clone);
      container.appendChild(clone);
    }

    function resetDynamicSection(container, rowSelector) {
      if (!container) return;

      const rows = container.querySelectorAll(rowSelector);
      rows.forEach((row, idx) => {
        if (idx === 0) {
          clearInputsInRow(row);
        } else {
          row.remove();
        }
      });
    }

    // Education dynamic
    if (addEducationRowBtn && educationContainer) {
      addEducationRowBtn.addEventListener("click", function () {
        cloneRow(educationContainer, ".education-row");
      });

      educationContainer.addEventListener("click", function (e) {
        const removeBtn = e.target.closest(".remove-education-row-btn");
        if (removeBtn) {
          const row = e.target.closest(".education-row");
          if (
            educationContainer.querySelectorAll(".education-row").length > 1 &&
            row
          ) {
            row.remove();
          }
        }
      });
    }

    // Experience dynamic
    if (addExperienceRowBtn && experienceContainer) {
      addExperienceRowBtn.addEventListener("click", function () {
        cloneRow(experienceContainer, ".experience-row");
      });

      experienceContainer.addEventListener("click", function (e) {
        const removeBtn = e.target.closest(".remove-experience-row-btn");
        if (removeBtn) {
          const row = e.target.closest(".experience-row");
          if (
            experienceContainer.querySelectorAll(".experience-row").length > 1 &&
            row
          ) {
            row.remove();
          }
        }
      });
    }

    // Document dynamic
    if (addDocumentRowBtn && documentContainer) {
      addDocumentRowBtn.addEventListener("click", function () {
        cloneRow(documentContainer, ".document-row");
      });

      documentContainer.addEventListener("click", function (e) {
        const removeBtn = e.target.closest(".remove-document-row-btn");
        if (removeBtn) {
          const row = e.target.closest(".document-row");
          if (documentContainer.querySelectorAll(".document-row").length > 1 && row) {
            row.remove();
          }
        }
      });
    }

    function collectEducationRows() {
      const rows = [];

      document.querySelectorAll(".education-row").forEach((row) => {
        const obj = {
          level: row.querySelector(".edu_level")?.value || "",
          degree: row.querySelector(".edu_degree")?.value || "",
          specialization: row.querySelector(".edu_specialization")?.value || "",
          institutionName:
            row.querySelector(".edu_institutionName")?.value || "",
          board: row.querySelector(".edu_board")?.value || "",
          startYear: row.querySelector(".edu_startYear")?.value || "",
          endYear: row.querySelector(".edu_endYear")?.value || "",
          yearOfPassing:
            row.querySelector(".edu_yearOfPassing")?.value || "",
          percentageOrCgpa:
            row.querySelector(".edu_percentageOrCgpa")?.value || "",
          modeOfStudy: row.querySelector(".edu_modeOfStudy")?.value || "",
          educationType:
            row.querySelector(".edu_educationType")?.value || "",
          country: row.querySelector(".edu_country")?.value || "",
          city: row.querySelector(".edu_city")?.value || "",
          certificateUrl:
            row.querySelector(".edu_certificateUrl")?.value || "",
        };

        // Push only if some key fields are present
        if (obj.level || obj.degree || obj.institutionName) {
          rows.push(obj);
        }
      });

      return rows;
    }

    function collectExperienceRows() {
  const rows = [];

  document.querySelectorAll(".experience-row").forEach((row) => {
    const obj = {
      organizationName:
        row.querySelector(".exp_organizationName")?.value || "",
      jobTitle: row.querySelector(".exp_jobTitle")?.value || "",
      employmentType:
        row.querySelector(".exp_employmentType")?.value || "",
      department: row.querySelector(".exp_department")?.value || "",
      industryType: row.querySelector(".exp_industryType")?.value || "",
      companyLocationCity:
        row.querySelector(".exp_companyLocationCity")?.value || "",
      companyLocationCountry:
        row.querySelector(".exp_companyLocationCountry")?.value || "",
      startDate: row.querySelector(".exp_startDate")?.value || "",
      endDate: row.querySelector(".exp_endDate")?.value || "",
      isCurrent: row.querySelector(".exp_isCurrent")?.checked || false,
      lastDrawnCtc:
        row.querySelector(".exp_lastDrawnCtc")?.value || "",
      reasonForLeaving:
        row.querySelector(".exp_reasonForLeaving")?.value || "",
      noticePeriodServed:
        row.querySelector(".exp_noticePeriodServed")?.checked || false,

      // NEW: document URLs
      relievingLetterUrl:
        row.querySelector(".exp_relievingLetterUrl")?.value || "",
      salarySlipsUrl:
        row.querySelector(".exp_salarySlipsUrl")?.value || "",
      bankStatementUrl:
        row.querySelector(".exp_bankStatementUrl")?.value || "",
    };

    // Keep same condition – row considered valid if some core fields present
    if (obj.organizationName || obj.jobTitle) {
      rows.push(obj);
    }
  });

  return rows;
}

    function collectDocumentRows() {
      const rows = [];

      document.querySelectorAll(".document-row").forEach((row) => {
        const obj = {
          category: row.querySelector(".doc_category")?.value || "",
          documentType:
            row.querySelector(".doc_documentType")?.value || "",
          nameOnDocument:
            row.querySelector(".doc_nameOnDocument")?.value || "",
          documentNumber:
            row.querySelector(".doc_documentNumber")?.value || "",
          issueDate: row.querySelector(".doc_issueDate")?.value || "",
          expiryDate: row.querySelector(".doc_expiryDate")?.value || "",
          verificationStatus:
            row.querySelector(".doc_verificationStatus")?.value ||
            "Pending",
          fileUrl: row.querySelector(".doc_fileUrl")?.value || "",
          documentImageUrl:
            row.querySelector(".doc_documentImageUrl")?.value || "",
          notes: row.querySelector(".doc_notes")?.value || "",
        };

        if (
          obj.documentType ||
          obj.documentNumber ||
          obj.fileUrl ||
          obj.documentImageUrl
        ) {
          rows.push(obj);
        }
      });

      return rows;
    }

    // =======================================
    // Helper: reset entire form (for Add mode)
    // =======================================
    function resetEmployeeForm() {
      if (!addEmployeeForm) return;

      addEmployeeForm.reset();
      employeeIdField.value = "";

      if (sameAsPresentCheckbox) {
        sameAsPresentCheckbox.checked = false;
      }

      resetDynamicSection(educationContainer, ".education-row");
      resetDynamicSection(experienceContainer, ".experience-row");
      resetDynamicSection(documentContainer, ".document-row");

      // Reset gender dropdown display
      updateGenderDropdownDisplay();
    }

    // =======================================
    // Helper: populate form from employee data (Edit mode)
    // =======================================
    function fillBaseField(name, value) {
      if (!addEmployeeForm) return;

      const el = addEmployeeForm.elements[name];
      if (!el) return;

      if (el.type === "checkbox") {
        el.checked = !!value;
      } else {
        el.value = value != null ? value : "";
      }

      // Special handling for gender field to update custom dropdown display
      if (name === "gender") {
        updateGenderDropdownDisplay();
      }
    }

    // =======================================
    // Gender Dropdown with Icons - Custom UI
    // =======================================
    function getGenderIcon(value) {
      const icons = {
        "": '<i class="fas fa-circle-dot" style="color: #6b7280;"></i>',
        "Male": '<i class="fas fa-mars gender-icon-male"></i>',
        "Female": '<i class="fas fa-venus gender-icon-female"></i>',
        "Non-binary": '<i class="fas fa-transgender gender-icon-nonbinary"></i>',
        "Prefer not to say": '<i class="fas fa-circle-question gender-icon-prefer-not"></i>'
      };
      return icons[value] || icons[""];
    }

    function getGenderLabel(value) {
      return value || "Select";
    }

    function updateGenderDropdownDisplay() {
      const genderSelect = document.getElementById("genderSelect");
      const genderTrigger = document.getElementById("genderSelectTrigger");
      const genderDropdown = document.getElementById("genderSelectDropdown");

      if (!genderSelect || !genderTrigger || !genderDropdown) return;

      const selectedValue = genderSelect.value;
      const valueSpan = genderTrigger.querySelector(".gender-select-value");

      if (valueSpan) {
        // Rebuild the value span content with icon and text
        valueSpan.innerHTML = getGenderIcon(selectedValue) + 
          '<span class="gender-select-text">' + getGenderLabel(selectedValue) + '</span>';

        if (selectedValue) {
          genderTrigger.classList.remove("placeholder");
        } else {
          genderTrigger.classList.add("placeholder");
        }
      }

      // Update selected state in dropdown options
      const options = genderDropdown.querySelectorAll(".gender-option");
      options.forEach(opt => {
        if (opt.dataset.value === selectedValue) {
          opt.classList.add("selected");
        } else {
          opt.classList.remove("selected");
        }
      });
    }

    function initGenderDropdown() {
      const genderSelect = document.getElementById("genderSelect");
      const genderTrigger = document.getElementById("genderSelectTrigger");
      const genderDropdown = document.getElementById("genderSelectDropdown");
      const genderCustom = document.getElementById("genderSelectCustom");

      if (!genderSelect || !genderTrigger || !genderDropdown || !genderCustom) return;

      // Initialize display
      updateGenderDropdownDisplay();

      // Close dropdown when clicking outside
      document.addEventListener("click", function(e) {
        if (!genderCustom.contains(e.target)) {
          genderCustom.classList.remove("open");
        }
      });

      // Toggle dropdown on trigger click
      genderTrigger.addEventListener("click", function(e) {
        e.stopPropagation();
        e.preventDefault();
        genderCustom.classList.toggle("open");
      });

      // Handle option selection
      const options = genderDropdown.querySelectorAll(".gender-option");
      options.forEach(opt => {
        opt.addEventListener("click", function(e) {
          e.stopPropagation();
          const value = this.dataset.value;
          genderSelect.value = value;
          
          // Trigger change event on original select for form validation
          genderSelect.dispatchEvent(new Event("change", { bubbles: true }));
          
          updateGenderDropdownDisplay();
          genderCustom.classList.remove("open");
        });
      });

      // Sync custom display when original select changes (programmatically)
      genderSelect.addEventListener("change", function() {
        updateGenderDropdownDisplay();
      });
    }

    // Initialize gender dropdown when modal is shown
    const addEmployeeModalEl = document.getElementById("addEmployeeModal");
    if (addEmployeeModalEl) {
      addEmployeeModalEl.addEventListener("shown.bs.modal", function() {
        setTimeout(() => {
          initGenderDropdown();
        }, 100);
      });

      // Also initialize on tab switch (Personal Details tab)
      const basicTab = document.getElementById("basic-tab");
      if (basicTab) {
        basicTab.addEventListener("shown.bs.tab", function() {
          setTimeout(() => {
            initGenderDropdown();
          }, 100);
        });
      }
    }

    function setEducationRows(educations) {
      resetDynamicSection(educationContainer, ".education-row");
      if (!educationContainer) return;
      if (!Array.isArray(educations) || educations.length === 0) return;

      const firstRow = educationContainer.querySelector(".education-row");
      if (!firstRow) return;

      educations.forEach((edu, index) => {
        let row = firstRow;
        if (index > 0) {
          row = firstRow.cloneNode(true);
          clearInputsInRow(row);
          educationContainer.appendChild(row);
        }

        row.querySelector(".edu_level").value = edu.level || "";
        row.querySelector(".edu_degree").value = edu.degree || "";
        row.querySelector(".edu_specialization").value =
          edu.specialization || "";
        row.querySelector(".edu_institutionName").value =
          edu.institutionName || "";
        row.querySelector(".edu_board").value = edu.board || "";
        row.querySelector(".edu_startYear").value = edu.startYear || "";
        row.querySelector(".edu_endYear").value = edu.endYear || "";
        row.querySelector(".edu_yearOfPassing").value =
          edu.yearOfPassing || "";
        row.querySelector(".edu_percentageOrCgpa").value =
          edu.percentageOrCgpa || "";
        row.querySelector(".edu_modeOfStudy").value =
          edu.modeOfStudy || "";
        row.querySelector(".edu_educationType").value =
          edu.educationType || "";
        row.querySelector(".edu_country").value = edu.country || "";
        row.querySelector(".edu_city").value = edu.city || "";
        row.querySelector(".edu_certificateUrl").value =
          edu.certificateUrl || "";
      });
    }

    function setExperienceRows(experiences) {
      resetDynamicSection(experienceContainer, ".experience-row");
      if (!experienceContainer) return;
      if (!Array.isArray(experiences) || experiences.length === 0) return;

      const firstRow = experienceContainer.querySelector(".experience-row");
      if (!firstRow) return;

      experiences.forEach((exp, index) => {
        let row = firstRow;
        if (index > 0) {
          row = firstRow.cloneNode(true);
          clearInputsInRow(row);
          experienceContainer.appendChild(row);
        }

        row.querySelector(".exp_organizationName").value =
          exp.organizationName || "";
        row.querySelector(".exp_jobTitle").value = exp.jobTitle || "";
        row.querySelector(".exp_employmentType").value =
          exp.employmentType || "";
        row.querySelector(".exp_department").value = exp.department ||    "";
        row.querySelector(".exp_industryType").value =
          exp.industryType || "";
        row.querySelector(".exp_companyLocationCity").value =
          exp.companyLocationCity || "";
        row.querySelector(".exp_companyLocationCountry").value =
          exp.companyLocationCountry || "";
        row.querySelector(".exp_startDate").value = exp.startDate || "";
        row.querySelector(".exp_endDate").value = exp.endDate || "";
        row.querySelector(".exp_isCurrent").checked = !!exp.isCurrent;
        row.querySelector(".exp_lastDrawnCtc").value =
          exp.lastDrawnCtc || "";
        row.querySelector(".exp_reasonForLeaving").value =
          exp.reasonForLeaving || "";
        row.querySelector(".exp_noticePeriodServed").checked =
          !!exp.noticePeriodServed;

        // NEW: document URLs
        row.querySelector(".exp_relievingLetterUrl").value =
          exp.relievingLetterUrl || "";
        row.querySelector(".exp_salarySlipsUrl").value =
      exp.salarySlipsUrl || "";
        row.querySelector(".exp_bankStatementUrl").value =
      exp.bankStatementUrl || "";
      });
    }

    function setDocumentRows(documents) {
      resetDynamicSection(documentContainer, ".document-row");
      if (!documentContainer) return;
      if (!Array.isArray(documents) || documents.length === 0) return;

      const firstRow = documentContainer.querySelector(".document-row");
      if (!firstRow) return;

      documents.forEach((doc, index) => {
        let row = firstRow;
        if (index > 0) {
          row = firstRow.cloneNode(true);
          clearInputsInRow(row);
          documentContainer.appendChild(row);
        }

        row.querySelector(".doc_category").value = doc.category || "KYC";
        row.querySelector(".doc_documentType").value =
          doc.documentType || "";
        row.querySelector(".doc_nameOnDocument").value =
          doc.nameOnDocument || "";
        row.querySelector(".doc_documentNumber").value =
          doc.documentNumber || "";
        row.querySelector(".doc_issueDate").value = doc.issueDate || "";
        row.querySelector(".doc_expiryDate").value = doc.expiryDate || "";
        row.querySelector(".doc_verificationStatus").value =
          doc.verificationStatus || "Pending";
        row.querySelector(".doc_fileUrl").value = doc.fileUrl || "";
        row.querySelector(".doc_documentImageUrl").value =
          doc.documentImageUrl || "";
        row.querySelector(".doc_notes").value = doc.notes || "";
      });
    }

    // =======================================
    // Open Add Employee in Create mode
    // =======================================
    const openAddEmployeeModalBtn = document.getElementById(
      "openAddEmployeeModalBtn"
    );

    if (openAddEmployeeModalBtn) {
      openAddEmployeeModalBtn.addEventListener("click", function () {
        formMode = "create";
        currentEditingId = null;

        if (addEmployeeModalTitle) {
          addEmployeeModalTitle.textContent = "Add Employee";
        }

        resetEmployeeForm();
      });
    }

    // =======================================
    // Form submit logic (Create / Edit)
    // =======================================
    if (addEmployeeForm) {
      addEmployeeForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        // Block submit until required asterisk fields are filled across all tabs
        updateWizardValidity();
        const firstBad = findFirstInvalidStep();
        if (firstBad !== -1) {
          // Jump to first invalid tab and highlight missing fields
          goToStep(firstBad);
          currentStep = firstBad;
          updateWizardButtons();
          validateTab(firstBad, { markInvalid: true });
          updateWizardValidity();
          alert("Please fill all required fields (*) before saving.");
          return;
        }

        const formData = new FormData(addEmployeeForm);
        const base = Object.fromEntries(formData.entries());

        // Remove id from base; for edit we use URL param
        delete base.id;

        base.educations = collectEducationRows();
        base.experiences = collectExperienceRows();
        base.documents = collectDocumentRows();

        let url = "/api/v1/employees";
        let method = "POST";

        if (formMode === "edit" && currentEditingId) {
          url = "/api/v1/employees/" + currentEditingId;
          method = "PUT";
        }

        try {
          const res = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(base),
          });

          if (!res.ok) {
            let err;
            try {
              err = await res.json();
            } catch (e) {
              err = {};
            }
            throw new Error(err.error || "Failed to save employee");
          }

          window.location.reload();
        } catch (error) {
          alert(error.message);
        }
      });
    }

    // =======================================
    // VIEW / EDIT / DELETE BUTTON HANDLERS
    // =======================================
    function escapeHtml(str) {
      if (str == null) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function renderKeyValueList(containerId, entries) {
      const container = document.getElementById(containerId);
      if (!container) return;

      container.innerHTML = "";
      entries.forEach(([label, value]) => {
        // Skip empty values
        if (!value || (typeof value === 'string' && value.trim() === '')) {
          return;
        }
        const val = value != null && value !== "" ? value : "-";
        container.insertAdjacentHTML(
          "beforeend",
          '<dt class="col-sm-4 text-muted">' +
            escapeHtml(label) +
            "</dt>" +
            '<dd class="col-sm-8">' +
            escapeHtml(String(val)) +
            "</dd>"
        );
      });
    }

    async function fetchEmployee(id) {
      const res = await fetch("/api/v1/employees/" + id);
      if (!res.ok) {
        let err;
        try {
          err = await res.json();
        } catch (e) {
          err = {};
        }
        throw new Error(err.error || "Failed to fetch employee");
      }
      return res.json();
    }

    async function openViewEmployeeModal(id) {
      try {
        const emp = await fetchEmployee(id);

        const fullName = emp.empName || (emp.firstName + " " + (emp.lastName || ""));
        const initials = (emp.firstName ? emp.firstName[0] : '') + (emp.lastName ? emp.lastName[0] : '');

        const viewEmpInitials = document.getElementById("viewEmpInitials");
        const viewEmpNameTitle = document.getElementById("viewEmpNameTitle");
        const viewEmpId = document.getElementById("viewEmpId");
        const viewEmpEmail = document.getElementById("viewEmpEmail");
        const viewEmpPhone = document.getElementById("viewEmpPhone");

        if (viewEmpInitials) {
          viewEmpInitials.textContent = initials;
        }
        if (viewEmpNameTitle) {
          viewEmpNameTitle.textContent = fullName;
        }
        if (viewEmpId) {
          viewEmpId.textContent = emp.empId || "-";
        }
        if (viewEmpEmail) {
          viewEmpEmail.textContent = emp.empEmail || "-";
        }
        if (viewEmpPhone) {
          viewEmpPhone.textContent = emp.empPhone || "-";
        }

        // Show/hide chips based on data presence
        const viewEmpIdChip = document.getElementById("viewEmpIdChip");
        const viewEmpEmailChip = document.getElementById("viewEmpEmailChip");
        const viewEmpPhoneChip = document.getElementById("viewEmpPhoneChip");

        if (viewEmpIdChip) {
          if (!emp.empId) viewEmpIdChip.style.display = "none";
          else viewEmpIdChip.style.display = "inline-flex";
        }
        if (viewEmpEmailChip) {
          if (!emp.empEmail) viewEmpEmailChip.style.display = "none";
          else viewEmpEmailChip.style.display = "inline-flex";
        }
        if (viewEmpPhoneChip) {
          if (!emp.empPhone) viewEmpPhoneChip.style.display = "none";
          else viewEmpPhoneChip.style.display = "inline-flex";
        }

        renderKeyValueList("viewPersonalDetails", [
          ["Gender", emp.gender],
          ["Marital Status", emp.maritalStatus],
          ["Date of Birth", emp.empDob],
          ["Blood Group", emp.bloodGroup],
          ["Nationality", emp.nationality],
          ["Religion", emp.religion],
          ["Category / Caste", emp.casteCategory],
          ["Languages Known", emp.languagesKnown],
        ]);

        renderKeyValueList("viewEmergencyContactDetails", [
          ["Name", emp.emergencyContactName],
          ["Relation", emp.emergencyContactRelation],
          ["Number", emp.emergencyContactNumber],
        ]);

        renderKeyValueList("viewPresentAddressDetails", [
          ["Line 1", emp.presentAddressLine1],
          ["Line 2", emp.presentAddressLine2],
          ["City", emp.presentCity],
          ["State", emp.presentState],
          ["ZIP", emp.presentZip],
          ["Country", emp.presentCountry],
        ]);

        renderKeyValueList("viewPermanentAddressDetails", [
          ["Same as Present", emp.permanentSameAsPresent ? "Yes" : "No"],
          ["Line 1", emp.permanentAddressLine1],
          ["Line 2", emp.permanentAddressLine2],
          ["City", emp.permanentCity],
          ["State", emp.permanentState],
          ["ZIP", emp.permanentZip],
          ["Country", emp.permanentCountry],
        ]);

        renderKeyValueList("viewProfessionalDetails", [
          ["Employee Type", emp.employeeType],
          ["Employment Status", emp.employmentStatus],
          ["Department", emp.empDepartment],
          ["Designation / Job Title", emp.empDesignation],
          ["Division / Business Unit", emp.division],
          ["Sub-Department / Team", emp.subDepartment],
          ["Grade / Band / Level", emp.gradeBandLevel],
          ["Reporting Manager ID", emp.reportingManagerId],
          ["Work Mode", emp.workMode],
          ["Work Location / Branch", emp.empWorkLoc],
          ["Date of Joining", emp.empDateOfJoining],
          ["Probation Period (months)", emp.probationPeriodMonths],
          ["Confirmation Date", emp.confirmationDate],
        ]);

        renderKeyValueList("viewCompensationDetails", [
          ["CTC (₹ - Annual)", emp.empCtc],
          ["Gross Salary (Monthly)", emp.grossSalaryMonthly],
          ["Basic Salary", emp.basicSalary],
          ["HRA", emp.hra],
          ["Conveyance Allowance", emp.conveyanceAllowance],
          ["Medical Allowance", emp.medicalAllowance],
          ["Special Allowance", emp.specialAllowance],
          ["Performance Bonus", emp.performanceBonus],
          ["Variable Pay", emp.variablePay],
          ["Overtime Eligible", emp.overtimeEligible ? "Yes" : "No"],
          ["Shift Allowance", emp.shiftAllowance],
          ["PF Deduction", emp.pfDeduction],
          ["ESI Deduction", emp.esiDeduction],
          ["Professional Tax", emp.professionalTax],
          ["TDS Deduction", emp.tdsDeduction],
          ["Net Salary", emp.netSalary],
        ]);

        const eduContainer = document.getElementById("viewEducationList");
        if (eduContainer) {
          eduContainer.innerHTML = "";
          const edus = emp.educations || [];

          if (edus.length === 0) {
            eduContainer.innerHTML =
              '<p class="text-muted mb-0">No education entries.</p>';
          } else {
            const list = document.createElement("div");
            edus.forEach((e) => {
              const card = document.createElement("div");
              card.className = "view-emp-sub-card";
              card.innerHTML = `
                <strong>${escapeHtml(e.degree || "")}</strong> (${escapeHtml(
                e.level || ""
              )})<br/>
                <small>${escapeHtml(e.institutionName || "")} (${
                e.yearOfPassing || "-"
              })</small>
                ${
                  e.certificateUrl
                    ? `<br/><small><a href="${escapeHtml(
                        e.certificateUrl
                      )}" target="_blank" rel="noopener noreferrer">Certificate</a></small>`
                    : ""
                }
              `;
              list.appendChild(card);
            });
            eduContainer.appendChild(list);
          }
        }

        const expContainer = document.getElementById("viewExperienceList");
if (expContainer) {
  expContainer.innerHTML = "";
  const exps = emp.experiences || [];

  if (exps.length === 0) {
    expContainer.innerHTML =
      '<p class="text-muted mb-0">No experience entries.</p>';
  } else {
    const list = document.createElement("div");
    exps.forEach((e) => {
      const card = document.createElement("div");
      card.className = "view-emp-sub-card";

      const docs = [];
      if (e.relievingLetterUrl) {
        docs.push(
          `<a href="${escapeHtml(
            e.relievingLetterUrl
          )}" target="_blank" rel="noopener noreferrer">Relieving Letter</a>`
        );
      }
      if (e.salarySlipsUrl) {
        docs.push(
          `<a href="${escapeHtml(
            e.salarySlipsUrl
          )}" target="_blank" rel="noopener noreferrer">3 Months Salary Slips</a>`
        );
      }
      if (e.bankStatementUrl) {
        docs.push(
          `<a href="${escapeHtml(
            e.bankStatementUrl
          )}" target="_blank" rel="noopener noreferrer">Bank Statement</a>`
        );
      }

      const docsHtml =
        docs.length > 0
          ? `<br/><small>Docs: ${docs.join(" | ")}</small>`
          : "";

      card.innerHTML = `
        <strong>${escapeHtml(
          e.organizationName || ""
        )}</strong> - ${escapeHtml(e.jobTitle || "")}<br/>
        <small>${e.startDate || "-"} to ${
        e.isCurrent ? "Present" : e.endDate || "-"
      }</small>
        ${docsHtml}
      `;
      list.appendChild(card);
    });
    expContainer.appendChild(list);
  }
}


        const docContainer = document.getElementById("viewDocumentList");
        if (docContainer) {
          docContainer.innerHTML = "";
          const docs = emp.documents || [];

          if (docs.length === 0) {
            docContainer.innerHTML =
              '<p class="text-muted mb-0">No documents.</p>';
          } else {
            const list = document.createElement("div");
            docs.forEach((d) => {
              const card = document.createElement("div");
              card.className = "view-emp-sub-card";
              card.innerHTML = `
                <strong>${escapeHtml(d.category || "")}</strong> - ${escapeHtml(
                d.documentType || ""
              )}<br/>
                <small>Status: ${escapeHtml(
                  d.verificationStatus || "Pending"
                )}</small>
              `;
              list.appendChild(card);
            });
            docContainer.appendChild(list);
          }
        }

        const viewModalEl = document.getElementById("viewEmployeeModal");
        const viewModal =
          bootstrap.Modal.getOrCreateInstance(viewModalEl);
        viewModal.show();
      } catch (error) {
        alert(error.message);
      }
    }

    async function openEditEmployeeModal(id) {
      try {
        const emp = await fetchEmployee(id);

        formMode = "edit";
        currentEditingId = id;

        if (addEmployeeModalTitle) {
          addEmployeeModalTitle.textContent = "Edit Employee";
        }

        resetEmployeeForm();
        employeeIdField.value = emp.id;

        // Base fields
        fillBaseField("firstName", emp.firstName);
        fillBaseField("middleName", emp.middleName);
        fillBaseField("lastName", emp.lastName);
        fillBaseField("gender", emp.gender);
        fillBaseField("maritalStatus", emp.maritalStatus);
        fillBaseField("empDob", emp.empDob);
        fillBaseField("bloodGroup", emp.bloodGroup);
        fillBaseField("nationality", emp.nationality);
        fillBaseField("religion", emp.religion);
        fillBaseField("casteCategory", emp.casteCategory);
        fillBaseField("languagesKnown", emp.languagesKnown);
        fillBaseField("empPhone", emp.empPhone);
        fillBaseField("altPhone", emp.altPhone);
        fillBaseField("empEmail", emp.empEmail);
        fillBaseField("emergencyContactName", emp.emergencyContactName);
        fillBaseField(
          "emergencyContactRelation",
          emp.emergencyContactRelation
        );
        fillBaseField(
          "emergencyContactNumber",
          emp.emergencyContactNumber
        );

        fillBaseField("presentAddressLine1", emp.presentAddressLine1);
        fillBaseField("presentAddressLine2", emp.presentAddressLine2);
        fillBaseField("presentCity", emp.presentCity);
        fillBaseField("presentState", emp.presentState);
        fillBaseField("presentZip", emp.presentZip);
        fillBaseField("presentCountry", emp.presentCountry);

        fillBaseField("permanentSameAsPresent", emp.permanentSameAsPresent);
        if (sameAsPresentCheckbox) {
          sameAsPresentCheckbox.checked = !!emp.permanentSameAsPresent;
        }

        fillBaseField("permanentAddressLine1", emp.permanentAddressLine1);
        fillBaseField("permanentAddressLine2", emp.permanentAddressLine2);
        fillBaseField("permanentCity", emp.permanentCity);
        fillBaseField("permanentState", emp.permanentState);
        fillBaseField("permanentZip", emp.permanentZip);
        fillBaseField("permanentCountry", emp.permanentCountry);

        fillBaseField("businessId", emp.businessId);
        fillBaseField("empId", emp.empId);
        fillBaseField("employeeType", emp.employeeType);
        fillBaseField("employmentStatus", emp.employmentStatus);
        fillBaseField("empDepartment", emp.empDepartment);
        fillBaseField("empDesignation", emp.empDesignation);
        fillBaseField("division", emp.division);
        fillBaseField("subDepartment", emp.subDepartment);
        fillBaseField("gradeBandLevel", emp.gradeBandLevel);
        fillBaseField("reportingManagerId", emp.reportingManagerId);
        fillBaseField("workMode", emp.workMode);
        fillBaseField("empWorkLoc", emp.empWorkLoc);
        fillBaseField("empDateOfJoining", emp.empDateOfJoining);
        fillBaseField(
          "probationPeriodMonths",
          emp.probationPeriodMonths
        );
        fillBaseField("confirmationDate", emp.confirmationDate);

        fillBaseField("empCtc", emp.empCtc);
        fillBaseField("grossSalaryMonthly", emp.grossSalaryMonthly);
        fillBaseField("basicSalary", emp.basicSalary);
        fillBaseField("hra", emp.hra);
        fillBaseField(
          "conveyanceAllowance",
          emp.conveyanceAllowance
        );
        fillBaseField(
          "medicalAllowance",
          emp.medicalAllowance
        );
        fillBaseField(
          "specialAllowance",
          emp.specialAllowance
        );
        fillBaseField(
          "performanceBonus",
          emp.performanceBonus
        );
        fillBaseField("variablePay", emp.variablePay);
        fillBaseField(
          "overtimeEligible",
          emp.overtimeEligible ? "true" : "false"
        );
        fillBaseField("shiftAllowance", emp.shiftAllowance);
        fillBaseField("pfDeduction", emp.pfDeduction);
        fillBaseField("esiDeduction", emp.esiDeduction);
        fillBaseField("professionalTax", emp.professionalTax);
        fillBaseField("tdsDeduction", emp.tdsDeduction);
        fillBaseField("netSalary", emp.netSalary);

        // Aadhaar / PAN removed from form: they are now in documents only

        setEducationRows(emp.educations || []);
        setExperienceRows(emp.experiences || []);
        setDocumentRows(emp.documents || []);

        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      } catch (error) {
        alert(error.message);
      }
    }

    async function deleteEmployee(id) {
      const confirmed = window.confirm(
        "Are you sure you want to delete this employee? This action cannot be undone."
      );
      if (!confirmed) return;

      try {
        const res = await fetch("/api/v1/employees/" + id, {
          method: "DELETE",
        });

        if (!res.ok) {
          let err;
          try {
            err = await res.json();
          } catch (e) {
            err = {};
          }
          throw new Error(err.error || "Failed to delete employee");
        }

        window.location.reload();
      } catch (error) {
        alert(error.message);
      }
    }

    // =======================================
    // Global click delegation for View/Edit/Delete
    // =======================================
    document.addEventListener("click", function (e) {
      const viewBtn = e.target.closest(".view-employee-btn");
      if (viewBtn) {
        const id = viewBtn.getAttribute("data-id");
        if (id) openViewEmployeeModal(id);
        return;
      }

      const editBtn = e.target.closest(".edit-employee-btn");
      if (editBtn) {
        const id = editBtn.getAttribute("data-id");
        if (id) openEditEmployeeModal(id);
        return;
      }

      const deleteBtn = e.target.closest(".delete-employee-btn");
      if (deleteBtn) {
        const id = deleteBtn.getAttribute("data-id");
        if (id) deleteEmployee(id);
        return;
      }
    });
  })();
</script>
