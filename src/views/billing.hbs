{{!-- views/billing.hbs --}}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 col-lg-2 px-0">
            {{> sidebar}}
        </div>

        <div class="col-md-9 col-lg-10">
            <div class="main-content p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-1"><i class="fa-solid fa-crown text-warning me-2"></i> Billing & Plans</h2>
                        <p class="text-muted mb-0">Manage your subscription and billing information</p>
                    </div>
                </div>

                <!-- Alert Messages -->
                <div id="billingAlert" class="alert d-none" role="alert"></div>

                <!-- Current Plan -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div id="currentPlanCard" class="card" style="border: 2px solid #f59e0b; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge bg-warning text-dark me-2">CURRENT PLAN</span>
                                            <h4 id="currentPlanName" class="mb-0 fw-bold">Free Trial</h4>
                                        </div>
                                        <p id="currentPlanDescription" class="text-muted mb-2">Explore all features with limited usage</p>
                                        <div id="currentPlanFeatures" class="d-flex gap-3 flex-wrap">
                                            <small><i class="fa-solid fa-check text-success me-1"></i> Up to 10 employees</small>
                                            <small><i class="fa-solid fa-check text-success me-1"></i> Basic leave management</small>
                                            <small><i class="fa-solid fa-check text-success me-1"></i> Document generation</small>
                                        </div>
                                        <div id="subscriptionDetails" class="mt-3 d-none">
                                            <small class="text-muted">
                                                <i class="fa-solid fa-calendar me-1"></i> 
                                                Valid until: <span id="validUntilDate">-</span>
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="mb-2">
                                            <span id="currentPlanPrice" style="font-size: 2rem; font-weight: 800; color: #f59e0b;">₹0</span>
                                            <span class="text-muted">/month</span>
                                        </div>
                                        <span id="subscriptionStatus" class="badge bg-secondary mb-2 d-none">Status</span>
                                        <div id="cancelSubscriptionBtnContainer" class="d-none">
                                            <button id="cancelSubscriptionBtn" class="btn btn-outline-danger btn-sm">
                                                <i class="fa-solid fa-times me-1"></i> Cancel Subscription
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Available Plans -->
                <h4 class="mb-3"><i class="fa-solid fa-layer-group me-2"></i> Available Plans</h4>
                <div id="plansContainer" class="row mb-4">
                    <!-- Starter Plan -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 shadow-sm plan-card" data-plan="starter">
                            <div class="card-header bg-light">
                                <h5 class="mb-1 fw-bold">Starter</h5>
                                <p class="text-muted small mb-0">For small teams</p>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <span style="font-size: 2.5rem; font-weight: 800; color: #3b82f6;">₹2,499</span>
                                    <span class="text-muted">/month</span>
                                </div>
                                <ul class="list-unstyled">
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Up to 50 employees</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Leave management</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Document generation</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Email support</li>
                                    <li class="mb-2"><i class="fa-solid fa-times text-muted me-2"></i> Advanced analytics</li>
                                    <li class="mb-2"><i class="fa-solid fa-times text-muted me-2"></i> API access</li>
                                </ul>
                                <button class="btn btn-outline-primary w-100 mt-3 select-plan-btn" data-plan="starter" data-name="Starter" data-price="2499">
                                    Select Plan
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Professional Plan -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 shadow-sm plan-card" data-plan="professional" style="border: 2px solid #10b981;">
                            <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-1 fw-bold">Professional</h5>
                                        <p class="small mb-0 opacity-75">Most popular</p>
                                    </div>
                                    <span class="badge bg-white text-success">POPULAR</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <span style="font-size: 2.5rem; font-weight: 800; color: #10b981;">₹6,999</span>
                                    <span class="text-muted">/month</span>
                                </div>
                                <ul class="list-unstyled">
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Up to 200 employees</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Advanced leave management</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Custom document templates</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Priority support</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Advanced analytics</li>
                                    <li class="mb-2"><i class="fa-solid fa-times text-muted me-2"></i> API access</li>
                                </ul>
                                <button class="btn btn-success w-100 mt-3 select-plan-btn" data-plan="professional" data-name="Professional" data-price="6999">
                                    Select Plan
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Enterprise Plan -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 shadow-sm plan-card" data-plan="enterprise">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-1 fw-bold">Enterprise</h5>
                                <p class="small mb-0 opacity-75">For large organizations</p>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <span style="font-size: 2.5rem; font-weight: 800; color: #6366f1;">₹14,999</span>
                                    <span class="text-muted">/month</span>
                                </div>
                                <ul class="list-unstyled">
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Unlimited employees</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> All features included</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Custom integrations</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> 24/7 dedicated support</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Advanced analytics</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Full API access</li>
                                </ul>
                                <button class="btn btn-dark w-100 mt-3 select-plan-btn" data-plan="enterprise" data-name="Enterprise" data-price="14999">
                                    Select Plan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Billing History -->
                <h4 class="mb-3"><i class="fa-solid fa-receipt me-2"></i> Billing History</h4>
                <div class="card">
                    <div class="card-body">
                        <div id="invoicesContainer">
                            <div id="noInvoices" class="text-center py-5 text-muted">
                                <i class="fa-solid fa-file-invoice-dollar fa-3x mb-3 opacity-50"></i>
                                <h5>No billing history yet</h5>
                                <p>Your invoices will appear here once you upgrade to a paid plan.</p>
                            </div>
                            <div id="invoicesTable" class="d-none">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Invoice #</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Plan</th>
                                        </tr>
                                    </thead>
                                    <tbody id="invoicesTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Customer Details Modal -->
<div class="modal fade" id="customerDetailsModal" tabindex="-1" aria-labelledby="customerDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerDetailsModalLabel">Complete Your Purchase</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="selectedPlanInfo" class="alert alert-info mb-3">
                    <strong id="modalPlanName">Plan Name</strong>
                    <div id="modalPlanPrice" class="fs-4 fw-bold">₹0/month</div>
                </div>
                <form id="customerDetailsForm">
                    <div class="mb-3">
                        <label for="customerName" class="form-label">Full Name *</label>
                        <input type="text" class="form-control" id="customerName" name="name" required placeholder="Enter your full name">
                    </div>
                    <div class="mb-3">
                        <label for="customerEmail" class="form-label">Email Address *</label>
                        <input type="email" class="form-control" id="customerEmail" name="email" required placeholder="Enter your email">
                    </div>
                    <div class="mb-3">
                        <label for="customerContact" class="form-label">Phone Number *</label>
                        <input type="tel" class="form-control" id="customerContact" name="contact" required placeholder="10-digit mobile number" pattern="[0-9]{10}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="proceedToPayBtn">
                    <i class="fa-solid fa-credit-card me-2"></i> Proceed to Pay
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Razorpay Checkout Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }
    .plan-card.current-plan {
        border: 2px solid #10b981 !important;
        background-color: #f0fdf4;
    }
    .plan-card.current-plan .select-plan-btn {
        display: none;
    }
    .plan-card.current-plan::after {
        content: 'Current Plan';
        position: absolute;
        top: 10px;
        right: 10px;
        background: #10b981;
        color: white;
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .select-plan-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>

<script>
(function() {
    // Configuration
    const RAZORPAY_KEY_ID = '{{razorpayKeyId}}';
    const IS_RAZORPAY_CONFIGURED = {{#if isRazorpayConfigured}}true{{else}}false{{/if}};
    
    // State
    let selectedPlan = null;
    let currentSubscription = null;
    let customerModal = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        customerModal = new bootstrap.Modal(document.getElementById('customerDetailsModal'));
        
        loadCurrentSubscription();
        loadInvoices();
        setupEventListeners();
    });

    // Setup event listeners
    function setupEventListeners() {
        // Plan selection buttons
        document.querySelectorAll('.select-plan-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!IS_RAZORPAY_CONFIGURED) {
                    showAlert('Payment service is not configured. Please contact support.', 'warning');
                    return;
                }
                
                selectedPlan = {
                    code: this.dataset.plan,
                    name: this.dataset.name,
                    price: parseInt(this.dataset.price)
                };
                
                document.getElementById('modalPlanName').textContent = selectedPlan.name + ' Plan';
                document.getElementById('modalPlanPrice').textContent = '₹' + selectedPlan.price.toLocaleString() + '/month';
                
                customerModal.show();
            });
        });

        // Proceed to pay button
        document.getElementById('proceedToPayBtn').addEventListener('click', handleProceedToPay);

        // Cancel subscription button
        document.getElementById('cancelSubscriptionBtn')?.addEventListener('click', handleCancelSubscription);
    }

    // Load current subscription
    async function loadCurrentSubscription() {
        try {
            const response = await fetch('/billing/subscription', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`
                }
            });
            const data = await response.json();

            if (data.success && data.data?.subscription) {
                currentSubscription = data.data.subscription;
                updateCurrentPlanUI(data.data.subscription);
            }
        } catch (error) {
            console.error('Failed to load subscription:', error);
        }
    }

    // Update UI with current subscription
    function updateCurrentPlanUI(subscription) {
        const planName = subscription.planCode.charAt(0).toUpperCase() + subscription.planCode.slice(1);
        
        // Update current plan card
        document.getElementById('currentPlanName').textContent = planName;
        
        // Update status badge
        const statusBadge = document.getElementById('subscriptionStatus');
        statusBadge.classList.remove('d-none', 'bg-success', 'bg-warning', 'bg-danger', 'bg-secondary');
        statusBadge.textContent = subscription.status.toUpperCase();
        
        switch (subscription.status) {
            case 'active':
                statusBadge.classList.add('bg-success');
                break;
            case 'pending':
                statusBadge.classList.add('bg-warning');
                break;
            case 'cancelled':
            case 'expired':
                statusBadge.classList.add('bg-danger');
                break;
            default:
                statusBadge.classList.add('bg-secondary');
        }

        // Show subscription details
        if (subscription.currentPeriodEnd) {
            document.getElementById('subscriptionDetails').classList.remove('d-none');
            document.getElementById('validUntilDate').textContent = new Date(subscription.currentPeriodEnd).toLocaleDateString();
        }

        // Show cancel button for active subscriptions
        if (subscription.status === 'active' && !subscription.cancelAtPeriodEnd) {
            document.getElementById('cancelSubscriptionBtnContainer').classList.remove('d-none');
        }

        // Mark current plan card
        document.querySelectorAll('.plan-card').forEach(card => {
            card.classList.remove('current-plan');
            if (card.dataset.plan === subscription.planCode) {
                card.classList.add('current-plan');
                card.style.position = 'relative';
            }
        });

        // Update price based on plan
        const prices = { starter: '₹2,499', professional: '₹6,999', enterprise: '₹14,999' };
        document.getElementById('currentPlanPrice').textContent = prices[subscription.planCode] || '₹0';
        document.getElementById('currentPlanPrice').style.color = '#10b981';

        // Update current plan card style
        const currentPlanCard = document.getElementById('currentPlanCard');
        currentPlanCard.style.border = '2px solid #10b981';
        currentPlanCard.style.background = 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)';
    }

    // Load invoices
    async function loadInvoices() {
        try {
            const response = await fetch('/billing/invoices', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`
                }
            });
            const data = await response.json();

            if (data.success && data.data?.invoices && data.data.invoices.length > 0) {
                renderInvoices(data.data.invoices);
            }
        } catch (error) {
            console.error('Failed to load invoices:', error);
        }
    }

    // Render invoices table
    function renderInvoices(invoices) {
        document.getElementById('noInvoices').classList.add('d-none');
        document.getElementById('invoicesTable').classList.remove('d-none');

        const tbody = document.getElementById('invoicesTableBody');
        tbody.innerHTML = invoices.map(invoice => `
            <tr>
                <td><strong>${invoice.invoiceNumber}</strong></td>
                <td>${new Date(invoice.issuedDate).toLocaleDateString()}</td>
                <td>₹${parseFloat(invoice.amount).toLocaleString()}</td>
                <td>
                    <span class="badge ${invoice.status === 'paid' ? 'bg-success' : 'bg-warning'}">
                        ${invoice.status.toUpperCase()}
                    </span>
                </td>
                <td>${invoice.description || '-'}</td>
            </tr>
        `).join('');
    }

    // Handle proceed to pay
    async function handleProceedToPay() {
        const form = document.getElementById('customerDetailsForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const customer = {
            name: document.getElementById('customerName').value.trim(),
            email: document.getElementById('customerEmail').value.trim(),
            contact: document.getElementById('customerContact').value.trim()
        };

        const btn = document.getElementById('proceedToPayBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

        try {
            // Create order using new endpoint
            const response = await fetch('/billing/create-order', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`
                },
                body: JSON.stringify({
                    planId: selectedPlan.code,
                    customer
                })
            });

            const result = await response.json();
            console.log('[Billing] Create order response:', result);

            if (!result.success) {
                throw new Error(result.message || 'Failed to create order');
            }

            const data = result.data;

            // Close modal
            customerModal.hide();

            // Open Razorpay checkout
            const options = {
                key: data.checkout.key,
                order_id: data.checkout.order_id,
                amount: data.checkout.amount,
                currency: data.checkout.currency,
                name: data.checkout.name,
                description: data.checkout.description,
                prefill: data.checkout.prefill,
                theme: { color: '#667eea' },
                handler: async function(razorpayResponse) {
                    await verifyPayment(data.orderId, data.plan.id, razorpayResponse);
                },
                modal: {
                    ondismiss: function() {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fa-solid fa-credit-card me-2"></i> Proceed to Pay';
                    }
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();

        } catch (error) {
            console.error('[Billing] Error:', error);
            showAlert(error.message, 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-credit-card me-2"></i> Proceed to Pay';
        }
    }

    // Verify payment
    async function verifyPayment(orderId, planId, razorpayResponse) {
        try {
            const response = await fetch('/billing/verify', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`
                },
                body: JSON.stringify({
                    razorpay_order_id: razorpayResponse.razorpay_order_id,
                    razorpay_payment_id: razorpayResponse.razorpay_payment_id,
                    razorpay_signature: razorpayResponse.razorpay_signature,
                    planId: planId
                })
            });

            const data = await response.json();
            console.log('[Billing] Verify response:', data);

            if (data.success) {
                showAlert('Payment successful! Your subscription is now active.', 'success');
                
                // Reload subscription and invoices
                setTimeout(() => {
                    loadCurrentSubscription();
                    loadInvoices();
                }, 1000);
            } else {
                throw new Error(data.message || 'Payment verification failed');
            }
        } catch (error) {
            console.error('[Billing] Verify error:', error);
            showAlert('Payment verification failed: ' + error.message, 'danger');
        }

        // Reset button
        const btn = document.getElementById('proceedToPayBtn');
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-credit-card me-2"></i> Proceed to Pay';
    }

    // Handle cancel subscription
    async function handleCancelSubscription() {
        if (!currentSubscription) return;

        if (!confirm('Are you sure you want to cancel your subscription? You will still have access until the end of your billing period.')) {
            return;
        }

        try {
            const response = await fetch(`/billing/subscription/${currentSubscription.id}/cancel`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`
                },
                body: JSON.stringify({ cancelAtPeriodEnd: true })
            });

            const data = await response.json();

            if (data.success) {
                showAlert('Subscription cancelled. You will have access until the end of your billing period.', 'success');
                loadCurrentSubscription();
            } else {
                throw new Error(data.message || 'Failed to cancel subscription');
            }
        } catch (error) {
            showAlert(error.message, 'danger');
        }
    }

    // Show alert message
    function showAlert(message, type = 'info') {
        const alert = document.getElementById('billingAlert');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alert.classList.remove('d-none');

        setTimeout(() => {
            alert.classList.add('d-none');
        }, 5000);
    }
})();
</script>
