{{!-- Admin Statutory Reports --}}
<div class="container-fluid">
	<div class="row">
		<div class="col-md-3 col-lg-2 px-0">
			{{> sidebar active="payroll-statutory" activeGroup="payroll"}}
		</div>

		<div class="col-md-9 col-lg-10">
			<div class="main-content p-4">
				<nav aria-label="breadcrumb">
					<ol class="breadcrumb mb-3 bg-transparent p-0">
						<li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
						<li class="breadcrumb-item"><a href="/payroll/runs">Payroll</a></li>
						<li class="breadcrumb-item active" aria-current="page">Statutory Reports</li>
					</ol>
				</nav>

				<div class="d-flex align-items-center justify-content-between mb-4">
					<div>
						<h2 class="mb-1">Statutory Reports</h2>
						<p class="text-muted mb-0">Generate compliance reports for statutory authorities</p>
					</div>
				</div>

				<!-- Run Selector -->
				<div class="card mb-4">
					<div class="card-body">
						<div class="row align-items-center g-3">
							<div class="col-md-4">
								<label class="form-label mb-2 fw-600">Select Payroll Run</label>
								<select class="form-select" id="runSelect" onchange="changeRun()">
									<option value="">-- Select a payroll run --</option>
								</select>
							</div>
							<div class="col-md-4">
								<label class="form-label mb-2 fw-600">Period</label>
								<input type="text" class="form-control" id="periodDisplay" value="{{periodDisplay}}" readonly>
							</div>
							<div class="col-md-4 d-flex align-items-end gap-2">
								<button class="btn btn-primary" onclick="refreshData()">
									<i class="fa-solid fa-refresh me-2"></i>Refresh
								</button>
								<button class="btn btn-outline-secondary" onclick="exportAllReports()">
									<i class="fa-solid fa-file-export me-2"></i>Export All
								</button>
							</div>
						</div>
					</div>
				</div>

				{{#unless selectedRunId}}
				<div class="alert alert-warning">
					<i class="fa-solid fa-exclamation-triangle me-2"></i>
					No payroll runs found. Please <a href="/payroll/runs">create a payroll run</a> first.
				</div>
				{{/unless}}

				<!-- Report Cards Grid -->
				<div class="row g-3 mb-4">
					<!-- PF Report -->
					<div class="col-md-6">
						<div class="card h-100">
							<div class="card-header bg-light">
								<div class="d-flex align-items-center justify-content-between">
									<div>
										<h6 class="mb-1"><i class="fa-solid fa-landmark me-2" style="color: #4f46e5;"></i>PF Summary</h6>
										<small class="text-muted">Provident Fund Report</small>
									</div>
									<span class="badge bg-primary" id="pf-period-badge">{{periodDisplay}}</span>
								</div>
							</div>
							<div class="card-body">
								<div class="row g-3 mb-3">
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Employees Covered</small>
											<div class="h5" id="pf-employee-count">{{#if pfSummary}}{{pfSummary.employeeCount}}{{else}}0{{/if}}</div>
										</div>
									</div>
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Total Contribution</small>
											<div class="h5" id="pf-total">₹{{#if pfSummary}}{{pfSummary.totalContribution}}{{else}}0{{/if}}</div>
										</div>
									</div>
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Employer Share</small>
											<div class="h5" id="pf-employer">₹{{#if pfSummary}}{{pfSummary.employerShare}}{{else}}0{{/if}}</div>
										</div>
									</div>
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Employee Share</small>
											<div class="h5" id="pf-employee">₹{{#if pfSummary}}{{pfSummary.employeeShare}}{{else}}0{{/if}}</div>
										</div>
									</div>
								</div>
								<button class="btn btn-outline-primary btn-sm w-100" onclick="viewReport('pf')">
									<i class="fa-solid fa-eye me-2"></i>View Detailed Report
								</button>
								<button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="exportReport('pf', 'csv')">
									<i class="fa-solid fa-download me-2"></i>Export CSV
								</button>
							</div>
						</div>
					</div>

					<!-- ESI Report -->
					<div class="col-md-6">
						<div class="card h-100">
							<div class="card-header bg-light">
								<div class="d-flex align-items-center justify-content-between">
									<div>
										<h6 class="mb-1"><i class="fa-solid fa-heart me-2" style="color: #f59e0b;"></i>ESI Summary</h6>
										<small class="text-muted">Employee State Insurance Report</small>
									</div>
									<span class="badge bg-warning text-dark" id="esi-period-badge">{{periodDisplay}}</span>
								</div>
							</div>
							<div class="card-body">
								<div class="row g-3 mb-3">
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Employees Covered</small>
											<div class="h5" id="esi-employee-count">{{#if esiSummary}}{{esiSummary.employeeCount}}{{else}}0{{/if}}</div>
										</div>
									</div>
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Total Contribution</small>
											<div class="h5" id="esi-total">₹{{#if esiSummary}}{{esiSummary.totalContribution}}{{else}}0{{/if}}</div>
										</div>
									</div>
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Employer Share (3.25%)</small>
											<div class="h5" id="esi-employer">₹{{#if esiSummary}}{{esiSummary.employerShare}}{{else}}0{{/if}}</div>
										</div>
									</div>
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Employee Share (0.75%)</small>
											<div class="h5" id="esi-employee">₹{{#if esiSummary}}{{esiSummary.employeeShare}}{{else}}0{{/if}}</div>
										</div>
									</div>
								</div>
								<button class="btn btn-outline-primary btn-sm w-100" onclick="viewReport('esi')">
									<i class="fa-solid fa-eye me-2"></i>View Detailed Report
								</button>
								<button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="exportReport('esi', 'csv')">
									<i class="fa-solid fa-download me-2"></i>Export CSV
								</button>
							</div>
						</div>
					</div>

					<!-- PT Report -->
					<div class="col-md-6">
						<div class="card h-100">
							<div class="card-header bg-light">
								<div class="d-flex align-items-center justify-content-between">
									<div>
										<h6 class="mb-1"><i class="fa-solid fa-percent me-2" style="color: #06b6d4;"></i>PT Summary</h6>
										<small class="text-muted">Professional Tax Report</small>
									</div>
									<span class="badge bg-info" id="pt-period-badge">{{periodDisplay}}</span>
								</div>
							</div>
							<div class="card-body">
								<div class="row g-3 mb-3">
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Employees Taxed</small>
											<div class="h5" id="pt-employee-count">{{#if ptSummary}}{{ptSummary.employeeCount}}{{else}}0{{/if}}</div>
										</div>
									</div>
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Total PT Deducted</small>
											<div class="h5" id="pt-total">₹{{#if ptSummary}}{{ptSummary.totalPT}}{{else}}0{{/if}}</div>
										</div>
									</div>
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Avg. per Employee</small>
											<div class="h5" id="pt-avg">₹{{#if ptSummary}}{{ptSummary.avgPerEmployee}}{{else}}0{{/if}}</div>
										</div>
									</div>
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Status</small>
											<div class="h5"><span class="badge bg-success" id="pt-status">Active</span></div>
										</div>
									</div>
								</div>
								<button class="btn btn-outline-primary btn-sm w-100" onclick="viewReport('pt')">
									<i class="fa-solid fa-eye me-2"></i>View Detailed Report
								</button>
								<button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="exportReport('pt', 'csv')">
									<i class="fa-solid fa-download me-2"></i>Export CSV
								</button>
							</div>
						</div>
					</div>

					<!-- TDS Report -->
					<div class="col-md-6">
						<div class="card h-100">
							<div class="card-header bg-light">
								<div class="d-flex align-items-center justify-content-between">
									<div>
										<h6 class="mb-1"><i class="fa-solid fa-receipt me-2" style="color: #22c55e;"></i>TDS Summary</h6>
										<small class="text-muted">Tax Deducted at Source Report</small>
									</div>
									<span class="badge bg-success" id="tds-period-badge">{{periodDisplay}}</span>
								</div>
							</div>
							<div class="card-body">
								<div class="row g-3 mb-3">
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Employees with TDS</small>
											<div class="h5" id="tds-employee-count">{{#if tdsSummary}}{{tdsSummary.employeeCount}}{{else}}0{{/if}}</div>
										</div>
									</div>
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Total TDS Deducted</small>
											<div class="h5" id="tds-total">₹{{#if tdsSummary}}{{tdsSummary.totalTDS}}{{else}}0{{/if}}</div>
										</div>
									</div>
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Avg. Tax Rate</small>
											<div class="h5" id="tds-rate">{{#if tdsSummary}}{{tdsSummary.avgTaxRate}}%{{else}}0%{{/if}}</div>
										</div>
									</div>
									<div class="col-6">
										<div class="stat-item">
											<small class="text-muted">Taxable Income</small>
											<div class="h5" id="tds-taxable">₹{{#if tdsSummary}}{{tdsSummary.totalTaxableIncome}}{{else}}0{{/if}}</div>
										</div>
									</div>
								</div>
								<button class="btn btn-outline-primary btn-sm w-100" onclick="viewReport('tds')">
									<i class="fa-solid fa-eye me-2"></i>View Detailed Report
								</button>
								<button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="exportReport('tds', 'csv')">
									<i class="fa-solid fa-download me-2"></i>Export CSV
								</button>
							</div>
						</div>
					</div>
				</div>

				<!-- Compliance Checklist -->
				<div class="card">
					<div class="card-header">
						<h6 class="mb-0"><i class="fa-solid fa-clipboard-check me-2"></i>Compliance Checklist</h6>
					</div>
					<div class="card-body">
						<div class="row">
							<div class="col-md-6">
								<div class="form-check form-switch mb-3">
									<input class="form-check-input" type="checkbox" id="pf-filed" onchange="toggleCompliance('pfFiled', this.checked)">
									<label class="form-check-label" for="pf-filed">
										<strong>PF Return Filed</strong>
										<small class="d-block text-muted" id="pf-due-date">Due by 15th of next month</small>
										<small class="text-success d-none" id="pf-filed-at"></small>
									</label>
								</div>
								<div class="form-check form-switch mb-3">
									<input class="form-check-input" type="checkbox" id="esi-filed" onchange="toggleCompliance('esiFiled', this.checked)">
									<label class="form-check-label" for="esi-filed">
										<strong>ESI Return Filed</strong>
										<small class="d-block text-muted" id="esi-due-date">Due by 15th of next month</small>
										<small class="text-success d-none" id="esi-filed-at"></small>
									</label>
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-check form-switch mb-3">
									<input class="form-check-input" type="checkbox" id="pt-filed" onchange="toggleCompliance('ptFiled', this.checked)">
									<label class="form-check-label" for="pt-filed">
										<strong>PT Return Filed</strong>
										<small class="d-block text-muted" id="pt-due-date">Due by end of next month</small>
										<small class="text-success d-none" id="pt-filed-at"></small>
									</label>
								</div>
								<div class="form-check form-switch mb-3">
									<input class="form-check-input" type="checkbox" id="tds-deposited" onchange="toggleCompliance('tdsDeposited', this.checked)">
									<label class="form-check-label" for="tds-deposited">
										<strong>TDS Deposited</strong>
										<small class="d-block text-muted" id="tds-due-date">Due by 7th of next month</small>
										<small class="text-success d-none" id="tds-deposited-at"></small>
									</label>
								</div>
							</div>
						</div>
						<div class="mt-3">
							<div class="progress" style="height: 25px;">
								<div class="progress-bar bg-success" id="compliance-progress" role="progressbar" style="width: 0%;">0% Complete</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Report Detail Modal -->
<div class="modal fade" id="reportModal" tabindex="-1">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="reportModalTitle">Detailed Report</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<div class="table-responsive">
					<table class="table table-striped table-hover" id="reportTable">
						<thead id="reportTableHead"></thead>
						<tbody id="reportTableBody"></tbody>
					</table>
				</div>
				<div id="reportNoData" class="text-center text-muted py-5 d-none">
					<i class="fa-solid fa-inbox fa-3x mb-3"></i>
					<p>No data found for this report.</p>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-secondary" onclick="exportCurrentReport('csv')">
					<i class="fa-solid fa-download me-2"></i>Export CSV
				</button>
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>

<style>
	.stat-item {
		padding: 10px;
		background: #f9f9f9;
		border-radius: 6px;
		text-align: center;
	}
	.form-switch .form-check-input {
		width: 3em;
		height: 1.5em;
	}
	.form-switch .form-check-input:checked {
		background-color: #198754;
		border-color: #198754;
	}
</style>

<script>
	const selectedRunId = {{#if selectedRunId}}{{selectedRunId}}{{else}}null{{/if}};
	const allRuns = {{{allRuns}}};
	let compliance = {{{compliance}}};
	let currentReportType = null;
	let currentReportData = [];

	// Initialize on page load
	document.addEventListener('DOMContentLoaded', function() {
		initRunDropdown();
		initComplianceCheckboxes();
		updateComplianceProgress();
	});

	function initRunDropdown() {
		const select = document.getElementById('runSelect');
		select.innerHTML = '<option value="">-- Select a payroll run --</option>';
		
		if (!allRuns || !allRuns.length) return;
		
		allRuns.forEach(run => {
			const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
				'July', 'August', 'September', 'October', 'November', 'December'];
			const label = `${monthNames[run.periodMonth]} ${run.periodYear} (${run.status})`;
			const option = document.createElement('option');
			option.value = run.id;
			option.textContent = label;
			if (run.id === selectedRunId) option.selected = true;
			select.appendChild(option);
		});
	}

	function initComplianceCheckboxes() {
		if (!compliance) return;
		
		document.getElementById('pf-filed').checked = !!compliance.pfFiled;
		document.getElementById('esi-filed').checked = !!compliance.esiFiled;
		document.getElementById('pt-filed').checked = !!compliance.ptFiled;
		document.getElementById('tds-deposited').checked = !!compliance.tdsDeposited;

		// Update due dates based on selected run period
		updateDueDates();

		// Show filed-at timestamps and update status
		updateFiledStatus('pf-filed-at', 'pf-due-date', compliance.pfFiled, compliance.pfFiledAt, 'Filed');
		updateFiledStatus('esi-filed-at', 'esi-due-date', compliance.esiFiled, compliance.esiFiledAt, 'Filed');
		updateFiledStatus('pt-filed-at', 'pt-due-date', compliance.ptFiled, compliance.ptFiledAt, 'Filed');
		updateFiledStatus('tds-deposited-at', 'tds-due-date', compliance.tdsDeposited, compliance.tdsDepositedAt, 'Deposited');
	}

	function updateFiledStatus(filedAtId, dueDateId, isFiled, filedAt, action) {
		const filedAtEl = document.getElementById(filedAtId);
		const dueDateEl = document.getElementById(dueDateId);
		
		if (isFiled && filedAt) {
			filedAtEl.textContent = `✓ ${action}: ` + new Date(filedAt).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
			filedAtEl.classList.remove('d-none');
			dueDateEl.classList.add('text-decoration-line-through');
			dueDateEl.classList.remove('text-danger');
		} else if (isFiled) {
			filedAtEl.textContent = `✓ ${action}`;
			filedAtEl.classList.remove('d-none');
			dueDateEl.classList.add('text-decoration-line-through');
			dueDateEl.classList.remove('text-danger');
		} else {
			filedAtEl.classList.add('d-none');
			dueDateEl.classList.remove('text-decoration-line-through');
			// Check if overdue
			checkIfOverdue(dueDateId);
		}
	}

	function updateDueDates() {
		// Get selected run period
		const selectedRun = allRuns.find(r => r.id === selectedRunId);
		if (!selectedRun) return;
		
		const runMonth = selectedRun.periodMonth;
		const runYear = selectedRun.periodYear;
		
		// Calculate next month
		let nextMonth = runMonth + 1;
		let nextYear = runYear;
		if (nextMonth > 12) {
			nextMonth = 1;
			nextYear++;
		}
		
		const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
			'July', 'August', 'September', 'October', 'November', 'December'];
		
		// PF: Due by 15th of next month
		const pfDueDate = new Date(nextYear, nextMonth - 1, 15);
		document.getElementById('pf-due-date').textContent = `Due by ${formatDueDate(pfDueDate)}`;
		document.getElementById('pf-due-date').dataset.dueDate = pfDueDate.toISOString();
		
		// ESI: Due by 15th of next month
		const esiDueDate = new Date(nextYear, nextMonth - 1, 15);
		document.getElementById('esi-due-date').textContent = `Due by ${formatDueDate(esiDueDate)}`;
		document.getElementById('esi-due-date').dataset.dueDate = esiDueDate.toISOString();
		
		// PT: Due by end of next month (varies by state, using 15th as common)
		const ptDueDate = new Date(nextYear, nextMonth - 1, 15);
		document.getElementById('pt-due-date').textContent = `Due by ${formatDueDate(ptDueDate)}`;
		document.getElementById('pt-due-date').dataset.dueDate = ptDueDate.toISOString();
		
		// TDS: Due by 7th of next month
		const tdsDueDate = new Date(nextYear, nextMonth - 1, 7);
		document.getElementById('tds-due-date').textContent = `Due by ${formatDueDate(tdsDueDate)}`;
		document.getElementById('tds-due-date').dataset.dueDate = tdsDueDate.toISOString();
	}

	function formatDueDate(date) {
		const day = date.getDate();
		const suffix = (day === 1 || day === 21 || day === 31) ? 'st' : 
					   (day === 2 || day === 22) ? 'nd' : 
					   (day === 3 || day === 23) ? 'rd' : 'th';
		return `${day}${suffix} ${date.toLocaleDateString('en-IN', { month: 'short', year: 'numeric' })}`;
	}

	function checkIfOverdue(dueDateId) {
		const dueDateEl = document.getElementById(dueDateId);
		const dueDate = dueDateEl.dataset.dueDate ? new Date(dueDateEl.dataset.dueDate) : null;
		if (dueDate && new Date() > dueDate) {
			dueDateEl.classList.add('text-danger', 'fw-bold');
			dueDateEl.textContent = dueDateEl.textContent.replace('Due by', '⚠️ OVERDUE:');
		}
	}

	function updateComplianceProgress() {
		if (!compliance) return;
		const total = 4;
		let completed = 0;
		if (compliance.pfFiled) completed++;
		if (compliance.esiFiled) completed++;
		if (compliance.ptFiled) completed++;
		if (compliance.tdsDeposited) completed++;
		
		const pct = Math.round((completed / total) * 100);
		const bar = document.getElementById('compliance-progress');
		bar.style.width = pct + '%';
		bar.textContent = pct + '% Complete';
	}

	function changeRun() {
		const runId = document.getElementById('runSelect').value;
		if (runId) {
			window.location.href = '/payroll/statutory?runId=' + runId;
		}
	}

	function refreshData() {
		window.location.reload();
	}

	async function toggleCompliance(field, value) {
		if (!selectedRunId) {
			showToast('No payroll run selected', 'warning');
			return;
		}
		
		const token = localStorage.getItem('accessToken');
		try {
			const res = await fetch(`/api/admin/payroll/statutory/${selectedRunId}/compliance`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					...(token ? { 'Authorization': `Bearer ${token}` } : {})
				},
				credentials: 'include',
				body: JSON.stringify({ field, value })
			});
			
			const data = await res.json();
			if (data.success && data.data) {
				compliance = data.data;
				initComplianceCheckboxes();
				updateComplianceProgress();
				showToast(`${field.replace('Filed', ' Filed').replace('Deposited', ' Deposited')} status updated`, 'success');
			} else {
				showToast('Failed to update compliance status', 'danger');
			}
		} catch (err) {
			console.error(err);
			showToast('Error updating compliance: ' + err.message, 'danger');
		}
	}

	async function viewReport(type) {
		if (!selectedRunId) {
			showToast('No payroll run selected', 'warning');
			return;
		}

		currentReportType = type;
		const token = localStorage.getItem('accessToken');
		
		try {
			const res = await fetch(`/api/admin/payroll/statutory/${selectedRunId}/${type}`, {
				credentials: 'include',
				headers: { ...(token ? { 'Authorization': `Bearer ${token}` } : {}) }
			});
			
			const data = await res.json();
			if (!data.success || !data.data) {
				showToast('No report data available', 'warning');
				return;
			}

			currentReportData = data.data;
			renderReportModal(type, data.data);
			new bootstrap.Modal(document.getElementById('reportModal')).show();
		} catch (err) {
			showToast('Failed to load report: ' + err.message, 'danger');
		}
	}

	function renderReportModal(type, data) {
		const titleMap = {
			pf: 'PF (Provident Fund) Detailed Report',
			esi: 'ESI (Employee State Insurance) Detailed Report',
			pt: 'PT (Professional Tax) Detailed Report',
			tds: 'TDS (Tax Deducted at Source) Detailed Report'
		};
		
		document.getElementById('reportModalTitle').textContent = titleMap[type] || 'Report';
		
		const thead = document.getElementById('reportTableHead');
		const tbody = document.getElementById('reportTableBody');
		const noData = document.getElementById('reportNoData');
		
		if (!data || data.length === 0) {
			thead.innerHTML = '';
			tbody.innerHTML = '';
			noData.classList.remove('d-none');
			return;
		}
		
		noData.classList.add('d-none');
		
		// Build headers and rows based on report type
		let headers = [];
		let rowFn = null;
		
		if (type === 'pf') {
			headers = ['Emp ID', 'Name', 'Department', 'UAN', 'Basic Wages', 'Employee Share', 'Employer Share', 'Total PF'];
			rowFn = (r) => `
				<td>${r.empId || '-'}</td>
				<td>${r.employeeName || '-'}</td>
				<td>${r.department || '-'}</td>
				<td>${r.uan || '-'}</td>
				<td>₹${(r.basicWages || 0).toLocaleString()}</td>
				<td>₹${(r.employeeShare || 0).toLocaleString()}</td>
				<td>₹${(r.employerShare || 0).toLocaleString()}</td>
				<td><strong>₹${(r.pfAmount || 0).toLocaleString()}</strong></td>
			`;
		} else if (type === 'esi') {
			headers = ['Emp ID', 'Name', 'Department', 'ESI Number', 'Gross Wages', 'Employee Share', 'Employer Share', 'Total ESI'];
			rowFn = (r) => `
				<td>${r.empId || '-'}</td>
				<td>${r.employeeName || '-'}</td>
				<td>${r.department || '-'}</td>
				<td>${r.esiNumber || '-'}</td>
				<td>₹${(r.grossWages || 0).toLocaleString()}</td>
				<td>₹${(r.employeeShare || 0).toLocaleString()}</td>
				<td>₹${(r.employerShare || 0).toLocaleString()}</td>
				<td><strong>₹${(r.totalContribution || 0).toLocaleString()}</strong></td>
			`;
		} else if (type === 'pt') {
			headers = ['Emp ID', 'Name', 'Department', 'State', 'Gross Salary', 'PT Amount'];
			rowFn = (r) => `
				<td>${r.empId || '-'}</td>
				<td>${r.employeeName || '-'}</td>
				<td>${r.department || '-'}</td>
				<td>${r.state || '-'}</td>
				<td>₹${(r.grossSalary || 0).toLocaleString()}</td>
				<td><strong>₹${(r.ptAmount || 0).toLocaleString()}</strong></td>
			`;
		} else if (type === 'tds') {
			headers = ['Emp ID', 'Name', 'Department', 'PAN', 'Taxable Income', 'Tax Rate', 'TDS Amount'];
			rowFn = (r) => `
				<td>${r.empId || '-'}</td>
				<td>${r.employeeName || '-'}</td>
				<td>${r.department || '-'}</td>
				<td>${r.pan || '-'}</td>
				<td>₹${(r.taxableIncome || 0).toLocaleString()}</td>
				<td>${r.effectiveRate || 0}%</td>
				<td><strong>₹${(r.tdsAmount || 0).toLocaleString()}</strong></td>
			`;
		}
		
		thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
		tbody.innerHTML = data.map(r => '<tr>' + rowFn(r) + '</tr>').join('');
	}

	function exportCurrentReport(format) {
		if (!currentReportData || !currentReportData.length) {
			showToast('No data to export', 'warning');
			return;
		}
		
		exportToCSV(currentReportData, `${currentReportType}-report-${selectedRunId}.csv`);
	}

	async function exportReport(type, format) {
		if (!selectedRunId) {
			showToast('No payroll run selected', 'warning');
			return;
		}

		const token = localStorage.getItem('accessToken');
		try {
			const res = await fetch(`/api/admin/payroll/statutory/${selectedRunId}/${type}`, {
				credentials: 'include',
				headers: { ...(token ? { 'Authorization': `Bearer ${token}` } : {}) }
			});
			
			const data = await res.json();
			if (!data.data || !data.data.length) {
				showToast('No data to export', 'warning');
				return;
			}
			
			exportToCSV(data.data, `${type}-report-${selectedRunId}.csv`);
			showToast(`${type.toUpperCase()} report exported`, 'success');
		} catch (err) {
			showToast('Export failed: ' + err.message, 'danger');
		}
	}

	function exportToCSV(data, filename) {
		if (!data || !data.length) return;
		
		const headers = Object.keys(data[0]);
		const csvRows = [headers.join(',')];
		
		for (const row of data) {
			const values = headers.map(h => {
				const val = row[h];
				if (val === null || val === undefined) return '';
				const str = String(val).replace(/"/g, '""');
				return `"${str}"`;
			});
			csvRows.push(values.join(','));
		}
		
		const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = filename;
		a.click();
		URL.revokeObjectURL(url);
	}

	async function exportAllReports() {
		if (!selectedRunId) {
			showToast('No payroll run selected', 'warning');
			return;
		}

		showToast('Exporting all reports...', 'info');
		
		const types = ['pf', 'esi', 'pt', 'tds'];
		for (const type of types) {
			await exportReport(type, 'csv');
		}
		
		showToast('All reports exported!', 'success');
	}

	function showToast(message, type = 'info') {
		const alertDiv = document.createElement('div');
		alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
		alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
		alertDiv.innerHTML = `
			${message}
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		`;
		document.body.appendChild(alertDiv);
		setTimeout(() => alertDiv.remove(), 4000);
	}
</script>