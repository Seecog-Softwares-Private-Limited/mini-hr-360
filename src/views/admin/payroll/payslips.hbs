{{!-- Admin Payslips --}}
<div class="container-fluid">
	<div class="row">
		<div class="col-md-3 col-lg-2 px-0">
			{{> sidebar active="payroll-payslips" activeGroup="payroll"}}
		</div>

		<div class="col-md-9 col-lg-10">
			<div class="main-content p-4">
				<nav aria-label="breadcrumb">
					<ol class="breadcrumb mb-3 bg-transparent p-0">
						<li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
						<li class="breadcrumb-item"><a href="/admin/payroll/runs">Payroll Runs</a></li>
						<li class="breadcrumb-item active" aria-current="page">Payslips</li>
					</ol>
				</nav>

				<div class="d-flex align-items-center justify-content-between mb-4">
					<div>
						<h2 class="mb-1">Payslips</h2>
						{{#if error}}
						<div class="alert alert-danger mt-3">
							<i class="fa-solid fa-triangle-exclamation me-2"></i>
							<strong>Error:</strong> {{error}}
						</div>
						{{/if}}
						{{#if noRuns}}
						<div class="alert alert-warning mt-3">
							<i class="fa-solid fa-info-circle me-2"></i>
							No payroll runs found. <a href="/admin/payroll/runs">Create a payroll run</a> first.
						</div>
						{{else}}
						<small class="text-muted">{{periodDisplay}} | Run ID: {{runId}}</small>
						{{/if}}
					</div>
					<div class="d-flex gap-2">
						{{#unless noRuns}}
						<select class="form-select form-select-sm" id="runSelector" onchange="switchRun(this.value)" style="width: auto;">
							<option value="{{runId}}" selected>Current Run: {{periodDisplay}}</option>
						</select>
						{{/unless}}
						<button type="button" class="btn btn-outline-primary" onclick="listRuns()">
							<i class="fa-solid fa-arrow-left me-2"></i>Back to runs
						</button>
					</div>
				</div>

				<div id="alertContainer"></div>

				<!-- Bulk Actions -->
				<div class="card mb-4 shadow-sm border-0">
					<div class="card-body">
						<div class="row align-items-center">
							<div class="col-md-4">
								<div class="form-check form-switch">
									<input class="form-check-input" type="checkbox" id="selectAllPayslips"
										onchange="toggleSelectAll(this)">
									<label class="form-check-label" for="selectAllPayslips">
										<strong>Select All</strong>
									</label>
								</div>
							</div>
							<div class="col-md-8 text-end">
								<div class="btn-group shadow-sm" role="group">
									<button type="button" id="btnGenerate" class="btn btn-primary"
										onclick="generateAll()">
										<i class="fa-solid fa-file-pdf me-2"></i>Generate All
									</button>
									<button type="button" id="btnPublish" class="btn btn-success"
										onclick="publishAll()">
										<i class="fa-solid fa-paper-plane me-2"></i>Publish All
									</button>
									<button type="button" class="btn btn-warning" onclick="holdSelected()">
										<i class="fa-solid fa-pause-circle me-2"></i>Hold Selected
									</button>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Payslips Table -->
				<div class="card shadow-sm border-0">
					<div
						class="card-header bg-white py-3 d-flex justify-content-between align-items-center border-bottom">
						<h6 class="mb-0 fw-bold">Employee Payslips</h6>
						<div class="input-group" style="width: 250px;">
							<span class="input-group-text bg-transparent border-end-0"><i
									class="fa-solid fa-magnifying-glass text-muted"></i></span>
							<input type="text" class="form-control border-start-0 ps-0" placeholder="Search employee..."
								id="searchInput" onkeyup="filterTable()">
						</div>
					</div>
					<div class="card-body p-0">
						<div class="table-responsive">
							<table class="table table-hover align-middle mb-0">
								<thead class="bg-light">
									<tr>
										<th style="width: 40px; padding-left: 1.5rem;"><input
												class="form-check-input payslip-checkbox-parent" type="checkbox"
												onchange="toggleSelectAll(this)"></th>
										<th>Employee</th>
										<th>Net Pay</th>
										<th class="text-center">Bank Status</th>
										<th class="text-center">Status</th>
										<th class="text-end" style="padding-right: 1.5rem;">Actions</th>
									</tr>
								</thead>
								<tbody>
									{{#if payslips.length}}
									{{#each payslips}}
									<tr data-employee="{{this.empName}}" class="payslip-row">
										<td style="padding-left: 1.5rem;">
											<input class="form-check-input payslip-checkbox" type="checkbox"
												data-id="{{this.id}}">
										</td>
										<td>
											<div class="d-flex align-items-center">
												<div class="avatar-sm bg-primary bg-opacity-10 text-primary rounded-circle me-3 d-flex align-items-center justify-content-center fw-bold"
													style="width: 32px; height: 32px; font-size: 12px;">
													{{#if this.empName}}{{slice this.empName 0 1}}{{else}}?{{/if}}
												</div>
												<div>
													<strong class="d-block">{{this.empName}}</strong>
													<small class="text-muted">{{this.empId}} •
														{{this.department}}</small>
												</div>
											</div>
										</td>
										<td><span class="fw-bold">₹{{#if
												this.netPay}}{{this.netPay}}{{else}}0.00{{/if}}</span></td>
										<td class="text-center">
											{{#if this.bankStatus}}
											<span
												class="badge rounded-pill bg-success-subtle text-success border border-success border-opacity-25 px-3">Verified</span>
											{{else}}
											<span
												class="badge rounded-pill bg-warning-subtle text-warning border border-warning border-opacity-25 px-3 text-dark">Pending</span>
											{{/if}}
										</td>
										<td class="text-center">
											{{#if (eq this.status 'Published')}}
											<span class="badge rounded-pill bg-success px-3">Published</span>
											{{else if (eq this.status 'Held')}}
											<span class="badge rounded-pill bg-danger px-3">Held</span>
											{{else}}
											<span class="badge rounded-pill bg-info px-3">{{this.status}}</span>
											{{/if}}
										</td>
										<td class="text-end" style="padding-right: 1.5rem;">
											<div class="btn-group btn-group-sm rounded shadow-sm">
												<button class="btn btn-white border" onclick="viewPayslip({{this.id}})"
													title="Preview">
													<i class="fa-solid fa-eye text-primary"></i>
												</button>
												{{#if this.pdfUrl}}
												<a href="/api/admin/payroll/payslips/download/{{this.id}}"
													class="btn btn-white border" title="Download PDF">
													<i class="fa-solid fa-download text-success"></i>
												</a>
												{{else}}
												<button class="btn btn-white border" disabled title="Not Generated">
													<i class="fa-solid fa-download text-muted"></i>
												</button>
												{{/if}}
											</div>
										</td>
									</tr>
									{{/each}}
									{{else}}
									<tr>
										<td colspan="6" class="text-center text-muted py-5">
											<div class="mb-3">
												<i class="fa-solid fa-file-invoice-dollar"
													style="font-size: 48px; opacity: 0.1;"></i>
											</div>
											<h5 class="fw-normal">No payslips found</h5>
											<p class="small mb-0">Generate payslips for this run to populate this list.
											</p>
										</td>
									</tr>
									{{/if}}
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Payslip Preview Modal -->
<div class="modal fade" id="payslipModal" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content border-0 shadow-lg">
			<div class="modal-header bg-primary text-white py-3">
				<h5 class="modal-title fw-bold"><i class="fa-solid fa-file-invoice-dollar me-2"></i>Payslip Preview</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body p-0 bg-light" id="payslipContent">
				<div class="text-center p-5 text-muted" id="modalLoader">
					<div class="spinner-border text-primary mb-3" role="status"></div>
					<p>Loading payslip details...</p>
				</div>
				<div id="payslipDetail" style="display: none;">
					<!-- Dynamic Content Here -->
				</div>
			</div>
			<div class="modal-footer bg-white border-top py-3">
				<button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Close</button>
				<button type="button" id="btnModalDownload" class="btn btn-primary px-4">
					<i class="fa-solid fa-download me-2"></i>Download PDF
				</button>
			</div>
		</div>
	</div>
</div>

<script>
	const runId = '{{runId}}';
	const PAYROLL_BASE_URL = '/api/admin/payroll';

	function listRuns() {
		window.location.href = '/admin/payroll/runs';
	}

	function filterTable() {
		const query = document.getElementById('searchInput').value.toLowerCase();
		document.querySelectorAll('.payslip-row').forEach(row => {
			const employee = row.getAttribute('data-employee').toLowerCase();
			row.style.display = employee.includes(query) ? '' : 'none';
		});
	}

	function toggleSelectAll(checkbox) {
		document.querySelectorAll('.payslip-checkbox, .payslip-checkbox-parent').forEach(el => el.checked = checkbox.checked);
	}

	async function payrollApiCall(url, method = 'GET', body = null) {
		try {
			const token = localStorage.getItem('accessToken');
			const options = {
				method,
				credentials: 'include',
				headers: {
					'Content-Type': 'application/json',
					...(token ? { 'Authorization': `Bearer ${token}` } : {})
				},
			};
			if (body) options.body = JSON.stringify(body);

			const response = await fetch(url, options);
			const result = await response.json();

			if (!response.ok) throw new Error(result.message || 'API Error');
			return result;
		} catch (err) {
			showToast(err.message, 'danger');
			console.error(err);
			return null;
		}
	}

	async function generateAll() {
		const btn = document.getElementById('btnGenerate');
		const originalContent = btn.innerHTML;
		btn.disabled = true;
		btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';

		const result = await payrollApiCall(`${PAYROLL_BASE_URL}/payslips/${runId}/generate`, 'POST');
		if (result) {
			showToast(result.message, 'success');
			setTimeout(() => location.reload(), 1500);
		} else {
			btn.disabled = false;
			btn.innerHTML = originalContent;
		}
	}

	async function publishAll() {
		if (!confirm('Publish all generated payslips? This will make them visible to employees.')) return;

		const btn = document.getElementById('btnPublish');
		const originalContent = btn.innerHTML;
		btn.disabled = true;
		btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Publishing...';

		const result = await payrollApiCall(`${PAYROLL_BASE_URL}/payslips/${runId}/publish`, 'POST');
		if (result) {
			showToast('All payslips published successfully!', 'success');
			setTimeout(() => location.reload(), 1500);
		} else {
			btn.disabled = false;
			btn.innerHTML = originalContent;
		}
	}

	function holdSelected() {
		const selected = Array.from(document.querySelectorAll('.payslip-checkbox:checked')).map(cb => cb.dataset.id);
		if (selected.length === 0) {
			alert('Please select at least one payslip');
			return;
		}
		showToast(`${selected.length} payslip(s) placed on hold (Not implemented yet)`, 'info');
	}

	async function viewPayslip(id) {
		const modal = new bootstrap.Modal(document.getElementById('payslipModal'));
		const loader = document.getElementById('modalLoader');
		const detail = document.getElementById('payslipDetail');
		const btnDownload = document.getElementById('btnModalDownload');

		loader.style.display = 'block';
		detail.style.display = 'none';
		btnDownload.onclick = () => window.location.href = `${PAYROLL_BASE_URL}/payslips/download/${id}`;

		modal.show();

		const result = await payrollApiCall(`${PAYROLL_BASE_URL}/payslips/preview/${id}`);
		if (result && result.data) {
			const payslip = result.data;

			let earningsHtml = '';
			for (const [key, val] of Object.entries(payslip.earnings || {})) {
				earningsHtml += `<tr><td>${key}</td><td class="text-end">₹${val}</td></tr>`;
			}

			let deductionsHtml = '';
			for (const [key, val] of Object.entries(payslip.deductions || {})) {
				deductionsHtml += `<tr><td>${key}</td><td class="text-end">₹${val}</td></tr>`;
			}

			detail.innerHTML = `
			<div class="bg-white p-5 mx-auto" style="max-width: 800px; box-shadow: 0 0 40px rgba(0,0,0,0.05); border-radius: 8px; margin: 20px;">
				<div class="text-center mb-5 border-bottom pb-4">
					<h3 class="fw-bold mb-1 text-uppercase letter-spacing-1">EMPLOYEE PAYSLIP</h3>
					<p class="text-muted mb-0">${payslip.periodMonth}/${payslip.periodYear}</p>
				</div>
				
				<div class="row g-4 mb-5">
					<div class="col-6">
						<small class="text-uppercase text-muted d-block mb-1" style="font-size: 10px; font-weight: 700;">Employee Information</small>
						<div class="ps-1">
							<h6 class="mb-1 fw-bold">${payslip.employee?.empName || 'Unknown'}</h6>
							<p class="small mb-0">${payslip.employee?.empId || '-'} | ${payslip.employee?.empDesignation || '-'}</p>
							<p class="small mb-0 text-muted">${payslip.employee?.empDepartment || '-'}</p>
						</div>
					</div>
					<div class="col-6 text-end">
						<small class="text-uppercase text-muted d-block mb-1" style="font-size: 10px; font-weight: 700;">Bank Details</small>
						<p class="small mb-0">Status: <span class="badge ${payslip.employee?.bankDetails ? 'bg-success' : 'bg-warning'} rounded-pill">${payslip.employee?.bankDetails ? 'Verified' : 'Pending'}</span></p>
					</div>
				</div>

				<div class="row g-5">
					<div class="col-md-6">
						<h6 class="fw-bold border-bottom pb-2 mb-3"><i class="fa-solid fa-plus-circle text-success me-2 small"></i>Earnings</h6>
						<table class="table table-sm table-borderless small">
							<tbody>${earningsHtml}</tbody>
						</table>
					</div>
					<div class="col-md-6">
						<h6 class="fw-bold border-bottom pb-2 mb-3"><i class="fa-solid fa-minus-circle text-danger me-2 small"></i>Deductions</h6>
						<table class="table table-sm table-borderless small">
							<tbody>${deductionsHtml}</tbody>
						</table>
					</div>
				</div>

				<div class="mt-5 p-4 bg-primary bg-opacity-10 rounded-4 border border-primary border-opacity-10">
					<div class="d-flex justify-content-between align-items-center">
						<span class="fw-bold text-primary">NET TAKE HOME PAY</span>
						<h2 class="fw-bold mb-0 text-primary">₹${payslip.netPay}</h2>
					</div>
				</div>
				
				<div class="mt-5 pt-4 text-center border-top">
					<p class="text-muted small mb-0 italic">This is a system generated document. No signature required.</p>
				</div>
			</div>
		`;

			loader.style.display = 'none';
			detail.style.display = 'block';
		}
	}

	function showToast(message, type = 'info') {
		const container = document.getElementById('alertContainer');
		const id = 'alert_' + Date.now();
		container.innerHTML = `
		<div id="${id}" class="alert alert-${type} alert-dismissible fade show shadow-sm border-0 mb-4 animate__animated animate__fadeInDown" role="alert">
			<i class="fa-solid ${type === 'danger' ? 'fa-circle-xmark' : 'fa-circle-check'} me-2"></i>
			${message}
			<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
		</div>
	`;
		setTimeout(() => {
			const el = document.getElementById(id);
			if (el) {
				el.classList.remove('animate__fadeInDown');
				el.classList.add('animate__fadeOutUp');
				setTimeout(() => el.remove(), 500);
			}
		}, 4000);
	}

	function switchRun(runId) {
		if (runId) {
			window.location.href = `/admin/payroll/payslips/${runId}`;
		}
	}

	async function loadAvailableRuns() {
		try {
			const token = localStorage.getItem('accessToken');
			const res = await fetch('/api/admin/payroll/runs', {
				headers: {
					'Content-Type': 'application/json',
					...(token ? { 'Authorization': `Bearer ${token}` } : {})
				},
				credentials: 'include'
			});
			const data = await res.json();
			
			if (res.ok && data.data) {
				const selector = document.getElementById('runSelector');
				const currentRunId = {{#if runId}}{{runId}}{{else}}null{{/if}};
				if (selector && data.data.length > 0) {
					selector.innerHTML = '';
					data.data.forEach(run => {
						const period = `${run.periodYear}-${String(run.periodMonth).padStart(2, '0')}`;
						const option = document.createElement('option');
						option.value = run.id;
						option.textContent = `${period} (${run.status})`;
						if (run.id === currentRunId) option.selected = true;
						selector.appendChild(option);
					});
				}
			}
		} catch (err) {
			console.error('Error loading runs:', err);
		}
	}

	// Load available runs on page load
	document.addEventListener('DOMContentLoaded', loadAvailableRuns);
</script>

<style>
	.letter-spacing-1 {
		letter-spacing: 1px;
	}

	.italic {
		font-style: italic;
	}

	.bg-success-subtle {
		background-color: #d1e7dd !important;
	}

	.bg-warning-subtle {
		background-color: #fff3cd !important;
	}

	.bg-primary-subtle {
		background-color: #cfe2ff !important;
	}
</style>