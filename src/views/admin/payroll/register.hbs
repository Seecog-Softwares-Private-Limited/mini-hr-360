{{!-- Admin Payroll Register --}}
<div class="container-fluid">
	<div class="row">
		<div class="col-md-3 col-lg-2 px-0">
			{{> sidebar active="payroll-register" activeGroup="workspace"}}
		</div>

		<div class="col-md-9 col-lg-10">
			<div class="main-content p-4">
				<nav aria-label="breadcrumb">
					<ol class="breadcrumb mb-3 bg-transparent p-0">
						<li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
						<li class="breadcrumb-item"><a href="/admin/payroll/runs">Payroll Runs</a></li>
						<li class="breadcrumb-item active" aria-current="page">Payroll Register</li>
					</ol>
				</nav>

				<div class="d-flex align-items-center justify-content-between mb-4">
					<div>
						<h2 class="mb-1">Payroll Register</h2>
						{{#if error}}
						<div class="alert alert-danger mt-3">
							<i class="fa-solid fa-triangle-exclamation me-2"></i>
							<strong>Error:</strong> {{error}}
						</div>
						{{/if}}
						{{#if noRuns}}
						<div class="alert alert-warning mt-3">
							<i class="fa-solid fa-info-circle me-2"></i>
							No payroll runs found. <a href="/admin/payroll/runs">Create a payroll run</a> first.
						</div>
						{{else}}
						<small class="text-muted">{{period}} | Run ID: {{runId}} | 
							{{#if (eq status 'Draft')}}<span class="badge bg-secondary">Draft</span>
							{{else if (eq status 'Processing')}}<span class="badge bg-warning text-dark">Processing</span>
							{{else if (eq status 'Approved')}}<span class="badge bg-success">Approved</span>
							{{else if (eq status 'Locked')}}<span class="badge bg-danger">Locked</span>
							{{else if (eq status 'Paid')}}<span class="badge bg-primary">Paid</span>
							{{else}}<span class="badge bg-info">{{status}}</span>
							{{/if}}
						</small>
						{{/if}}
					</div>
					<div class="d-flex gap-2">
						{{#unless noRuns}}
						<select class="form-select form-select-sm" id="runSelector" onchange="switchRun(this.value)" style="width: auto;">
							<option value="{{runId}}" selected>Current Run: {{period}}</option>
						</select>
						<button class="btn btn-outline-secondary" onclick="exportRegister()">
							<i class="fa-solid fa-file-export me-1"></i>Export
						</button>
						{{/unless}}
					</div>
				</div>

				<!-- KPI Cards -->
				<div class="row mb-4 gy-3">
					<div class="col-md-3">
						<div class="card text-center" style="border-left: 4px solid #4f46e5;">
							<div class="card-body py-3">
								<small class="text-muted">Total Employees</small>
								<div style="font-size: 1.75rem; font-weight: 800; color: #4f46e5;">
									{{stats.employeeCount}}</div>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="card text-center" style="border-left: 4px solid #22c55e;">
							<div class="card-body py-3">
								<small class="text-muted">Total Earnings</small>
								<div style="font-size: 1.75rem; font-weight: 800; color: #22c55e;">
									₹{{stats.totalEarnings}}</div>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="card text-center" style="border-left: 4px solid #f59e0b;">
							<div class="card-body py-3">
								<small class="text-muted">Total Deductions</small>
								<div style="font-size: 1.75rem; font-weight: 800; color: #f59e0b;">
									₹{{stats.totalDeductions}}</div>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="card text-center" style="border-left: 4px solid #06b6d4;">
							<div class="card-body py-3">
								<small class="text-muted">Net Pay (Total)</small>
								<div style="font-size: 1.75rem; font-weight: 800; color: #06b6d4;">₹{{stats.netPay}}
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Payroll Table -->
				<div class="card">
					<div class="card-header d-flex justify-content-between align-items-center">
						<h6 class="mb-0">Employee Payroll Details</h6>
						<div class="btn-group btn-group-sm">
							<input type="text" class="form-control form-control-sm" placeholder="Search employee..."
								style="width: 200px;" id="searchInput" onkeyup="filterTable()">
						</div>
					</div>
					<div class="card-body p-0">
						<div class="table-responsive">
							<table class="table table-hover mb-0">
								<thead class="table-light">
									<tr>
										<th>Employee</th>
										<th>Dept</th>
										<th>LOP Days</th>
										<th>Earnings</th>
										<th>Deductions</th>
										<th>Net Pay</th>
										<th>Exceptions</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody>
									{{#if employees.length}}
									{{#each employees}}
									<tr data-employee="{{this.empName}}">
										<td>
											<strong>{{this.empName}}</strong>
											<small class="d-block text-muted">{{this.empId}}</small>
										</td>
										<td>{{this.department}}</td>
										<td>{{this.lopDays}}</td>
										<td class="text-success"><strong>₹{{this.earnings}}</strong></td>
										<td class="text-danger"><strong>₹{{this.deductions}}</strong></td>
										<td><strong>₹{{this.netPay}}</strong></td>
										<td>
											{{#if this.exceptions.length}}
											{{#each this.exceptions}}
											<span class="badge bg-warning text-dark me-1 mb-1"
												title="{{this}}">{{this}}</span>
											{{/each}}
											{{else}}
											<small class="text-muted">—</small>
											{{/if}}
										</td>
										<td>
											<div class="btn-group btn-group-sm">
												<button class="btn btn-outline-primary"
													onclick="viewBreakdown({{this.id}})" title="View breakdown">
													<i class="fa-solid fa-eye"></i>
												</button>
												<button class="btn btn-outline-secondary"
													onclick="addAdjustment({{this.id}})" title="Add adjustment">
													<i class="fa-solid fa-plus"></i>
												</button>
											</div>
										</td>
									</tr>
									{{/each}}
									{{else}}
									<tr>
										<td colspan="8" class="text-center text-muted py-4">
											<i class="fa-solid fa-inbox"
												style="font-size: 24px; opacity: 0.3; display: block; margin-bottom: 10px;"></i>
											No employees in this payroll run
										</td>
									</tr>
									{{/if}}
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Breakdown Modal -->
<div class="modal fade" id="breakdownModal" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Payroll Breakdown</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body" id="breakdownContent">
				<!-- Populated dynamically -->
			</div>
		</div>
	</div>
</div>

<!-- Add Adjustment Modal -->
<div class="modal fade" id="adjustmentModal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Add Adjustment</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<input type="hidden" id="adjItemId">
				<form id="adjustmentForm">
					<div class="mb-3">
						<label class="form-label fw-600">Adjustment Type</label>
						<select class="form-select" id="adjType" required>
							<option value="" selected disabled>Select type...</option>
							<option value="bonus">Bonus</option>
							<option value="reimbursement">Reimbursement</option>
							<option value="arrears">Arrears</option>
							<option value="deduction">Additional Deduction</option>
							<option value="recovery">Loan Recovery</option>
						</select>
					</div>
					<div class="mb-3">
						<label class="form-label fw-600">Amount</label>
						<input type="number" class="form-control" id="adjAmount" placeholder="0.00" step="0.01"
							required>
					</div>
					<div class="mb-3">
						<label class="form-label fw-600">Description (Optional)</label>
						<textarea class="form-control" id="adjDescription" rows="2"
							placeholder="Enter reason for adjustment"></textarea>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-primary" onclick="saveAdjustment()">Save Adjustment</button>
			</div>
		</div>
	</div>
</div>

<script>
	const employeesData = {{{ json employees }}};

	function filterTable() {
		const query = document.getElementById('searchInput').value.toLowerCase();
		document.querySelectorAll('tbody tr').forEach(row => {
			const employee = row.getAttribute('data-employee').toLowerCase();
			row.style.display = employee.includes(query) ? '' : 'none';
		});
	}

	function viewBreakdown(itemId) {
		const item = employeesData.find(e => e.id === itemId);
		if (!item) return;

		let earningsHtml = '';
		for (const [key, val] of Object.entries(item.earningsJson || {})) {
			earningsHtml += `
			<tr>
				<td class="text-capitalize">${key.replace(/([A-Z])/g, ' $1')}</td>
				<td class="text-end">₹${Number(val).toLocaleString()}</td>
			</tr>
		`;
		}

		let deductionsHtml = '';
		for (const [key, val] of Object.entries(item.deductionsJson || {})) {
			deductionsHtml += `
			<tr>
				<td class="text-capitalize">${key.replace(/([A-Z])/g, ' $1')}</td>
				<td class="text-end">₹${Number(val).toLocaleString()}</td>
			</tr>
		`;
		}

		const content = `
		<div class="row mb-3">
			<div class="col-6">
				<strong>${item.empName}</strong>
				<div class="small text-muted">${item.empId}</div>
			</div>
			<div class="col-6 text-end">
				<strong>${item.department}</strong>
				<div class="small text-muted">LOP Days: ${item.lopDays}</div>
			</div>
		</div>

		<div class="mb-4">
			<h6 class="mb-3">Earnings</h6>
			<div class="table-responsive">
				<table class="table table-sm table-borderless">
					${earningsHtml}
					<tr class="table-light fw-600">
						<td>Total Earnings</td>
						<td class="text-end">₹${Number(item.earnings).toLocaleString()}</td>
					</tr>
				</table>
			</div>
		</div>

		<div class="mb-4">
			<h6 class="mb-3">Deductions</h6>
			<div class="table-responsive">
				<table class="table table-sm table-borderless">
					${deductionsHtml}
					<tr class="table-light fw-600">
						<td>Total Deductions</td>
						<td class="text-end">₹${Number(item.deductions).toLocaleString()}</td>
					</tr>
				</table>
			</div>
		</div>

		<div class="bg-light p-3 rounded border">
			<div class="row">
				<div class="col-6">
					<small class="text-muted">Gross Pay</small>
					<div class="h6">₹${Number(item.earnings).toLocaleString()}</div>
				</div>
				<div class="col-6 text-end">
					<small class="text-muted">Net Pay</small>
					<div class="h6 text-primary" style="font-weight: 800;">₹${Number(item.netPay).toLocaleString()}</div>
				</div>
			</div>
		</div>
	`;
		document.getElementById('breakdownContent').innerHTML = content;
		new bootstrap.Modal(document.getElementById('breakdownModal')).show();
	}

	function addAdjustment(itemId) {
		document.getElementById('adjItemId').value = itemId;
		document.getElementById('adjustmentForm').reset();
		new bootstrap.Modal(document.getElementById('adjustmentModal')).show();
	}

	async function saveAdjustment() {
		const itemId = document.getElementById('adjItemId').value;
		const type = document.getElementById('adjType').value;
		const amount = document.getElementById('adjAmount').value;
		const description = document.getElementById('adjDescription').value;

		if (!type || !amount) {
			showToast('Adjustment type and amount are required', 'warning');
			return;
		}

		showToast('Saving adjustment...', 'info');

		try {
			const token = localStorage.getItem('accessToken');
			const res = await fetch('/api/admin/payroll/register/adjustment', {
				method: 'POST',
				credentials: 'include',
				headers: {
					'Content-Type': 'application/json',
					...(token ? { 'Authorization': `Bearer ${token}` } : {})
				},
				body: JSON.stringify({ itemId, type, amount, description })
			});
			const data = await res.json();

			if (res.ok) {
				showToast('Adjustment saved successfully!', 'success');
				setTimeout(() => window.location.reload(), 1000);
			} else {
				showToast(data.message || 'Failed to save adjustment', 'danger');
			}
		} catch (err) {
			console.error('Adjustment error:', err);
			showToast('Error saving adjustment', 'danger');
		}
	}

	function exportRegister() {
		const rows = [];
		const headers = ['Employee Name', 'Employee ID', 'Department', 'LOP Days', 'Earnings', 'Deductions', 'Net Pay'];
		rows.push(headers);

		employeesData.forEach(emp => {
			rows.push([
				emp.empName,
				emp.empId,
				emp.department,
				emp.lopDays,
				emp.earnings,
				emp.deductions,
				emp.netPay
			]);
		});

		let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
		const encodedUri = encodeURI(csvContent);
		const link = document.createElement("a");
		link.setAttribute("href", encodedUri);
		link.setAttribute("download", `payroll_register_run_{{runId}}.csv`);
		document.body.appendChild(link);
		link.click();
		document.body.removeChild(link);

		showToast('Payroll register exported as CSV', 'success');
	}

	function switchRun(runId) {
		if (runId) {
			window.location.href = `/admin/payroll/register/${runId}`;
		}
	}

	async function loadAvailableRuns() {
		try {
			const token = localStorage.getItem('accessToken');
			const res = await fetch('/api/admin/payroll/runs', {
				headers: {
					'Content-Type': 'application/json',
					...(token ? { 'Authorization': `Bearer ${token}` } : {})
				},
				credentials: 'include'
			});
			const data = await res.json();
			
			if (res.ok && data.data) {
				const selector = document.getElementById('runSelector');
				const currentRunId = {{#if runId}}{{runId}}{{else}}null{{/if}};
				if (selector && data.data.length > 0) {
					selector.innerHTML = '';
					data.data.forEach(run => {
						const period = `${run.periodYear}-${String(run.periodMonth).padStart(2, '0')}`;
						const option = document.createElement('option');
						option.value = run.id;
						option.textContent = `${period} (${run.status})`;
						if (run.id === currentRunId) option.selected = true;
						selector.appendChild(option);
					});
				}
			}
		} catch (err) {
			console.error('Error loading runs:', err);
		}
	}

	// Load available runs on page load
	document.addEventListener('DOMContentLoaded', loadAvailableRuns);

	function showToast(message, type = 'info') {
		const alertDiv = document.createElement('div');
		alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
		alertDiv.style.position = 'fixed';
		alertDiv.style.top = '20px';
		alertDiv.style.right = '20px';
		alertDiv.style.zIndex = '9999';
		alertDiv.setAttribute('role', 'alert');
		alertDiv.innerHTML = `
		${message}
		<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
	`;
		document.body.appendChild(alertDiv);
		setTimeout(() => alertDiv.remove(), 4000);
	}
</script>