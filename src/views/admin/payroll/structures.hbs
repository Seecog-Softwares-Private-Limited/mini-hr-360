{{!-- Admin Salary Structures --}}
<div class="container-fluid">
	<div class="row">
		<div class="col-md-3 col-lg-2 px-0">
			{{> sidebar active="payroll-structures" activeGroup="workspace"}}
		</div>

		<div class="col-md-9 col-lg-10">
			<div class="main-content p-4">
				<nav aria-label="breadcrumb">
					<ol class="breadcrumb mb-3 bg-transparent p-0">
						<li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
						<li class="breadcrumb-item active" aria-current="page">Salary Structures</li>
					</ol>
				</nav>

				<div class="d-flex align-items-center justify-content-between mb-4">
					<div>
						<h2 class="mb-1">Salary Structures</h2>
						<p class="text-muted mb-0">Manage salary structures and assign to employees</p>
					</div>
					<button class="btn btn-primary" onclick="openCreateStructureModal()">
						<i class="fa-solid fa-plus me-2"></i>Create Structure
					</button>
				</div>

				<div class="row gy-4">
					<!-- Structures List (Left Column) -->
					<div class="col-md-5">
						<div class="card">
							<div class="card-header">
								<h6 class="mb-0">Salary Structures</h6>
							</div>
							<div class="card-body p-0">
								{{#if structures}}
									<div class="list-group list-group-flush">
										{{#each structures}}
										<a href="#" class="list-group-item list-group-item-action p-3 structure-item" data-id="{{this.id}}" onclick="selectStructure({{this.id}}); return false;">
											<div class="d-flex justify-content-between align-items-start">
												<div>
													<h6 class="mb-1">{{this.name}}</h6>
													<small class="text-muted">Effective: {{this.effectiveDate}}</small>
												</div>
												<div>
													{{#if this.isActive}}
														<span class="badge bg-success">Active</span>
													{{else}}
														<span class="badge bg-secondary">Inactive</span>
													{{/if}}
												</div>
											</div>
											<div class="mt-2">
												<small class="text-muted">v{{this.version}} • Updated {{this.updatedAt}}</small>
											</div>
											<div class="mt-2">
												<small class="badge bg-light text-dark">{{this.assignedCount}} employees</small>
											</div>
										</a>
										{{/each}}
									</div>
								{{else}}
									<div class="p-4 text-center text-muted">
										<i class="fa-solid fa-inbox" style="font-size: 32px; opacity: 0.3; display: block; margin-bottom: 10px;"></i>
										<p>No structures created yet</p>
										<button class="btn btn-sm btn-primary" onclick="openCreateStructureModal()">Create First Structure</button>
									</div>
								{{/if}}
							</div>
						</div>
					</div>

					<!-- Structure Details (Right Column) -->
					<div class="col-md-7">
						<div class="card">
							<div class="card-header d-flex justify-content-between align-items-center">
								<h6 class="mb-0">Structure Details</h6>
								<div class="btn-group btn-group-sm">
									<button class="btn btn-outline-secondary" onclick="editStructure()"><i class="fa-solid fa-pen me-1"></i>Edit</button>
									<button class="btn btn-outline-primary" onclick="assignToEmployees()"><i class="fa-solid fa-user-plus me-1"></i>Assign</button>
								</div>
							</div>
							<div class="card-body" id="structureDetails">
								<div class="text-center text-muted py-5">
									<i class="fa-solid fa-select" style="font-size: 32px; opacity: 0.3; display: block; margin-bottom: 10px;"></i>
									<p>Select a structure to view details</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Create/Edit Structure Modal -->
<div class="modal fade" id="structureModal" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="structureModalTitle">Create Salary Structure</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<form id="structureForm">
					<div class="row mb-3">
						<div class="col-md-6">
							<label class="form-label fw-600">Structure Name</label>
							<input type="text" class="form-control" placeholder="e.g., Standard IT" required>
						</div>
						<div class="col-md-6">
							<label class="form-label fw-600">Effective Date</label>
							<input type="date" class="form-control" required>
						</div>
					</div>

					<div class="mb-3">
						<label class="form-label fw-600">Description</label>
						<textarea class="form-control" rows="2" placeholder="Brief description of this structure"></textarea>
					</div>

					<div class="mb-3">
						<h6 class="mb-3">Components</h6>
						<div id="componentsList">
							<div class="row component-row mb-3 align-items-end">
								<div class="col-md-4">
									<label class="form-label small">Component</label>
									<select class="form-select form-select-sm">
										<option>Select component...</option>
										<option>Basic Salary</option>
										<option>Dearness Allowance</option>
										<option>House Rent Allowance</option>
									</select>
								</div>
								<div class="col-md-4">
									<label class="form-label small">Calculation Type</label>
									<select class="form-select form-select-sm">
										<option>Fixed Amount</option>
										<option>% of Basic</option>
										<option>% of CTC</option>
									</select>
								</div>
								<div class="col-md-3">
									<label class="form-label small">Value</label>
									<input type="number" class="form-control form-control-sm" placeholder="0" step="0.01">
								</div>
								<div class="col-md-1">
									<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeComponentRow(this)">
										<i class="fa-solid fa-trash"></i>
									</button>
								</div>
							</div>
						</div>
						<button type="button" class="btn btn-sm btn-outline-primary" onclick="addComponentRow()">
							<i class="fa-solid fa-plus me-1"></i>Add Component
						</button>
					</div>

					<hr>

					<div class="card bg-light p-3">
						<div class="row text-center">
							<div class="col-md-4">
								<div class="text-muted small">Monthly CTC</div>
								<div class="h5 mb-0" id="monthlyCTC">₹0</div>
							</div>
							<div class="col-md-4">
								<div class="text-muted small">Annual CTC</div>
								<div class="h5 mb-0" id="annualCTC">₹0</div>
							</div>
							<div class="col-md-4">
								<div class="text-muted small">Deductions/Month</div>
								<div class="h5 mb-0" id="monthlyDeductions">₹0</div>
							</div>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-primary" onclick="saveStructure()">Save Structure</button>
			</div>
		</div>
	</div>
</div>

<!-- Assign to Employees Modal -->
<div class="modal fade" id="assignModal" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Assign Structure to Employees</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<div class="mb-3">
					<label class="form-label fw-600">Effective Date</label>
					<input type="date" class="form-control" required>
				</div>

				<div class="mb-3">
					<label class="form-label fw-600">Search & Select Employees</label>
					<input type="text" class="form-control" placeholder="Type employee name or ID..." id="employeeSearch">
				</div>

				<div style="border: 1px solid #dee2e6; border-radius: 8px; max-height: 300px; overflow-y: auto;">
					<div class="list-group list-group-flush">
						<label class="list-group-item p-3">
							<input class="form-check-input me-2" type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
							<strong>Select All Employees</strong>
						</label>
						{{#each employees}}
						<label class="list-group-item p-3">
							<input class="form-check-input me-2 emp-checkbox" type="checkbox" value="{{this.id}}" data-name="{{this.empName}}">
							<strong>{{this.empName}}</strong>
							<small class="text-muted d-block">{{this.empId}} • {{this.empDepartment}}</small>
						</label>
						{{/each}}
					</div>
				</div>

				<div class="mt-3 p-2 bg-light border rounded">
					<small class="text-muted">Selected: <strong id="selectedCount">0</strong> employees</small>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-primary" onclick="confirmAssignment()">Assign to Selected</button>
			</div>
		</div>
	</div>
</div>

<script>
function openCreateStructureModal() {
	document.getElementById('structureModalTitle').textContent = 'Create Salary Structure';
	new bootstrap.Modal(document.getElementById('structureModal')).show();
}

function editStructure() {
	alert('Edit functionality - will be wired to backend');
}

function assignToEmployees() {
	new bootstrap.Modal(document.getElementById('assignModal')).show();
}

function selectStructure(id) {
	document.querySelectorAll('.structure-item').forEach(el => el.classList.remove('active'));
	document.querySelector(`.structure-item[data-id="${id}"]`).classList.add('active');

	// Sample structure details
	document.getElementById('structureDetails').innerHTML = `
		<h6>Standard IT Structure</h6>
		<small class="text-muted">Effective: 2025-01-01 • v1.0</small>
		<hr>
		<h6 class="mt-3 mb-2">Earnings</h6>
		<div class="table-responsive">
			<table class="table table-sm table-borderless">
				<tr>
					<td>Basic Salary</td>
					<td class="text-end"><strong>₹50,000</strong></td>
				</tr>
				<tr>
					<td>Dearness Allowance</td>
					<td class="text-end"><strong>₹10,000</strong></td>
				</tr>
				<tr>
					<td>House Rent Allowance</td>
					<td class="text-end"><strong>₹15,000</strong></td>
				</tr>
				<tr class="table-light">
					<td><strong>Total Earnings</strong></td>
					<td class="text-end"><strong>₹75,000</strong></td>
				</tr>
			</table>
		</div>
		<h6 class="mt-3 mb-2">Deductions</h6>
		<div class="table-responsive">
			<table class="table table-sm table-borderless">
				<tr>
					<td>Provident Fund (12%)</td>
					<td class="text-end"><strong>₹6,000</strong></td>
				</tr>
				<tr>
					<td>Professional Tax</td>
					<td class="text-end"><strong>₹500</strong></td>
				</tr>
				<tr class="table-light">
					<td><strong>Total Deductions</strong></td>
					<td class="text-end"><strong>₹6,500</strong></td>
				</tr>
			</table>
		</div>
		<hr>
		<div class="row">
			<div class="col-md-4 text-center">
				<small class="text-muted">Monthly CTC</small>
				<div class="h5">₹75,000</div>
			</div>
			<div class="col-md-4 text-center">
				<small class="text-muted">Annual CTC</small>
				<div class="h5">₹9,00,000</div>
			</div>
			<div class="col-md-4 text-center">
				<small class="text-muted">Assigned to</small>
				<div class="h5">12 Employees</div>
			</div>
		</div>
	`;
}

function addComponentRow() {
	const row = document.createElement('div');
	row.className = 'row component-row mb-3 align-items-end';
	row.innerHTML = `
		<div class="col-md-4">
			<select class="form-select form-select-sm">
				<option>Select component...</option>
				<option>Basic Salary</option>
				<option>Dearness Allowance</option>
			</select>
		</div>
		<div class="col-md-4">
			<select class="form-select form-select-sm">
				<option>Fixed Amount</option>
				<option>% of Basic</option>
			</select>
		</div>
		<div class="col-md-3">
			<input type="number" class="form-control form-control-sm" placeholder="0" step="0.01">
		</div>
		<div class="col-md-1">
			<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeComponentRow(this)">
				<i class="fa-solid fa-trash"></i>
			</button>
		</div>
	`;
	document.getElementById('componentsList').appendChild(row);
}

function removeComponentRow(btn) {
	btn.closest('.component-row').remove();
}

function saveStructure() {
	showToast('Salary structure saved successfully!', 'success');
	new bootstrap.Modal(document.getElementById('structureModal')).hide();
}

function toggleSelectAll(checkbox) {
	document.querySelectorAll('.emp-checkbox').forEach(el => el.checked = checkbox.checked);
	updateSelectedCount();
}

function updateSelectedCount() {
	const count = document.querySelectorAll('.emp-checkbox:checked').length;
	document.getElementById('selectedCount').textContent = count;
}

function confirmAssignment() {
	const count = document.querySelectorAll('.emp-checkbox:checked').length;
	if (count === 0) {
		alert('Please select at least one employee');
		return;
	}
	showToast(`Structure assigned to ${count} employee(s)!`, 'success');
	new bootstrap.Modal(document.getElementById('assignModal')).hide();
}

document.getElementById('employeeSearch').addEventListener('input', function(e) {
	const query = e.target.value.toLowerCase();
	document.querySelectorAll('.emp-checkbox').forEach(checkbox => {
		const parent = checkbox.closest('label');
		const name = parent.getAttribute('data-name').toLowerCase();
		parent.style.display = name.includes(query) ? '' : 'none';
	});
});

document.querySelectorAll('.emp-checkbox').forEach(el => {
	el.addEventListener('change', updateSelectedCount);
});

function showToast(message, type = 'info') {
	const alertDiv = document.createElement('div');
	alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
	alertDiv.setAttribute('role', 'alert');
	alertDiv.innerHTML = `
		${message}
		<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
	`;
	document.querySelector('.main-content').insertAdjacentElement('afterbegin', alertDiv);
	setTimeout(() => alertDiv.remove(), 4000);
}

// Initialize with first structure
selectStructure(1);
</script>
