<!-- Allow fully expanded submenus on this page -->
{{! <style>
    /* allow the sidebar to scroll if content exceeds screen height */
    .sidebar {
        max-height: 100vh;
        overflow-y: auto;
        /* <-- key fix */
    }

    /* remove the 200px cap from the global stylesheet */
    .sidebar .submenu.show {
        max-height: none !important;
        /* beat the head CSS */
        overflow: visible !important;
    }
</style> }}

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 px-0">
      {{> sidebar}}
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10 px-0">
      <div class="main-content p-4">
        <div class="mb-4">
          <div class="page-title" style="font-size: 28px;">Dashboard</div>
          <div class="page-subtitle">Welcome back! Here's what's happening with your workspace today.</div>
        </div>

        <!-- Stats -->
        <div class="stat-grid mb-4">
          <div class="stat-card" onclick="window.location.href='/business'">
            <div class="stat-icon" style="background: linear-gradient(135deg,#6366f1,#8b5cf6);">
              <i class="fas fa-building"></i>
            </div>
            <div class="stat-label">Businesses</div>
            <div class="stat-value" id="totalBusinesses">0</div>
            <div class="stat-link">View All <i class="fas fa-arrow-right"></i></div>
          </div>

          <div class="stat-card" onclick="window.location.href='/customers'">
            <div class="stat-icon" style="background: linear-gradient(135deg,#10b981,#22c55e);">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-label">Customers</div>
            <div class="stat-value" id="totalCustomers">0</div>
            <div class="stat-link">View All <i class="fas fa-arrow-right"></i></div>
          </div>

          <div class="stat-card" onclick="window.location.href='/email-templates'">
            <div class="stat-icon" style="background: linear-gradient(135deg,#f59e0b,#f97316);">
              <i class="fas fa-envelope-open-text"></i>
            </div>
            <div class="stat-label">Email Templates</div>
            <div class="stat-value" id="totalEmailTemplates">0</div>
            <div class="stat-link">View All <i class="fas fa-arrow-right"></i></div>
          </div>

          <div class="stat-card" onclick="window.location.href='/templates'">
            <div class="stat-icon" style="background: linear-gradient(135deg,#0ea5e9,#22c55e);">
              <i class="fas fa-file-alt"></i>
            </div>
            <div class="stat-label">WhatsApp Templates</div>
            <div class="stat-value" id="totalTemplates">0</div>
            <div class="stat-link">View All <i class="fas fa-arrow-right"></i></div>
          </div>

          <div class="stat-card" onclick="window.location.href='/campaigns'">
            <div class="stat-icon" style="background: linear-gradient(135deg,#3b82f6,#06b6d4);">
              <i class="fas fa-bullhorn"></i>
            </div>
            <div class="stat-label">Campaigns</div>
            <div class="stat-value" id="totalCampaigns">0</div>
            <div class="stat-link">View All <i class="fas fa-arrow-right"></i></div>
          </div>

          <div class="stat-card" onclick="return false;">
            <div class="stat-icon" style="background: linear-gradient(135deg,#64748b,#334155);">
              <i class="fas fa-message"></i>
            </div>
            <div class="stat-label">Messages</div>
            <div class="stat-value" id="messagesSent">0</div>
            <div class="stat-link">Total Sent</div>
          </div>

          <div class="stat-card" onclick="return false;">
            <div class="stat-icon" style="background: linear-gradient(135deg,#ef4444,#f97316);">
              <i class="fas fa-paper-plane"></i>
            </div>
            <div class="stat-label">Success Rate</div>
            <div class="stat-value" id="successRate">0%</div>
            <div class="stat-link">Delivery Rate</div>
          </div>
        </div>

        <!-- Sections -->
        <div class="section-card mb-4">
          <div class="section-header">
            <h5><i class="fa-solid fa-cake-candles"></i> Upcoming Birthdays &amp; Anniversaries</h5>
            <a href="#" class="btn-viewall" onclick="return false;">View All <i class="fas fa-arrow-right"></i></a>
          </div>
          <div class="p-4 text-center" style="color: rgba(15, 23, 42, 0.55);">
            <div style="font-size: 28px; margin-bottom: 6px;"><i class="fa-solid fa-cake-candles"></i></div>
            No upcoming birthdays or anniversaries in the next 7 days
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <h5><i class="fa-solid fa-clock-rotate-left"></i> Recent Customers</h5>
            <a href="/customers" class="btn-viewall">View All <i class="fas fa-arrow-right"></i></a>
          </div>
          <div class="p-3">
            <div id="customersList" class="table-responsive"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Customer</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="addCustomerForm">
          <div class="mb-3">
            <label for="customerName" class="form-label">Name</label>
            <input
              type="text"
              class="form-control"
              id="customerName"
              name="name"
              required
            />
          </div>
          <div class="mb-3">
            <label for="customerPhone" class="form-label">Phone Number (E.164
              format)</label>
            <div class="input-group">
              <span class="input-group-text">+91</span>
              <input
                type="tel"
                class="form-control"
                id="customerPhone"
                name="phoneE164"
                placeholder="9999999999"
                required
              />
            </div>
            <small class="form-text text-muted">Enter 10-digit mobile number
              without +91</small>
          </div>
          <div class="mb-3">
            <label for="customerTags" class="form-label">Tags (comma separated)</label>
            <input
              type="text"
              class="form-control"
              id="customerTags"
              name="tags"
              placeholder="vip, regular, premium"
            />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >Cancel</button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="addCustomer()"
        >Add Customer</button>
      </div>
    </div>
  </div>
</div>

<script>
  async function loadDashboardData() {
    try {
      // businesses
      try {
        const businesses = await apiCall('/business', { method: 'GET' });
        document.getElementById('totalBusinesses').textContent = Array.isArray(businesses) ? businesses.length : (businesses?.length || 0);
      } catch {
        document.getElementById('totalBusinesses').textContent = '0';
      }

      // customers
      let customers = [];
      try {
        customers = await apiCall('/customers', { method: 'GET' });
        document.getElementById('totalCustomers').textContent = Array.isArray(customers) ? customers.length : (customers?.length || 0);
      } catch {
        document.getElementById('totalCustomers').textContent = '0';
      }

      // templates
      try {
        const templates = await apiCall('/templates', { method: 'GET' });
        document.getElementById('totalTemplates').textContent = Array.isArray(templates) ? templates.length : (templates?.length || 0);
      } catch {
        document.getElementById('totalTemplates').textContent = '0';
      }

      // campaigns
      try {
        const campaigns = await apiCall('/campaigns', { method: 'GET' });
        document.getElementById('totalCampaigns').textContent = Array.isArray(campaigns) ? campaigns.length : (campaigns?.length || 0);
      } catch {
        document.getElementById('totalCampaigns').textContent = '0';
      }

      // email templates count (API is under /api/email-templates in this project)
      try {
        const emailTemplates = await apiCall('/email-templates', { method: 'GET' });
        const count = Array.isArray(emailTemplates) ? emailTemplates.length : 0;
        const el = document.getElementById('totalEmailTemplates');
        if (el) el.textContent = String(count);
      } catch {
        const el = document.getElementById('totalEmailTemplates');
        if (el) el.textContent = '0';
      }

      // placeholder stats
      document.getElementById('messagesSent').textContent = '0';
      document.getElementById('successRate').textContent = '0%';

      // Recent customers table
      const customersList = document.getElementById('customersList');
      if (Array.isArray(customers) && customers.length > 0) {
        const rows = customers.slice(0, 6).map((c) => {
          const name = c.name || 'No Name';
          const phone = c.phoneE164 || '-';
          const tags = Array.isArray(c.tags) ? c.tags : [];
          const tagHtml = tags.length
            ? tags.slice(0, 3).map(t => `<span class="badge bg-light text-dark border me-1">${t}</span>`).join('')
            : '<span class="text-muted">-</span>';
          return `
            <tr>
              <td class="fw-semibold">${name}</td>
              <td class="text-muted">${phone}</td>
              <td>${tagHtml}</td>
            </tr>
          `;
        }).join('');

        customersList.innerHTML = `
          <table class="table align-middle mb-0">
            <thead>
              <tr class="text-muted" style="font-size:12px; letter-spacing:.06em; text-transform:uppercase;">
                <th>Name</th>
                <th>Phone</th>
                <th>Tags</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      } else {
        customersList.innerHTML = '<div class="text-center py-4 text-muted">No customers found</div>';
      }
    } catch (error) {
      console.error('Error loading dashboard data:', error);
      const customersList = document.getElementById('customersList');
      if (customersList) customersList.innerHTML = '<div class="text-center py-4 text-danger">Error loading data</div>';
    }
  }

  document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>