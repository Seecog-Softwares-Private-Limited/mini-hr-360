<div class="auth-shell">
  <div class="auth-decor" aria-hidden="true">
    <!-- HR-themed floating icons (decor only) -->
    <div class="auth-float c1 s1 d1" style="left: 6%; top: 12%;"><i class="fa-solid fa-user-tie"></i></div>
    <div class="auth-float c2 s2 d2" style="left: 12%; top: 42%;"><i class="fa-solid fa-users-gear"></i></div>
    <div class="auth-float c3 s3 d3" style="left: 6%; top: 62%;"><i class="fa-solid fa-id-card-clip"></i></div>
    <div class="auth-float c4 s2 d4" style="left: 18%; top: 82%;"><i class="fa-solid fa-briefcase"></i></div>
    <div class="auth-float c2 s3 d1" style="right: 12%; top: 18%;"><i class="fa-solid fa-building-user"></i></div>
    <div class="auth-float c3 s2 d2" style="right: 18%; top: 38%;"><i class="fa-solid fa-calendar-check"></i></div>
    <div class="auth-float c5 s3 d3" style="right: 12%; top: 62%;"><i class="fa-solid fa-file-invoice-dollar"></i></div>
    <div class="auth-float c1 s2 d4" style="right: 6%; top: 58%;"><i class="fa-solid fa-clipboard-check"></i></div>
    <div class="auth-float c5 s2 d2" style="right: 14%; top: 82%;"><i class="fa-solid fa-sitemap"></i></div>
  </div>

  <div class="auth-card">
    <div class="auth-card-body">
      <div class="text-center mb-3">
        <div class="auth-mark mx-auto" style="border-radius: 999px; width: 56px; height: 56px;">HR</div>
        <div class="mt-3">
          <p class="auth-title" style="font-size: 22px;">mini-hr-360</p>
          <p class="auth-subtitle">Professional HR management</p>
        </div>
      </div>

      <div id="alertContainer"></div>

      <form id="loginForm" class="auth-form">
        <div class="mb-3">
          <label for="email" class="form-label">Email Address</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-envelope"></i></span>
            <input type="email" class="form-control" id="email" name="email" placeholder="Enter your email" required>
          </div>
        </div>

        <div class="mb-3">
          <div class="d-flex align-items-center justify-content-between">
            <label for="password" class="form-label mb-0">Password</label>
            <a class="auth-link" href="#" onclick="return false;" title="Coming soon">Forgot Password?</a>
          </div>
          <div class="input-group mt-2">
            <span class="input-group-text"><i class="fa-solid fa-lock"></i></span>
            <input type="password" class="form-control" id="password" name="password" placeholder="Enter your password" required>
          </div>
        </div>

        <button type="submit" class="btn auth-primary w-100 mb-2" id="loginBtn">
          <span id="loginText">Login</span>
          <span id="loadingText" class="d-none">
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Logging in...
          </span>
        </button>

        <div class="auth-or">Or continue with</div>
        <div class="auth-social" aria-label="Social login options (UI only)">
          <a href="#" onclick="return false;" title="Google (UI only)"><i class="fa-brands fa-google"></i></a>
          <a href="#" onclick="return false;" title="Instagram (UI only)"><i class="fa-brands fa-instagram"></i></a>
          <a href="#" onclick="return false;" title="Facebook (UI only)"><i class="fa-brands fa-facebook-f"></i></a>
          <a href="#" onclick="return false;" title="GitHub (UI only)"><i class="fa-brands fa-github"></i></a>
          <a href="#" onclick="return false;" title="LinkedIn (UI only)"><i class="fa-brands fa-linkedin-in"></i></a>
          <a href="#" onclick="return false;" title="X (UI only)"><i class="fa-brands fa-x-twitter"></i></a>
        </div>
      </form>
    </div>
    <div class="auth-footer">
      <div>Don’t have an account? <a href="/register">Create Account</a></div>
      <div class="mt-2"><a href="/" class="auth-link" style="font-size: 0.875rem;">← Back to home</a></div>
    </div>
  </div>
</div>

<script>
  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const loginBtn = document.getElementById('loginBtn');
    const loginText = document.getElementById('loginText');
    const loadingText = document.getElementById('loadingText');
    const alertContainer = document.getElementById('alertContainer');

    // Clear previous alerts
    alertContainer.innerHTML = '';

    // Show loading
    loginBtn.disabled = true;
    loginText.classList.add('d-none');
    loadingText.classList.remove('d-none');

    try {
      // IMPORTANT: skipAuth so Authorization header is not added
      const resObj = await apiCall('/users/login', {
        method: 'POST',
        body: JSON.stringify({ email, password }),
        skipAuth: true
      });

      // resObj is already JSON (from main.hbs apiCall)
      const data = resObj || {};
      const payload = data.data || data; // handle ApiResponse or plain

      // If API returned an error shape
      if (data.error || data.message && !payload.tokens) {
        showAlert(data.message || data.error || 'Login failed', 'danger');
        return;
      }

      const user   = payload.user || payload.data?.user || null;
      const tokens = payload.tokens || payload.data?.tokens || {};

      if (!tokens || !tokens.accessToken) {
        showAlert('Login failed: no token received', 'danger');
        return;
      }

      // Store user + token
      if (user) localStorage.setItem('user', JSON.stringify(user));
      localStorage.setItem('accessToken', tokens.accessToken);
      
      // Store user role for role-based access
      if (user && user.role) {
        localStorage.setItem('userRole', user.role);
      }

      // Success + redirect
      showAlert('Login successful! Redirecting...', 'success');
      const url = new URL(location.href);
      const next = url.searchParams.get('next');
      setTimeout(() => {
        window.location.replace(next || '/dashboard');
      }, 500);

    } catch (error) {
      console.error('Login error:', error);
      showAlert('Network error. Please try again.', 'danger');
    } finally {
      // Hide loading
      loginBtn.disabled = false;
      loginText.classList.remove('d-none');
      loadingText.classList.add('d-none');
    }
  });

  function showAlert(message, type) {
    const alertContainer = document.getElementById('alertContainer');
    alertContainer.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
  }

  // Check if user is already authenticated via cookies and auto-redirect to dashboard
  document.addEventListener('DOMContentLoaded', async function() {
    // Check if user is already authenticated by trying to access a protected endpoint
    // Cookies are httpOnly so we can't read them directly, but we can check via API call
    try {
      // Use the business list endpoint - works even if user has no businesses yet
      // It will return 200 with empty array if authenticated but no businesses
      const response = await fetch(`${window.location.origin.replace(/\/$/, '')}/api/v1/business`, {
        method: 'GET',
        credentials: 'include', // Important: sends cookies automatically
        headers: {
          'Content-Type': 'application/json'
        }
      });

      // If we get 200 (authenticated, even if no businesses) or any non-401 response, user is authenticated
      // 404/500 would be server errors, not auth failures, so we only check for 401
      if (response.status !== 401) {
        console.log('User is already authenticated via cookies, redirecting to dashboard...');
        // User is authenticated, redirect to dashboard
        window.location.replace('/dashboard');
        return;
      }

      // If 401, user is not authenticated, show login form (do nothing)
      console.log('User is not authenticated, showing login form');
      // Clear any stale localStorage tokens
      localStorage.removeItem('accessToken');
      localStorage.removeItem('user');
    } catch (error) {
      // Network error or other issue - show login form (do nothing)
      // This could be a network issue, so don't clear localStorage unnecessarily
      console.log('Auth check failed (network error), showing login form');
    }
  });
</script>
