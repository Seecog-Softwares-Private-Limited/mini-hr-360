<div class="sidebar p-3">
  <div class="sidebar-brand mb-3">
    <div class="brand-mark">
      <i class="fa-solid fa-people-group"></i>
    </div>
    <div class="brand-text">
      <div class="brand-title">mini-hr-360</div>
      <div class="brand-subtitle">BUSINESS MANAGEMENT</div>
    </div>
  </div>

  <div class="sidebar-profile mb-3">
    <div class="profile-avatar">
      <i class="fa-solid fa-user"></i>
    </div>
    <div class="profile-meta">
      <div class="profile-name">
        {{#if user.firstName}}{{user.firstName}}{{else}}User{{/if}}
        {{#if user.lastName}} {{user.lastName}}{{/if}}
      </div>
      <div class="profile-role">
        {{#if user.role}}
          {{#if (eq user.role 'HR_MANAGER')}}HR Manager{{else if (eq user.role 'HR_EXECUTIVE')}}HR Executive{{else if (eq user.role 'FINANCE')}}Finance{{else if (eq user.role 'admin')}}Administrator{{else if (eq user.role 'SUPER_ADMIN')}}Super Admin{{else}}{{user.role}}{{/if}}
        {{else}}ADMINISTRATOR{{/if}}
      </div>
    </div>
  </div>

  <!-- Notification Bell for HR/Finance - shows pending approvals -->
  <div id="notificationBell" class="notification-bell mb-3" style="display: none;">
    <a href="#" onclick="showNotifications(); return false;" class="d-flex align-items-center text-decoration-none text-dark p-2 rounded" style="background: #fff3cd; border: 1px solid #ffc107;">
      <i class="fa-solid fa-bell me-2" style="color: #856404;"></i>
      <span id="notificationText" style="font-size: 13px; color: #856404;">Loading...</span>
      <span id="notificationBadge" class="badge bg-danger ms-auto" style="display: none;">0</span>
    </a>
  </div>

  <nav class="nav flex-column">

    <div class="menu-toggle mt-1" onclick="toggleMenu('workspace-submenu')">
      <div class="nav-link {{#if (eq activeGroup 'workspace')}}active{{/if}}">
        <i class="fa-solid fa-briefcase"></i>
        Workspace
        <i class="fas fa-chevron-down float-end"></i>
      </div>
    </div>

    <div class="submenu show" id="workspace-submenu">
      <a class="nav-link {{#if (eq active 'dashboard')}}active{{/if}}" href="/dashboard">
        <i class="fas fa-tachometer-alt"></i> Dashboard
      </a>
      <a class="nav-link {{#if (eq active 'business')}}active{{/if}}" href="/business">
        <i class="fas fa-building"></i> My Businesses
      </a>
      <a class="nav-link {{#if (eq active 'employees')}}active{{/if}}" href="/employees">
        <i class="fas fa-user-tie"></i> Employee Management
      </a>



      <!-- Leave Management Submenu -->
      <div class="submenu-toggle" onclick="toggleMenu('leave-submenu')">
        <div
          class="nav-link submenu-parent {{#if (or (eq active 'leaveRequests') (or (eq active 'leaveTypes') (eq active 'leaveBalances')))}}active{{/if}}">
          <i class="fas fa-calendar-alt"></i>
          Leave Management
          <i
            class="fas fa-chevron-down submenu-arrow {{#if (or (eq active 'leaveRequests') (or (eq active 'leaveTypes') (eq active 'leaveBalances')))}}open{{/if}}"></i>
        </div>
      </div>
      <div
        class="nested-submenu {{#if (or (eq active 'leaveRequests') (or (eq active 'leaveTypes') (eq active 'leaveBalances')))}}show{{/if}}"
        id="leave-submenu">
        <a class="nav-link {{#if (eq active 'leaveRequests')}}active{{/if}}" href="/leave-requests">
          <i class="fas fa-clipboard-list"></i> Leave Requests
        </a>
        <a class="nav-link {{#if (eq active 'leaveTypes')}}active{{/if}}" href="/leave-requests/leave-types">
          <i class="fas fa-tags"></i> Leave Types
        </a>
        <a class="nav-link {{#if (eq active 'leaveBalances')}}active{{/if}}" href="/leave-requests/leave-balances">
          <i class="fas fa-balance-scale"></i> Leave Balances
        </a>
      </div>

      <!-- Attendance Submenu -->
      <div class="submenu-toggle mt-2" onclick="toggleMenu('attendance-submenu')">
        <div class="nav-link submenu-parent {{#if (or (eq active 'attendance-dashboard') (or (eq active 'attendance-policies') (or (eq active 'attendance-shifts') (or (eq active 'attendance-holidays') (or (eq active 'attendance-assignments') (or (eq active 'attendance-logs') (or (eq active 'attendance-regularizations') (or (eq active 'attendance-reports') (eq active 'attendance-lock')))))))))}}active{{/if}}">
          <i class="fas fa-clock"></i>
          Attendance
          <i class="fas fa-chevron-down submenu-arrow {{#if (or (eq active 'attendance-dashboard') (or (eq active 'attendance-policies') (or (eq active 'attendance-shifts') (or (eq active 'attendance-holidays') (or (eq active 'attendance-assignments') (or (eq active 'attendance-logs') (or (eq active 'attendance-regularizations') (or (eq active 'attendance-reports') (eq active 'attendance-lock')))))))))}}open{{/if}}"></i>
        </div>
      </div>
      <div class="nested-submenu {{#if (or (eq active 'attendance-dashboard') (or (eq active 'attendance-policies') (or (eq active 'attendance-shifts') (or (eq active 'attendance-holidays') (or (eq active 'attendance-assignments') (or (eq active 'attendance-logs') (or (eq active 'attendance-regularizations') (or (eq active 'attendance-reports') (eq active 'attendance-lock')))))))))}}show{{/if}}" id="attendance-submenu">
        <div class="sidebar-group px-3 pt-2 pb-2 text-uppercase small text-muted">Overview</div>
        <a class="nav-link {{#if (eq active 'attendance-dashboard')}}active{{/if}}" href="/admin/attendance">
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>

        <div class="sidebar-group px-3 pt-3 pb-2 text-uppercase small text-muted">Manage</div>
        <a class="nav-link {{#if (eq active 'attendance-policies')}}active{{/if}}" href="/admin/attendance/policies">
          <i class="fas fa-file-contract"></i> Policies
        </a>
        <a class="nav-link {{#if (eq active 'attendance-shifts')}}active{{/if}}" href="/admin/attendance/shifts">
          <i class="fas fa-clock"></i> Shifts
        </a>
        <a class="nav-link {{#if (eq active 'attendance-holidays')}}active{{/if}}" href="/admin/attendance/holidays">
          <i class="fas fa-calendar-day"></i> Holidays
        </a>
        <a class="nav-link {{#if (eq active 'attendance-assignments')}}active{{/if}}" href="/admin/attendance/assignments">
          <i class="fas fa-user-tag"></i> Assignments
        </a>

        <div class="sidebar-group px-3 pt-3 pb-2 text-uppercase small text-muted">Operations</div>
        <a class="nav-link {{#if (eq active 'attendance-logs')}}active{{/if}}" href="/admin/attendance/logs">
          <i class="fas fa-book"></i> Logs
        </a>
        <a class="nav-link {{#if (eq active 'attendance-regularizations')}}active{{/if}}" href="/admin/attendance/regularizations">
          <i class="fas fa-pen-ruler"></i> Regularizations
        </a>
        <a class="nav-link {{#if (eq active 'attendance-reports')}}active{{/if}}" href="/admin/attendance/reports">
          <i class="fas fa-chart-line"></i> Reports
        </a>
        <a class="nav-link {{#if (eq active 'attendance-lock')}}active{{/if}}" href="/admin/attendance/lock">
          <i class="fas fa-lock"></i> Lock
        </a>
      </div>

      <!-- Payroll Management Submenu -->
      <div class="submenu-toggle mt-2" onclick="toggleMenu('payroll-submenu')">
        <div class="nav-link submenu-parent {{#if (or (eq active 'payroll-setup') (or (eq active 'payroll-structures') (or (eq active 'payroll-runs') (or (eq active 'payroll-register') (or (eq active 'payroll-payslips') (or (eq active 'payroll-statutory') (eq active 'payroll-queries')))))))}}active{{/if}}">
          <i class="fas fa-money-bill-wave"></i>
          Payroll Management
          <i class="fas fa-chevron-down submenu-arrow {{#if (or (eq active 'payroll-setup') (or (eq active 'payroll-structures') (or (eq active 'payroll-runs') (or (eq active 'payroll-register') (or (eq active 'payroll-payslips') (or (eq active 'payroll-statutory') (eq active 'payroll-queries')))))))}}open{{/if}}"></i>
        </div>
      </div>
      <div class="nested-submenu {{#if (or (eq active 'payroll-setup') (or (eq active 'payroll-structures') (or (eq active 'payroll-runs') (or (eq active 'payroll-register') (or (eq active 'payroll-payslips') (or (eq active 'payroll-statutory') (eq active 'payroll-queries')))))))}}show{{/if}}" id="payroll-submenu">
        <div class="sidebar-group px-3 pt-2 pb-2 text-uppercase small text-muted">Configuration</div>
        <a class="nav-link {{#if (eq active 'payroll-setup')}}active{{/if}}" href="/admin/payroll/setup">
          <i class="fas fa-cogs"></i> Payroll Setup
        </a>
        <a class="nav-link {{#if (eq active 'payroll-structures')}}active{{/if}}" href="/admin/payroll/structures">
          <i class="fas fa-sitemap"></i> Salary Structures
        </a>

        <div class="sidebar-group px-3 pt-3 pb-2 text-uppercase small text-muted">Operations</div>
        <a class="nav-link {{#if (eq active 'payroll-runs')}}active{{/if}}" href="/admin/payroll/runs">
          <i class="fas fa-play-circle"></i> Payroll Runs
        </a>
        <a class="nav-link {{#if (eq active 'payroll-register')}}active{{/if}}" href="/admin/payroll/register">
          <i class="fas fa-list"></i> Payroll Register
        </a>
        <a class="nav-link {{#if (eq active 'payroll-payslips')}}active{{/if}}" href="/admin/payroll/payslips">
          <i class="fas fa-file-invoice-dollar"></i> Payslips
        </a>

        <div class="sidebar-group px-3 pt-3 pb-2 text-uppercase small text-muted">Compliance</div>
        <a class="nav-link {{#if (eq active 'payroll-statutory')}}active{{/if}}" href="/admin/payroll/statutory">
          <i class="fas fa-balance-scale"></i> Statutory Reports
        </a>
        <a class="nav-link {{#if (eq active 'payroll-queries')}}active{{/if}}" href="/admin/payroll/queries">
          <i class="fas fa-comments"></i> Payroll Queries
        </a>
      </div>

      <a class="nav-link {{#if (eq active 'documents')}}active{{/if}}" href="/documents">
        <i class="fas fa-file-signature"></i> Generate Documents
      </a>

      <hr />
      <a class="nav-link {{#if (eq active 'documentTypes')}}active{{/if}}" href="/document-types">
        <i class="fas fa-layer-group"></i> Document Templates
      </a>
      <a class="nav-link {{#if (eq active 'emailTemplates')}}active{{/if}}" href="/email-templates">
        <i class="fas fa-envelope-open-text"></i> Email Templates
      </a>
      <a class="nav-link {{#if (eq active 'departments')}}active{{/if}}" href="/departments">
        <i class="fa-solid fa-building-columns"></i> Manage Departments
      </a>
      <a class="nav-link {{#if (eq active 'designations')}}active{{/if}}" href="/designations">
        <i class="fa-solid fa-id-badge"></i> Manage Designations
      </a>
      <a class="nav-link {{#if (eq active 'businessAddresses')}}active{{/if}}" href="/business-addresses">
        <i class="fas fa-map-marker-alt"></i> Manage Business Addresses
      </a>
      <a class="nav-link {{#if (eq active 'team')}}active{{/if}}" href="/admin/team">
        <i class="fas fa-users-cog"></i> Team & Roles
      </a>
    </div>

    <div class="sidebar-item mt-1">
      <a class="nav-link {{#if (eq active 'billing')}}active{{/if}}" href="/billing">
        <i class="fa-solid fa-crown"></i>
        Billing &amp; Plan
      </a>
    </div>

    <div class="sidebar-item">
      <a class="nav-link {{#if (eq active 'profile')}}active{{/if}}" href="/admin/profile">
        <i class="fa-solid fa-user-circle"></i>
        My Profile
      </a>
    </div>

    <div class="sidebar-divider"></div>

    <a class="nav-link" href="#" onclick="logout(); return false;">
      <i class="fas fa-sign-out-alt"></i>
      Logout
    </a>
  </nav>
</div>

<!-- Notification Modal -->
<div class="modal fade" id="notificationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-bell me-2"></i>Notifications</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="notificationList">
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="markAllNotificationsRead()">
          <i class="fa-solid fa-check-double me-1"></i>Mark All Read
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<style>
  .notification-bell {
    cursor: pointer;
  }
  .notification-bell:hover {
    opacity: 0.9;
  }
  .notification-item {
    padding: 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }
  .notification-item:hover {
    background: #f8f9fa;
  }
  .notification-item.unread {
    background: #fff8e1;
  }
  .notification-item .time {
    font-size: 11px;
    color: #888;
  }
  .sidebar-item-disabled {
    opacity: 0.5;
    pointer-events: none;
  }
</style>

<script>
  // Role-based sidebar visibility
  document.addEventListener('DOMContentLoaded', function() {
    const userRole = localStorage.getItem('userRole') || '{{user.role}}' || 'admin';
    console.log('[Sidebar] User role:', userRole);
    
    // Define which sections each role can access
    const rolePermissions = {
      'admin': { all: true },
      'SUPER_ADMIN': { all: true },
      'shop_owner': { all: true },
      'HR_MANAGER': {
        dashboard: true,
        business: false,
        employees: true,
        leaves: true,
        attendance: true,
        payroll: true,
        payrollSetup: false,      // HR can view payroll but not setup
        payrollStructures: false, // HR cannot manage salary structures
        documents: true,
        templates: false,         // HR cannot manage templates
        departments: false,
        designations: false,
        businessAddresses: false,
        team: false,
        billing: false,
        profile: true,
      },
      'HR_EXECUTIVE': {
        dashboard: true,
        business: false,
        employees: true,
        leaves: true,
        attendance: true,
        payroll: true,
        payrollSetup: false,
        payrollStructures: false,
        documents: true,
        templates: false,
        departments: false,
        designations: false,
        businessAddresses: false,
        team: false,
        billing: false,
        profile: true,
      },
      'FINANCE': {
        dashboard: true,
        business: false,
        employees: false,
        leaves: false,
        attendance: false,
        payroll: true,
        payrollSetup: false,      // Finance can review but not setup
        payrollStructures: false,
        documents: false,
        templates: false,
        departments: false,
        designations: false,
        businessAddresses: false,
        team: false,
        billing: true,
        profile: true,
      },
      'MANAGER': {
        dashboard: true,
        business: false,
        employees: false,
        leaves: true,
        attendance: true,
        payroll: false,
        documents: false,
        templates: false,
        departments: false,
        designations: false,
        businessAddresses: false,
        team: false,
        billing: false,
        profile: true,
      },
    };
    
    const permissions = rolePermissions[userRole] || {};
    const isFullAdmin = permissions.all === true;
    
    // Show notification bell for HR and Finance roles
    if (['HR_MANAGER', 'HR_EXECUTIVE', 'FINANCE'].includes(userRole)) {
      const bell = document.getElementById('notificationBell');
      if (bell) {
        bell.style.display = 'block';
        loadNotificationCount();
      }
    }
    
    // Apply visibility based on role (if not full admin)
    if (!isFullAdmin) {
      // Helper function to hide element
      const hideElement = (selector) => {
        const el = document.querySelector(selector);
        if (el) el.classList.add('d-none');
      };
      
      // Helper to hide element and its parent container if needed
      const hideLink = (href) => {
        const link = document.querySelector(`a[href="${href}"]`);
        if (link) {
          link.classList.add('d-none');
          // Also hide parent sidebar-item if it exists
          const parent = link.closest('.sidebar-item');
          if (parent) parent.classList.add('d-none');
        }
      };
      
      // Hide My Businesses
      if (!permissions.business) {
        hideLink('/business');
      }
      
      // Hide Employee Management
      if (!permissions.employees) {
        hideLink('/employees');
      }
      
      // Hide Leave Management section
      if (!permissions.leaves) {
        // Hide the submenu toggle and the nested submenu
        const leaveToggle = document.querySelector('[onclick="toggleMenu(\'leave-submenu\')"]');
        if (leaveToggle) leaveToggle.classList.add('d-none');
        const leaveSubmenu = document.getElementById('leave-submenu');
        if (leaveSubmenu) leaveSubmenu.classList.add('d-none');
      }
      
      // Hide Attendance section
      if (!permissions.attendance) {
        const attToggle = document.querySelector('[onclick="toggleMenu(\'attendance-submenu\')"]');
        if (attToggle) attToggle.classList.add('d-none');
        const attSubmenu = document.getElementById('attendance-submenu');
        if (attSubmenu) attSubmenu.classList.add('d-none');
      }
      
      // Hide Payroll section entirely
      if (!permissions.payroll) {
        const payrollToggle = document.querySelector('[onclick="toggleMenu(\'payroll-submenu\')"]');
        if (payrollToggle) payrollToggle.classList.add('d-none');
        const payrollSubmenu = document.getElementById('payroll-submenu');
        if (payrollSubmenu) payrollSubmenu.classList.add('d-none');
      } else {
        // Payroll is allowed, but hide setup/structures if not permitted
        if (!permissions.payrollSetup) {
          hideLink('/admin/payroll/setup');
        }
        if (!permissions.payrollStructures) {
          hideLink('/admin/payroll/structures');
        }
      }
      
      // Hide Generate Documents
      if (!permissions.documents) {
        hideLink('/documents');
      }
      
      // Hide Document Templates
      if (!permissions.templates) {
        hideLink('/document-types');
      }
      
      // Hide Email Templates
      if (!permissions.templates) {
        hideLink('/email-templates');
      }
      
      // Hide Manage Departments
      if (!permissions.departments) {
        hideLink('/departments');
      }
      
      // Hide Manage Designations
      if (!permissions.designations) {
        hideLink('/designations');
      }
      
      // Hide Business Addresses
      if (!permissions.businessAddresses) {
        hideLink('/business-addresses');
      }
      
      // Hide Team & Roles
      if (!permissions.team) {
        hideLink('/admin/team');
      }
      
      // Hide Billing
      if (!permissions.billing) {
        hideLink('/billing');
      }
      
      console.log('[Sidebar] Applied role restrictions for:', userRole);
    }
  });
  
  // Load notification count
  async function loadNotificationCount() {
    try {
      const response = await apiCall('/notifications/count');
      const data = response.data || response;
      const count = data.count || 0;
      
      const badge = document.getElementById('notificationBadge');
      const text = document.getElementById('notificationText');
      
      if (count > 0) {
        badge.style.display = 'inline';
        badge.textContent = count;
        text.textContent = `${count} pending approval${count > 1 ? 's' : ''}`;
      } else {
        badge.style.display = 'none';
        text.textContent = 'No pending approvals';
      }
    } catch (e) {
      console.error('Error loading notifications:', e);
    }
  }
  
  // Show notifications modal
  async function showNotifications() {
    const modal = new bootstrap.Modal(document.getElementById('notificationModal'));
    modal.show();
    
    const list = document.getElementById('notificationList');
    list.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>';
    
    try {
      const response = await apiCall('/notifications?limit=20');
      const data = response.data || response;
      const notifications = data.notifications || [];
      
      if (notifications.length === 0) {
        list.innerHTML = '<div class="text-center py-4 text-muted"><i class="fa-solid fa-inbox fa-2x mb-2"></i><p>No notifications</p></div>';
        return;
      }
      
      list.innerHTML = notifications.map(n => `
        <div class="notification-item ${n.isRead ? '' : 'unread'}" onclick="handleNotificationClick(${n.id}, '${n.link || ''}')">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>${escapeHtml(n.title)}</strong>
              <p class="mb-1 small">${escapeHtml(n.message || '')}</p>
              <span class="time">${formatNotificationTime(n.createdAt)}</span>
            </div>
            ${n.priority === 'HIGH' || n.priority === 'URGENT' ? '<span class="badge bg-danger">!</span>' : ''}
          </div>
        </div>
      `).join('');
    } catch (e) {
      list.innerHTML = '<div class="text-center py-4 text-danger">Error loading notifications</div>';
    }
  }
  
  // Handle notification click
  async function handleNotificationClick(id, link) {
    try {
      await apiCall(`/notifications/${id}/read`, { method: 'PUT' });
      loadNotificationCount();
      if (link) {
        window.location.href = link;
      }
    } catch (e) {
      console.error('Error marking notification as read:', e);
    }
  }
  
  // Mark all notifications as read
  async function markAllNotificationsRead() {
    try {
      await apiCall('/notifications/read-all', { method: 'PUT' });
      loadNotificationCount();
      showNotifications(); // Refresh list
    } catch (e) {
      console.error('Error marking all as read:', e);
    }
  }
  
  // Format notification time
  function formatNotificationTime(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
  }
  
  // Escape HTML helper
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>