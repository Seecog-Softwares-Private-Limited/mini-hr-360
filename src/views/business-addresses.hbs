{{!-- views/business-addresses.hbs --}}
<div class="container-fluid">
  <div class="row">
    {{!-- Sidebar --}}
    <div class="col-md-3 col-lg-2 px-0">
      {{> sidebar}}
    </div>

    {{!-- Main content --}}
    <div class="col-md-9 col-lg-10">
      <div class="main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2 class="mb-0">Business Addresses</h2>
            <small class="text-muted" id="addressCount">
              Loading addresses...
            </small>
          </div>

          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#addAddressModal"
            onclick="openCreateAddress()"
          >
            <i class="fas fa-plus me-2"></i> Add Address
          </button>
        </div>

        {{!-- Search and Filters --}}
        <div class="card mb-4">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Search</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-search"></i></span>
                  <input
                    type="text"
                    id="searchInput"
                    class="form-control"
                    placeholder="Search by name or address"
                  />
                </div>
              </div>
              <div class="col-md-2">
                <label class="form-label">Business</label>
                <select id="businessFilter" class="form-select">
                  <option value="">All Businesses</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Type</label>
                <select id="addressTypeFilter" class="form-select">
                  <option value="">All Types</option>
                  <option value="REGISTERED">Registered</option>
                  <option value="BRANCH">Branch</option>
                  <option value="BILLING">Billing</option>
                  <option value="SHIPPING">Shipping</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Status</label>
                <select id="statusFilter" class="form-select">
                  <option value="">All Status</option>
                  <option value="ACTIVE">Active</option>
                  <option value="INACTIVE">Inactive</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Sort By</label>
                <select id="sortSelect" class="form-select">
                  <option value="name-asc">Name: A-Z</option>
                  <option value="name-desc">Name: Z-A</option>
                  <option value="created-desc">Newest First</option>
                  <option value="created-asc">Oldest First</option>
                </select>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-md-12">
                <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">
                  <i class="fas fa-rotate-left me-1"></i> Reset Filters
                </button>
              </div>
            </div>
          </div>
        </div>

        {{!-- Addresses table --}}
        <div class="card">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Business</th>
                    <th>Address Name</th>
                    <th>Full Address</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="addressTbody">
                  <tr>
                    <td colspan="8" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{{!-- Add/Edit Address Modal --}}
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addAddressModalTitle">
          <i class="fas fa-plus me-2 text-primary"></i>Add Address
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="modalAlert"></div>
        <form id="addressForm">
          <input type="hidden" id="addressId" />
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">
                Business <span class="text-danger">*</span>
              </label>
              <select id="formBusinessId" name="businessId" class="form-select" required>
                <option value="">Select Business</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">
                Address Name / Label <span class="text-danger">*</span>
              </label>
              <input id="formAddressName" name="addressName" type="text" class="form-control" placeholder="e.g., Head Office, Branch Office" required />
            </div>
            <div class="col-md-12">
              <label class="form-label">
                Full Address <span class="text-danger">*</span>
              </label>
              <textarea id="formFullAddress" name="fullAddress" class="form-control" rows="4" placeholder="Enter complete address including street, city, state, zip, country" required></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">Address Type</label>
              <select id="formAddressType" name="addressType" class="form-select">
                <option value="REGISTERED" selected>Registered</option>
                <option value="BRANCH">Branch</option>
                <option value="BILLING">Billing</option>
                <option value="SHIPPING">Shipping</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Status</label>
              <select id="formStatus" name="status" class="form-select">
                <option value="ACTIVE" selected>Active</option>
                <option value="INACTIVE">Inactive</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitAddress()">
          <i class="fas fa-save me-2"></i>Save
        </button>
      </div>
    </div>
  </div>
</div>

{{!-- View Address Modal --}}
<div class="modal fade" id="viewAddressModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-map-marker-alt me-2 text-primary"></i>Address Details
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <dl class="row">
          <dt class="col-sm-4 text-muted">Business:</dt>
          <dd class="col-sm-8" id="viewBusiness"></dd>

          <dt class="col-sm-4 text-muted">Address Name:</dt>
          <dd class="col-sm-8" id="viewAddressName"></dd>

          <dt class="col-sm-4 text-muted">Full Address:</dt>
          <dd class="col-sm-8" id="viewFullAddress" style="white-space: pre-wrap;"></dd>

          <dt class="col-sm-4 text-muted">Address Type:</dt>
          <dd class="col-sm-8" id="viewAddressType"></dd>

          <dt class="col-sm-4 text-muted">Status:</dt>
          <dd class="col-sm-8" id="viewStatus"></dd>

          <dt class="col-sm-4 text-muted">Created At:</dt>
          <dd class="col-sm-8" id="viewCreatedAt"></dd>

          <dt class="col-sm-4 text-muted">Updated At:</dt>
          <dd class="col-sm-8" id="viewUpdatedAt"></dd>
        </dl>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{{!-- Delete Confirm Modal --}}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Delete
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this address?</p>
        <p class="text-muted mb-0" id="deleteAddressName"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="confirmDelete()">
          <i class="fas fa-trash me-2"></i>Delete
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Wait for DOM and apiCall to be ready
  document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit more for apiCall from layout to be available
    setTimeout(function() {
      if (typeof apiCall === 'undefined') {
        console.error('apiCall is not defined. Please refresh the page.');
        document.getElementById('addressTbody').innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-4 text-danger">
              Error: API function not loaded. Please refresh the page.
            </td>
          </tr>
        `;
        return;
      }

      (function () {
        let addresses = [];
        let businesses = [];
        let businessesMap = {};
        let currentDeleteId = null;
        let currentEditId = null;

        // Filter and sort state
        let filters = {
          search: '',
          businessId: '',
          addressType: '',
          status: '',
          sort: 'name-asc'
        };

        // DOM elements
        const els = {
      searchInput: document.getElementById('searchInput'),
      businessFilter: document.getElementById('businessFilter'),
      addressTypeFilter: document.getElementById('addressTypeFilter'),
      statusFilter: document.getElementById('statusFilter'),
      sortSelect: document.getElementById('sortSelect'),
      addressTbody: document.getElementById('addressTbody'),
      addressCount: document.getElementById('addressCount'),
      formBusinessId: document.getElementById('formBusinessId'),
      formAddressName: document.getElementById('formAddressName'),
      formFullAddress: document.getElementById('formFullAddress'),
      formAddressType: document.getElementById('formAddressType'),
      formStatus: document.getElementById('formStatus'),
      addressId: document.getElementById('addressId'),
      modalAlert: document.getElementById('modalAlert'),
      addAddressModalTitle: document.getElementById('addAddressModalTitle'),
      deleteAddressName: document.getElementById('deleteAddressName'),
      viewBusiness: document.getElementById('viewBusiness'),
      viewAddressName: document.getElementById('viewAddressName'),
      viewFullAddress: document.getElementById('viewFullAddress'),
      viewAddressType: document.getElementById('viewAddressType'),
      viewStatus: document.getElementById('viewStatus'),
      viewCreatedAt: document.getElementById('viewCreatedAt'),
      viewUpdatedAt: document.getElementById('viewUpdatedAt')
    };

    // Initialize
    async function init() {
      await loadBusinesses();
      await loadAddresses();
      setupEventListeners();
    }

    // Setup event listeners
    function setupEventListeners() {
      els.searchInput.addEventListener('input', debounce(() => {
        filters.search = els.searchInput.value.trim();
        filterAndDisplay();
      }, 300));

      els.businessFilter.addEventListener('change', () => {
        filters.businessId = els.businessFilter.value;
        filterAndDisplay();
      });

      els.addressTypeFilter.addEventListener('change', () => {
        filters.addressType = els.addressTypeFilter.value;
        filterAndDisplay();
      });

      els.statusFilter.addEventListener('change', () => {
        filters.status = els.statusFilter.value;
        filterAndDisplay();
      });

      els.sortSelect.addEventListener('change', () => {
        filters.sort = els.sortSelect.value;
        filterAndDisplay();
      });

      // Reset modal on close
      const addModal = document.getElementById('addAddressModal');
      if (addModal) {
        addModal.addEventListener('hidden.bs.modal', function () {
          const form = document.getElementById('addressForm');
          if (form) form.reset();
          els.modalAlert.innerHTML = '';
          currentEditId = null;
          els.addressId.value = '';
        });
      }
    }

    // Debounce helper
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Load businesses for dropdown
    async function loadBusinesses() {
      try {
        const data = await apiCall('/business', { method: 'GET' });
        console.log('Businesses API response:', data);
        
        // Handle different response formats
        if (Array.isArray(data)) {
          businesses = data;
        } else if (data?.data && Array.isArray(data.data)) {
          businesses = data.data;
        } else if (data?.items && Array.isArray(data.items)) {
          businesses = data.items;
        } else {
          businesses = [];
        }
        
        console.log('Parsed businesses:', businesses);
        
        businessesMap = {};
        businesses.forEach(b => {
          businessesMap[String(b.id)] = b.businessName || b.name || `Business #${b.id}`;
        });

        // Populate business filter dropdown
        const filterOpts = businesses.map(b => 
          `<option value="${b.id}">${escapeHtml(businessesMap[String(b.id)])}</option>`
        ).join('');
        els.businessFilter.innerHTML = '<option value="">All Businesses</option>' + filterOpts;

        // Populate form business dropdown
        const formOpts = businesses.map(b => 
          `<option value="${b.id}">${escapeHtml(businessesMap[String(b.id)])}</option>`
        ).join('');
        els.formBusinessId.innerHTML = '<option value="">Select Business</option>' + formOpts;
        
        if (businesses.length === 0) {
          console.warn('No businesses found. Make sure you have created at least one business.');
        }
      } catch (error) {
        console.error('Error loading businesses:', error);
        showAlert('Error loading businesses: ' + (error.message || 'Unknown error'), 'danger', document.body);
        // Set empty dropdowns
        els.businessFilter.innerHTML = '<option value="">All Businesses</option>';
        els.formBusinessId.innerHTML = '<option value="">Select Business</option>';
      }
    }

    // Load addresses
    async function loadAddresses() {
      try {
        const params = new URLSearchParams();
        if (filters.businessId) params.append('businessId', filters.businessId);
        if (filters.addressType) params.append('addressType', filters.addressType);
        if (filters.status) params.append('status', filters.status);
        if (filters.search) params.append('search', filters.search);

        const endpoint = '/business-addresses' + (params.toString() ? '?' + params.toString() : '');
        const response = await apiCall(endpoint, { method: 'GET' });
        addresses = response?.data || response || [];
        filterAndDisplay();
      } catch (error) {
        console.error('Error loading addresses:', error);
        showAlert('Error loading addresses: ' + (error.message || 'Unknown error'), 'danger', document.body);
        addresses = [];
        displayAddresses([]);
      }
    }

    // Filter and display addresses
    function filterAndDisplay() {
      let filtered = [...addresses];

      // Apply client-side search (additional to server-side)
      if (filters.search) {
        const searchLower = filters.search.toLowerCase();
        filtered = filtered.filter(addr => 
          (addr.addressName || '').toLowerCase().includes(searchLower) ||
          (addr.fullAddress || '').toLowerCase().includes(searchLower) ||
          (addr.business?.businessName || '').toLowerCase().includes(searchLower)
        );
      }

      // Apply sorting
      filtered.sort((a, b) => {
        const [field, order] = filters.sort.split('-');
        let aVal, bVal;

        switch (field) {
          case 'name':
            aVal = (a.addressName || '').toLowerCase();
            bVal = (b.addressName || '').toLowerCase();
            break;
          case 'created':
            aVal = new Date(a.createdAt || 0);
            bVal = new Date(b.createdAt || 0);
            break;
          default:
            aVal = a.addressName || '';
            bVal = b.addressName || '';
        }

        if (aVal < bVal) return order === 'asc' ? -1 : 1;
        if (aVal > bVal) return order === 'asc' ? 1 : -1;
        return 0;
      });

      displayAddresses(filtered);
    }

    // Display addresses in table
    function displayAddresses(addressList) {
      els.addressCount.textContent = `Total: ${addressList.length} address${addressList.length !== 1 ? 'es' : ''}`;

      if (!addressList || addressList.length === 0) {
        els.addressTbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-4 text-muted">
              No addresses found
            </td>
          </tr>
        `;
        return;
      }

      els.addressTbody.innerHTML = addressList.map((addr, index) => {
        const businessName = addr.business?.businessName || businessesMap[String(addr.businessId)] || 'N/A';
        const addressName = escapeHtml(addr.addressName || '');
        const fullAddress = escapeHtml((addr.fullAddress || '').substring(0, 100)) + (addr.fullAddress?.length > 100 ? '...' : '');
        const addressType = addr.addressType || 'REGISTERED';
        const status = addr.status || 'ACTIVE';
        const createdAt = formatDate(addr.createdAt);

        const statusBadge = status === 'ACTIVE' 
          ? '<span class="badge bg-success">Active</span>'
          : '<span class="badge bg-secondary">Inactive</span>';

        const typeBadge = getAddressTypeBadge(addressType);

        return `
          <tr>
            <td>${index + 1}</td>
            <td>${escapeHtml(businessName)}</td>
            <td><strong>${addressName}</strong></td>
            <td>${fullAddress}</td>
            <td>${typeBadge}</td>
            <td>${statusBadge}</td>
            <td><small class="text-muted">${createdAt}</small></td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-secondary view-address-btn" onclick="openViewAddress(${addr.id})" title="View">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-outline-primary edit-address-btn" onclick="openEditAddress(${addr.id})" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-outline-danger delete-address-btn" onclick="openDeleteAddress(${addr.id}, '${addressName.replace(/'/g, "\\'")}')" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Get address type badge
    function getAddressTypeBadge(type) {
      const badges = {
        'REGISTERED': '<span class="badge bg-primary">Registered</span>',
        'BRANCH': '<span class="badge bg-info">Branch</span>',
        'BILLING': '<span class="badge bg-warning">Billing</span>',
        'SHIPPING': '<span class="badge bg-success">Shipping</span>',
        'OTHER': '<span class="badge bg-secondary">Other</span>'
      };
      return badges[type] || '<span class="badge bg-secondary">' + escapeHtml(type) + '</span>';
    }

    // Format date
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // Escape HTML
    function escapeHtml(str) {
      if (str == null) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Show alert
    function showAlert(message, type = 'info', container = els.modalAlert) {
      if (!container) {
        container = document.body;
      }
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
      alertDiv.style.zIndex = '9999';
      alertDiv.innerHTML = `
        ${escapeHtml(message)}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      container.appendChild(alertDiv);
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    // Reset filters
    window.resetFilters = function() {
      els.searchInput.value = '';
      els.businessFilter.value = '';
      els.addressTypeFilter.value = '';
      els.statusFilter.value = '';
      els.sortSelect.value = 'name-asc';
      filters = {
        search: '',
        businessId: '',
        addressType: '',
        status: '',
        sort: 'name-asc'
      };
      loadAddresses();
    };

    // Open create address modal
    window.openCreateAddress = function() {
      currentEditId = null;
      els.addressId.value = '';
      const form = document.getElementById('addressForm');
      if (form) form.reset();
      els.formBusinessId.value = '';
      els.formAddressType.value = 'REGISTERED';
      els.formStatus.value = 'ACTIVE';
      els.addAddressModalTitle.innerHTML = '<i class="fas fa-plus me-2 text-primary"></i>Add Address';
      els.modalAlert.innerHTML = '';
    };

    // Open edit address modal
    window.openEditAddress = async function(id) {
      try {
        currentEditId = id;
        const response = await apiCall(`/business-addresses/${id}`, { method: 'GET' });
        const addr = response?.data || response;

        if (!addr) {
          showAlert('Address not found', 'danger');
          return;
        }

        els.addressId.value = addr.id || '';
        els.formBusinessId.value = addr.businessId || '';
        els.formAddressName.value = addr.addressName || '';
        els.formFullAddress.value = addr.fullAddress || '';
        els.formAddressType.value = addr.addressType || 'REGISTERED';
        els.formStatus.value = addr.status || 'ACTIVE';
        els.addAddressModalTitle.innerHTML = '<i class="fas fa-edit me-2 text-primary"></i>Edit Address';
        els.modalAlert.innerHTML = '';

        const modalEl = document.getElementById('addAddressModal');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      } catch (error) {
        console.error('Error loading address:', error);
        showAlert('Error loading address: ' + (error.message || 'Unknown error'), 'danger');
      }
    };

    // Open view address modal
    window.openViewAddress = async function(id) {
      try {
        const response = await apiCall(`/business-addresses/${id}`, { method: 'GET' });
        const addr = response?.data || response;

        if (!addr) {
          showAlert('Address not found', 'danger');
          return;
        }

        els.viewBusiness.textContent = addr.business?.businessName || businessesMap[String(addr.businessId)] || 'N/A';
        els.viewAddressName.textContent = addr.addressName || '-';
        els.viewFullAddress.textContent = addr.fullAddress || '-';
        els.viewAddressType.innerHTML = getAddressTypeBadge(addr.addressType || 'REGISTERED');
        els.viewStatus.innerHTML = (addr.status || 'ACTIVE') === 'ACTIVE' 
          ? '<span class="badge bg-success">Active</span>'
          : '<span class="badge bg-secondary">Inactive</span>';
        els.viewCreatedAt.textContent = formatDate(addr.createdAt);
        els.viewUpdatedAt.textContent = formatDate(addr.updatedAt);

        const modalEl = document.getElementById('viewAddressModal');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      } catch (error) {
        console.error('Error loading address:', error);
        showAlert('Error loading address: ' + (error.message || 'Unknown error'), 'danger');
      }
    };

    // Open delete confirm modal
    window.openDeleteAddress = function(id, name) {
      currentDeleteId = id;
      els.deleteAddressName.textContent = name || 'this address';
      
      const modalEl = document.getElementById('deleteModal');
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();
    };

    // Submit address (create or update)
    window.submitAddress = async function() {
      const form = document.getElementById('addressForm');
      
      if (!form || !form.checkValidity()) {
        if (form) form.reportValidity();
        return;
      }

      const data = {
        businessId: parseInt(els.formBusinessId.value),
        addressName: els.formAddressName.value.trim(),
        fullAddress: els.formFullAddress.value.trim(),
        addressType: els.formAddressType.value,
        status: els.formStatus.value
      };

      try {
        let response;
        if (currentEditId) {
          // Update
          response = await apiCall(`/business-addresses/${currentEditId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          // Create
          response = await apiCall('/business-addresses', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (response?.success !== false) {
          const modalEl = document.getElementById('addAddressModal');
          const modal = bootstrap.Modal.getInstance(modalEl);
          modal.hide();
          
          await loadAddresses();
          showAlert(currentEditId ? 'Address updated successfully!' : 'Address created successfully!', 'success', document.body);
        } else {
          showAlert(response.message || 'Failed to save address', 'danger');
        }
      } catch (error) {
        console.error('Error saving address:', error);
        showAlert('Error saving address: ' + (error.message || 'Unknown error'), 'danger');
      }
    };

    // Confirm delete
    window.confirmDelete = async function() {
      if (!currentDeleteId) return;

      try {
        const response = await apiCall(`/business-addresses/${currentDeleteId}`, {
          method: 'DELETE'
        });

        if (response?.success !== false) {
          const modalEl = document.getElementById('deleteModal');
          const modal = bootstrap.Modal.getInstance(modalEl);
          modal.hide();

          await loadAddresses();
          showAlert('Address deleted successfully!', 'success', document.body);
          currentDeleteId = null;
        } else {
          showAlert(response.message || 'Failed to delete address', 'danger');
        }
      } catch (error) {
        console.error('Error deleting address:', error);
        showAlert('Error deleting address: ' + (error.message || 'Unknown error'), 'danger');
      }
    };

        // Initialize on page load
        init();
      })();
    }, 200);
  });
</script>