<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 px-0">
      {{> sidebar}}
    </div>

    <!-- Main -->
    <div class="col-md-9 col-lg-10 px-0">
      <div class="main-content p-4">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
          <div>
            <div class="page-title" style="font-size: 28px;">Designations</div>
            <div class="page-subtitle">Manage roles/designations with search, sorting and pagination.</div>
          </div>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#designationModal" onclick="openCreateDesignation()">
            <i class="fa-solid fa-circle-plus me-2"></i>Add Designation
          </button>
        </div>

        <div class="section-card mb-4">
          <div class="section-header">
            <h5><i class="fa-solid fa-id-badge"></i> Designations</h5>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <div class="input-group input-group-sm" style="width: 280px;">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input id="qInput" type="text" class="form-control" placeholder="Search name/code/description" />
              </div>
              <select id="pageSizeSelect" class="form-select form-select-sm" style="width: 120px;">
                <option value="10">10 / page</option>
                <option value="20" selected>20 / page</option>
                <option value="50">50 / page</option>
              </select>
              <select id="businessSelect" class="form-select form-select-sm" style="width: 220px;">
                <option value="">All Businesses</option>
              </select>
              <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">
                <i class="fas fa-rotate-left me-1"></i>Reset
              </button>
            </div>
          </div>

          <div class="p-3">
            <div class="table-responsive">
              <table class="table table-premium align-middle mb-0">
                <thead>
                  <tr class="text-muted" style="font-size:12px; letter-spacing:.06em; text-transform:uppercase;">
                    <th class="th-sort" onclick="setSort('businessId')">
                      <i class="fa-solid fa-building me-1"></i> Business <span class="sort-ind" id="sortBusinessId"></span>
                    </th>
                    <th class="th-sort" onclick="setSort('name')">
                      <i class="fa-solid fa-id-badge me-1"></i> Name <span class="sort-ind" id="sortName"></span>
                    </th>
                    <th class="th-sort" onclick="setSort('code')">
                      <i class="fa-solid fa-hashtag me-1"></i> Code <span class="sort-ind" id="sortCode"></span>
                    </th>
                    <th><i class="fa-regular fa-note-sticky me-1"></i> Description</th>
                    <th class="th-sort" onclick="setSort('status')">
                      <i class="fa-solid fa-toggle-on me-1"></i> Status <span class="sort-ind" id="sortStatus"></span>
                    </th>
                    <th class="th-sort" onclick="setSort('createdAt')">
                      <i class="fa-regular fa-calendar me-1"></i> Created <span class="sort-ind" id="sortCreatedAt"></span>
                    </th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody id="designationTbody">
                  <tr>
                    <td colspan="7" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3">
              <div class="text-muted" id="tableMeta">—</div>
              <nav>
                <ul class="pagination pagination-sm mb-0" id="pager"></ul>
              </nav>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal fade" id="designationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="designationModalTitle"><i class="fa-solid fa-id-badge me-2 text-primary"></i>Add Designation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="modalAlert"></div>
        <form id="designationForm">
          <input type="hidden" id="designationId" />
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Business</label>
              <select id="formBusinessId" class="form-select" required>
                <option value="">Select business</option>
              </select>
              <small class="text-muted">Designation is unique per business (name/code).</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Status</label>
              <select id="formStatus" class="form-select">
                <option value="ACTIVE" selected>ACTIVE</option>
                <option value="INACTIVE">INACTIVE</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Name *</label>
              <input id="formName" class="form-control" placeholder="e.g., Senior HR" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Code</label>
              <input id="formCode" class="form-control" placeholder="e.g., HR_SR" />
            </div>

            <div class="col-md-12">
              <label class="form-label">Description</label>
              <textarea id="formDescription" class="form-control" rows="3" placeholder="Optional description"></textarea>
            </div>

            <div class="col-md-4">
              <label class="form-label">Sort Order</label>
              <input id="formSortOrder" type="number" class="form-control" placeholder="e.g., 10" />
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveBtn" onclick="submitDesignation()">
          <i class="fa-solid fa-floppy-disk me-2"></i>Save
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete confirm modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-trash-can me-2 text-danger"></i>Delete Designation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning mb-0">
          Are you sure you want to delete <strong id="deleteName">this designation</strong>?
        </div>
        <input type="hidden" id="deleteId" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="confirmDelete()">
          <i class="fa-solid fa-trash-can me-2"></i>Delete
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let state = {
    page: 1,
    pageSize: 20,
    q: '',
    orderBy: 'createdAt',
    order: 'DESC',
    businessId: '',
    total: 0,
    totalPages: 1,
    items: [],
    businessesMap: {}
  };

  const els = {
    tbody: document.getElementById('designationTbody'),
    pager: document.getElementById('pager'),
    meta: document.getElementById('tableMeta'),
    q: document.getElementById('qInput'),
    pageSize: document.getElementById('pageSizeSelect'),
    business: document.getElementById('businessSelect'),
    sortBusinessId: document.getElementById('sortBusinessId'),
    sortName: document.getElementById('sortName'),
    sortCode: document.getElementById('sortCode'),
    sortStatus: document.getElementById('sortStatus'),
    sortCreatedAt: document.getElementById('sortCreatedAt'),
  };

  function fmtDate(s) {
    try {
      const d = new Date(s);
      return d.toLocaleDateString();
    } catch {
      return '-';
    }
  }

  function badgeStatus(status) {
    if (status === 'ACTIVE') return '<span class="badge bg-success-subtle text-success border">ACTIVE</span>';
    return '<span class="badge bg-secondary-subtle text-secondary border">INACTIVE</span>';
  }

  function setSort(col) {
    if (state.orderBy === col) {
      state.order = state.order === 'ASC' ? 'DESC' : 'ASC';
    } else {
      state.orderBy = col;
      state.order = 'ASC';
    }
    state.page = 1;
    renderSortIndicators();
    loadDesignations();
  }

  function renderSortIndicators() {
    const map = {
      businessId: els.sortBusinessId,
      name: els.sortName,
      code: els.sortCode,
      status: els.sortStatus,
      createdAt: els.sortCreatedAt
    };
    Object.values(map).forEach(el => el.textContent = '');
    const active = map[state.orderBy];
    if (active) active.textContent = state.order === 'ASC' ? ' ▲' : ' ▼';
  }

  function renderPager() {
    const totalPages = state.totalPages || 1;
    const page = state.page;
    const mk = (label, p, disabled, active) => {
      return `
        <li class="page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}">
          <a class="page-link" href="#" onclick="gotoPage(${p}); return false;">${label}</a>
        </li>
      `;
    };

    let html = '';
    html += mk('«', 1, page <= 1, false);
    html += mk('‹', page - 1, page <= 1, false);

    // windowed pages
    const start = Math.max(1, page - 2);
    const end = Math.min(totalPages, page + 2);
    for (let p = start; p <= end; p++) {
      html += mk(String(p), p, false, p === page);
    }

    html += mk('›', page + 1, page >= totalPages, false);
    html += mk('»', totalPages, page >= totalPages, false);
    els.pager.innerHTML = html;
  }

  function gotoPage(p) {
    const totalPages = state.totalPages || 1;
    const next = Math.min(Math.max(1, p), totalPages);
    if (next === state.page) return;
    state.page = next;
    loadDesignations();
  }

  function renderTable() {
    const items = state.items || [];
    if (!items.length) {
      els.tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">No designations found</td></tr>`;
      return;
    }
    els.tbody.innerHTML = items.map(d => `
      <tr>
        <td class="text-muted">${escapeHtml(state.businessesMap[String(d.businessId)] || ('Business #' + d.businessId))}</td>
        <td class="fw-semibold">${escapeHtml(d.name || '')}</td>
        <td class="text-muted">${escapeHtml(d.code || '-')}</td>
        <td class="text-muted">${escapeHtml((d.description || '').slice(0, 80))}${(d.description && d.description.length > 80) ? '…' : ''}</td>
        <td>${badgeStatus(d.status)}</td>
        <td class="text-muted">${fmtDate(d.createdAt)}</td>
        <td class="text-end">
          <button class="btn btn-icon edit me-1" onclick="openEditDesignation(${d.id})" title="Edit">
            <i class="fa-solid fa-pen-to-square"></i>
          </button>
          <button class="btn btn-icon delete" onclick="openDelete(${d.id}, '${escapeAttr(d.name || '')}')" title="Delete">
            <i class="fa-solid fa-trash-can"></i>
          </button>
        </td>
      </tr>
    `).join('');
  }

  function renderMeta() {
    const total = state.total || 0;
    const start = total === 0 ? 0 : ((state.page - 1) * state.pageSize + 1);
    const end = Math.min(state.page * state.pageSize, total);
    els.meta.textContent = `Showing ${start}-${end} of ${total}`;
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }
  function escapeAttr(str) {
    return String(str).replace(/'/g, "\\'");
  }

  async function loadBusinesses() {
    // Uses existing API in this app: /api/v1/business
    try {
      const businesses = await apiCall('/business', { method: 'GET' });
      const list = Array.isArray(businesses) ? businesses : (businesses?.items || []);
      state.businessesMap = {};
      list.forEach((b) => {
        state.businessesMap[String(b.id)] = String(b.businessName || b.name || ('Business #' + b.id));
      });
      const opts = list.map(b => `<option value="${b.id}">${escapeHtml(b.businessName || b.name || ('Business #' + b.id))}</option>`).join('');
      const allOpt = `<option value="">All Businesses</option>`;
      els.business.innerHTML = allOpt + opts;

      const formBusiness = document.getElementById('formBusinessId');
      formBusiness.innerHTML = `<option value="">Select business</option>` + opts;

      // Default selection: first business if available
      if (!state.businessId && list.length) {
        state.businessId = String(list[0].id);
        els.business.value = state.businessId;
      }
    } catch (e) {
      console.warn('Could not load businesses for filter', e);
    }
  }

  async function loadDesignations() {
    els.tbody.innerHTML = `
      <tr><td colspan="7" class="text-center py-4">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
      </td></tr>
    `;

    const params = new URLSearchParams();
    params.set('page', String(state.page));
    params.set('pageSize', String(state.pageSize));
    params.set('orderBy', state.orderBy);
    params.set('order', state.order);
    if (state.q) params.set('q', state.q);
    if (state.businessId) params.set('businessId', state.businessId);

    try {
      const data = await apiCall(`/designations?${params.toString()}`, { method: 'GET' });
      state.items = data.items || [];
      state.total = data.total || 0;
      state.totalPages = data.totalPages || 1;
      renderTable();
      renderMeta();
      renderPager();
    } catch (e) {
      console.error('loadDesignations failed', e);
      els.tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-danger">Failed to load designations</td></tr>`;
      els.meta.textContent = '—';
      els.pager.innerHTML = '';
    }
  }

  function resetFilters() {
    state.q = '';
    state.page = 1;
    state.pageSize = Number(els.pageSize.value) || 20;
    state.orderBy = 'createdAt';
    state.order = 'DESC';
    state.businessId = els.business.value || state.businessId || '';
    els.q.value = '';
    renderSortIndicators();
    loadDesignations();
  }

  // Create/Edit flows
  function openCreateDesignation() {
    document.getElementById('designationModalTitle').innerHTML = '<i class="fa-solid fa-id-badge me-2 text-primary"></i>Add Designation';
    document.getElementById('designationId').value = '';
    document.getElementById('formName').value = '';
    document.getElementById('formCode').value = '';
    document.getElementById('formDescription').value = '';
    document.getElementById('formStatus').value = 'ACTIVE';
    document.getElementById('formSortOrder').value = '';
    document.getElementById('modalAlert').innerHTML = '';

    const businessId = state.businessId || els.business.value || '';
    document.getElementById('formBusinessId').value = businessId;
  }

  async function openEditDesignation(id) {
    document.getElementById('modalAlert').innerHTML = '';
    document.getElementById('designationModalTitle').innerHTML = '<i class="fa-solid fa-pen-to-square me-2 text-primary"></i>Update Designation';
    const modal = new bootstrap.Modal(document.getElementById('designationModal'));
    modal.show();
    try {
      const row = await apiCall(`/designations/${id}`, { method: 'GET' });
      document.getElementById('designationId').value = row.id;
      document.getElementById('formBusinessId').value = String(row.businessId || '');
      document.getElementById('formName').value = row.name || '';
      document.getElementById('formCode').value = row.code || '';
      document.getElementById('formDescription').value = row.description || '';
      document.getElementById('formStatus').value = row.status || 'ACTIVE';
      document.getElementById('formSortOrder').value = row.sortOrder ?? '';
    } catch (e) {
      document.getElementById('modalAlert').innerHTML = `<div class="alert alert-danger">Failed to load designation</div>`;
    }
  }

  function showModalAlert(msg, type) {
    document.getElementById('modalAlert').innerHTML = `<div class="alert alert-${type}">${escapeHtml(msg)}</div>`;
  }

  async function submitDesignation() {
    const id = document.getElementById('designationId').value;
    const businessId = Number(document.getElementById('formBusinessId').value);
    const name = document.getElementById('formName').value.trim();
    const code = document.getElementById('formCode').value.trim();
    const description = document.getElementById('formDescription').value.trim();
    const status = document.getElementById('formStatus').value;
    const sortOrderRaw = document.getElementById('formSortOrder').value;
    const sortOrder = sortOrderRaw === '' ? null : Number(sortOrderRaw);

    if (!businessId) return showModalAlert('Business is required', 'danger');
    if (!name) return showModalAlert('Name is required', 'danger');

    const payload = {
      businessId,
      name,
      code: code || null,
      description: description || null,
      status,
      sortOrder: Number.isFinite(sortOrder) ? sortOrder : null
    };

    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.textContent = 'Saving...';
    try {
      if (!id) {
        await apiCall('/designations', { method: 'POST', body: JSON.stringify(payload) });
      } else {
        await apiCall(`/designations/${id}`, { method: 'PATCH', body: JSON.stringify(payload) });
      }
      bootstrap.Modal.getInstance(document.getElementById('designationModal')).hide();

      // Keep filter business in sync
      state.businessId = String(payload.businessId);
      els.business.value = state.businessId;
      state.page = 1;
      await loadDesignations();
    } catch (e) {
      const msg = e?.message || 'Failed to save';
      showModalAlert(msg, 'danger');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Save';
    }
  }

  // Delete
  function openDelete(id, name) {
    document.getElementById('deleteId').value = String(id);
    document.getElementById('deleteName').textContent = name || 'this designation';
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
  }

  async function confirmDelete() {
    const id = document.getElementById('deleteId').value;
    try {
      await apiCall(`/designations/${id}`, { method: 'DELETE' });
      bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
      await loadDesignations();
    } catch (e) {
      alert(e?.message || 'Failed to delete');
    }
  }

  // Wire controls
  let qTimer = null;
  els.q.addEventListener('input', () => {
    if (qTimer) clearTimeout(qTimer);
    qTimer = setTimeout(() => {
      state.q = els.q.value.trim();
      state.page = 1;
      loadDesignations();
    }, 350);
  });

  els.pageSize.addEventListener('change', () => {
    state.pageSize = Number(els.pageSize.value) || 20;
    state.page = 1;
    loadDesignations();
  });

  els.business.addEventListener('change', () => {
    state.businessId = els.business.value || '';
    state.page = 1;
    loadDesignations();
  });

  document.addEventListener('DOMContentLoaded', async () => {
    renderSortIndicators();
    await loadBusinesses();
    await loadDesignations();
  });
</script>


